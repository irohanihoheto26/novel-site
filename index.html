<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Yu Gothic", "YuGothic", sans-serif; background: #fff; color: #000; margin: 0; line-height: 1.8; }
        header { padding: 60px 20px; text-align: center; border-bottom: 1px solid #000; }
        header h1 { font-family: 'Antonio', sans-serif; font-size: 3.5em; margin: 0; text-transform: uppercase; letter-spacing: 0.05em; }
        header p { font-size: 0.9em; margin-top: 10px; text-transform: uppercase; letter-spacing: 0.2em; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px 20px 100px; }
        #auth-status { text-align: right; font-size: 0.8em; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* フォーム系 */
        section { border: 1px solid #000; padding: 30px; margin-bottom: 40px; background: #fff; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #000; box-sizing: border-box; font-family: inherit; font-size: 1em; }
        button { background-color: #000; color: #fff; border: 1px solid #000; padding: 12px 25px; cursor: pointer; font-family: inherit; font-size: 0.9em; transition: 0.2s; }
        button:hover { background-color: #fff; color: #000; }
        .text-btn { background: none; color: #000; border: none; text-decoration: underline; padding: 0; font-size: 0.85em; cursor: pointer; margin-left: 10px; }

        /* 管理用コンパクトリスト */
        .my-works { font-size: 0.85em; background: #f9f9f9; padding: 15px; border: 1px dashed #000; margin-bottom: 20px; }
        .work-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }

        /* 小説カード */
        .novel-card { padding: 40px 0; border-bottom: 1px solid #000; }
        .novel-card h3 { margin: 0; font-size: 1.8em; font-weight: 700; transition: 0.2s; }
        .novel-card h3:hover { opacity: 0.6; }
        .author-info { font-size: 0.85em; margin: 10px 0; color: #666; }
        .caption { font-size: 0.95em; margin: 15px 0; border-left: 3px solid #000; padding-left: 15px; color: #333; }
        
        /* 本文表示エリア */
        .novel-content { display: none; background: #fcfcfc; padding: 30px; margin: 20px 0; border: 1px solid #eee; white-space: pre-wrap; font-size: 1.05em; }
        .novel-content.active { display: block; }
        
        .heart { background: none; color: #e0245e; border: 1px solid #e0245e; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .heart:hover { background: #e0245e; color: #fff; }

        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <h1>Fragment Library</h1>
    <p>A collection of story fragments.</p>
</header>

<div class="container">
    <div id="auth-status">Connecting to library...</div>

    <section id="auth-form" class="hidden">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogIn()">Login</button>
        <button onclick="doSignUp()" style="background:none; color:#000">Register</button>
    </section>

    <section id="post-form" class="hidden">
        <div class="my-works">
            <strong>Your Archive</strong>
            <div id="my-list"></div>
        </div>
        <h2 id="form-title" style="font-size:1.2em; border-bottom:1px solid #000; margin-bottom:15px;">Add New Fragment</h2>
        <input type="hidden" id="edit-id">
        <input type="text" id="title" placeholder="Title">
        <input type="text" id="author" placeholder="Author name">
        <textarea id="caption" placeholder="Caption / Synopsis" rows="2"></textarea>
        <textarea id="content" placeholder="Story content" rows="10"></textarea>
        <button id="submit-btn" onclick="doPost()">Archive</button>
        <button onclick="cancelEdit()" class="text-btn">Cancel</button>
        <button onclick="doLogOut()" class="text-btn" style="float:right; color:#999;">Logout</button>
    </section>

    <div id="list">Loading fragments...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);

    let currentUser = null;

    async function init() {
        const { data: { user } } = await api.auth.getUser();
        currentUser = user;
        
        document.getElementById('auth-status').innerText = user ? `User: ${user.email}` : "Guest Mode";
        document.getElementById('auth-form').classList.toggle('hidden', !!user);
        document.getElementById('post-form').classList.toggle('hidden', !user);
        
        if (user) getMyList();
        getList();
    }

    async function doPost() {
        const id = document.getElementById('edit-id').value;
        const payload = {
            title: document.getElementById('title').value,
            author_name: document.getElementById('author').value,
            caption: document.getElementById('caption').value,
            content: document.getElementById('content').value,
            author_id: currentUser.id
        };

        let res;
        if (id) {
            res = await api.from('novels').update(payload).eq('id', id);
        } else {
            res = await api.from('novels').insert([payload]);
        }

        if (res.error) alert("Error: " + res.error.message); else location.reload();
    }

    async function getMyList() {
        const { data } = await api.from('novels').select('id, title').eq('author_id', currentUser.id);
        const myDiv = document.getElementById('my-list');
        if (data && data.length > 0) {
            myDiv.innerHTML = data.map(n => `
                <div class="work-item">
                    <span>${n.title}</span>
                    <div>
                        <button class="text-btn" onclick="editNovel('${n.id}')">Edit</button>
                        <button class="text-btn" onclick="deleteNovel('${n.id}')" style="color:red">Delete</button>
                    </div>
                </div>
            `).join('');
        } else { myDiv.innerText = "No fragments archived yet."; }
    }

    async function getList() {
        const { data: novels } = await api.from('novels').select('*').order('created_at', { ascending: false });
        const { data: allLikes } = await api.from('likes').select('novel_id');
        
        const listDiv = document.getElementById('list');
        if (!novels || novels.length === 0) {
            listDiv.innerHTML = "<p style='text-align:center'>The library is empty.</p>";
            return;
        }

        listDiv.innerHTML = novels.map(n => {
            const likeCount = allLikes ? allLikes.filter(l => l.novel_id === n.id).length : 0;
            return `
                <div class="novel-card">
                    <h3 onclick="toggleContent('${n.id}')" title="Click to read">${n.title}</h3>
                    <div class="author-info">
                        by ${n.author_name}
                        <button class="text-btn" onclick="addFav('${n.author_id}')">Follow Author</button>
                    </div>
                    <div class="caption">${n.caption || 'No caption available.'}</div>
                    <div id="content-${n.id}" class="novel-content">${n.content}</div>
                    <button class="heart" onclick="addLike('${n.id}')">♥ ${likeCount}</button>
                </div>
            `;
        }).join('');
    }

    function toggleContent(id) {
        document.getElementById('content-' + id).classList.toggle('active');
    }

    async function editNovel(id) {
        const { data } = await api.from('novels').select('*').eq('id', id).single();
        document.getElementById('edit-id').value = data.id;
        document.getElementById('title').value = data.title;
        document.getElementById('author').value = data.author_name;
        document.getElementById('caption').value = data.caption;
        document.getElementById('content').value = data.content;
        document.getElementById('form-title').innerText = "Edit Archive";
        document.getElementById('submit-btn').innerText = "Update Fragment";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteNovel(id) { if(confirm('Are you sure you want to delete this fragment?')) { await api.from('novels').delete().eq('id', id); location.reload(); } }
    
    function cancelEdit() { 
        if(document.getElementById('edit-id').value) location.reload();
        else document.getElementById('post-form').reset();
    }

    async function addLike(novelId) {
        if (!currentUser) return alert("Please login to like.");
        const { error } = await api.from('likes').insert([{ novel_id: novelId, user_id: currentUser.id }]);
        if (error) alert("You have already liked this fragment."); else getList();
    }

    async function addFav(authorId) {
        if (!currentUser) return alert("Please login to follow.");
        if (currentUser.id === authorId) return alert("You cannot follow yourself.");
        const { error } = await api.from('favorites').insert([{ author_id: authorId, user_id: currentUser.id }]);
        if (error) alert("Already following this author."); else alert("Author followed.");
    }

    async function doSignUp() { const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) alert(error.message); else alert("Registration successful! You can now login."); }
    async function doLogIn() { const { error } = await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) alert(error.message); else location.reload(); }
    async function doLogOut() { await api.auth.signOut(); location.reload(); }

    init();
</script>
</body>
</html>
