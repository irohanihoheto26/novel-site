<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Your Novel Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- あなたのオリジナルデザインを完全維持 --- */
        :root { --main-color: #fcaf17; --bg-color: #f9f9f9; --text-color: #333; }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.6; }
        .hidden { display: none !important; }
        nav { background: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .nav-btns { display: flex; gap: 10px; }
        button { cursor: pointer; border: 1px solid #ccc; background: #fff; padding: 6px 12px; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #eee; }
        .btn-primary { background: var(--main-color); color: #fff; border: none; font-weight: bold; }
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .novel-row { background: #fff; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .novel-title { font-weight: bold; color: var(--main-color); cursor: pointer; font-size: 1.1em; }
        .tag-link { color: #888; font-size: 0.85em; margin-right: 8px; cursor: pointer; }
        .tag-link:hover { text-decoration: underline; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; overflow-y: auto; }
        .overlay-content { max-width: 700px; margin: 40px auto; padding: 20px; }
        .close-btn-style { position: sticky; top: 10px; right: 10px; float: right; z-index: 3000; padding: 10px; background: #eee; border-radius: 50%; width: 40px; height: 40px; border: none; font-weight: bold; }
        .r18-badge { background: #ff4d4d; color: #fff; font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }
        .novel-stats { font-size: 0.85em; color: #777; margin-top: 5px; }
        .stat-item { margin-right: 15px; }
        textarea, input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        #content-input { min-height: 300px; font-family: serif; font-size: 1.1em; }
    </style>
    <style id="user-custom-style"></style>
</head>
<body>

<nav>
    <div onclick="location.reload()" style="cursor:pointer; font-weight:bold; font-size:1.2em;">Your Novel Archive</div>
    <div class="nav-btns" id="guest-nav">
        <button onclick="toggleAuthForm()">ログイン/登録</button>
    </div>
    <div class="nav-btns hidden" id="logged-in-nav">
        <button class="btn-primary" onclick="openEditor()">新規投稿</button>
        <button onclick="toggleSettings()">⚙ 設定</button>
        <button onclick="doLogOut()">ログアウト</button>
    </div>
</nav>

<div id="notification-banner" class="hidden" style="background:#fff3cd; padding:15px; border-bottom:1px solid #ffeeba; text-align:center;">
    <div id="notification-list"></div>
    <button onclick="clearNotifications()" style="margin-top:10px; font-size:0.8em;">既読にする</button>
</div>

<div class="container">
    <div id="auth-form" class="hidden" style="background:#fff; padding:20px; border:1px solid #ddd; margin-bottom:20px;">
        <input type="text" id="email" placeholder="メールアドレス">
        <input type="password" id="password" placeholder="パスワード">
        <button class="btn-primary" onclick="doLogIn()">ログイン</button>
        <button onclick="doSignUp()">新規登録</button>
    </div>

    <div id="user-page" class="hidden">
        <h2>ようこそ、<span id="display-current-name"></span> さん</h2>
        <div id="profile-edit-area" style="display:none; background:#eee; padding:20px; border-radius:8px; margin-bottom:20px;">
            <h3>プロフィール設定</h3>
            作者名: <input type="text" id="prof-name">
            自己紹介: <textarea id="prof-bio"></textarea>
            作者ページ用HTML/CSS: <textarea id="prof-css" style="height:100px;"></textarea>
            文章画面用カスタムコード: <textarea id="reader-custom-input" style="height:100px;"></textarea>
            <button class="btn-primary" onclick="saveProfile()">保存</button>
            <button onclick="deleteAccount()" style="color:red; float:right;">退会する</button>
        </div>
        <div class="stats-summary" style="margin-bottom:20px; padding:10px; border:1px solid #ddd;">
            合計文字数: <strong id="total-char-count">0</strong> / いいね: <strong id="total-likes">0</strong>
        </div>
        <div id="my-works-list"></div>
        <hr>
    </div>

    <div id="library-section-header">
        <input type="text" id="search-input" placeholder="検索..." oninput="getList()">
        <div style="margin:10px 0;">
            <button id="tab-all" class="tab-btn active" onclick="switchTab('all')">全作品</button>
            <button id="tab-follow" class="tab-btn" onclick="switchTab('follow')">フォロー</button>
            <button id="tab-bookmark" class="tab-btn" onclick="switchTab('bookmark')">ブックマーク</button>
            <label style="font-size:0.8em; margin-left:10px;"><input type="checkbox" id="exclude-r18" onchange="getList()"> R18除外</label>
        </div>
    </div>

    <div id="list"></div>
    
    <div style="text-align:center; margin-top:40px; font-size:0.9em; color:#888;">
        <span onclick="openRules()" style="cursor:pointer; text-decoration:underline;">ルール（必読）</span> | 
        <span onclick="openAboutPage()" style="cursor:pointer; text-decoration:underline;">このサイトについて</span>
    </div>
</div>

<div id="reader-overlay" class="overlay">
    <button class="close-btn-style" onclick="closeReader()">✕</button>
    <div class="overlay-content">
        <h1 id="read-title" style="text-align:center;"></h1>
        <div id="read-author" style="text-align:center; color:#888; margin-bottom:20px;"></div>
        <div id="name-changer-group" class="hidden">
            <input type="text" id="user-custom-name" placeholder="名前変換">
            <button onclick="applyNameChange()">変換</button>
        </div>
        <div id="read-body" style="white-space: pre-wrap;"></div>
        <div id="reader-interactive-zone" class="hidden">
            <div id="author-link-zone" style="text-align:center; margin:20px 0;"></div>
            <div style="display:flex; justify-content:center; gap:15px;">
                <button id="like-btn" onclick="toggleLike()">いいね <span id="read-like-count">0</span></button>
                <button id="bookmark-btn" onclick="toggleBookmark()">★ ブクマ</button>
            </div>
            <div id="comment-section" style="margin-top:30px; border-top:1px solid #eee;">
                <h3>コメント</h3>
                <div id="comment-list"></div>
                <div id="comment-form-area" class="hidden">
                    <textarea id="comment-input" placeholder="感想を書く..."></textarea>
                    <button class="btn-primary" onclick="postComment()">送信</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editor-overlay" class="overlay">
    <button class="close-btn-style" onclick="closeEditor()">✕</button>
    <div class="overlay-content">
        <h2>作品を投稿</h2>
        <input type="text" id="title-input" placeholder="タイトル">
        <input type="text" id="tags-input" placeholder="タグ（カンマ区切り）">
        <textarea id="caption-input" placeholder="作品説明"></textarea>
        <textarea id="content-input" placeholder="本文"></textarea>
        <label><input type="checkbox" id="name-convert-check"> 名前変換</label>
        <input type="text" id="default-name-input" placeholder="変換元デフォルト名" class="hidden">
        <label><input type="checkbox" id="r18-check"> R18</label>
        <label><input type="checkbox" id="private-check"> 下書き</label>
        <button class="btn-primary" onclick="doPost()">投稿・保存</button>
    </div>
</div>

<div id="author-page-overlay" class="overlay">
    <button class="close-btn-style" onclick="closeAuthorPage()">✕</button>
    <div class="overlay-content" id="author-page-content">
        <h1 id="author-page-name"></h1>
        <div id="author-page-bio"></div>
        <div id="author-page-works"></div>
    </div>
</div>

<script>
    // --- 全てのJSロジックを統合 ---
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);

    let currentUser = null, userProfile = null, currentTab = 'all';
    let currentReadingId = null, currentOpenedNovel = null, currentReplyId = null, originalContent = "";

    async function init() {
        const { data: { session } } = await api.auth.getSession();
        currentUser = session?.user || null;
        if (currentUser) {
            document.getElementById('logged-in-nav').classList.remove('hidden');
            document.getElementById('guest-nav').classList.add('hidden');
            document.getElementById('user-page').classList.remove('hidden');
            await loadProfile();
            await loadUserContent();
            await checkNotifications();
        }
        await getList();
    }

    async function loadProfile() {
        const { data } = await api.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
        userProfile = data;
        if (data) {
            document.getElementById('prof-name').value = data.display_name || "";
            document.getElementById('prof-bio').value = data.bio || "";
            document.getElementById('prof-css').value = data.custom_css || "";
            document.getElementById('reader-custom-input').value = data.reader_custom_code || "";
            document.getElementById('display-current-name').innerText = data.display_name || "名無し";
        }
    }

    async function loadUserContent() {
        const { data: novels } = await api.from('novels').select('*').eq('author_id', currentUser.id).order('created_at', { ascending: false });
        let charSum = 0; novels?.forEach(n => charSum += (n.content?.length || 0));
        document.getElementById('total-char-count').innerText = charSum.toLocaleString();
        const { count } = await api.from('likes').select('*', { count: 'exact', head: true }).in('novel_id', (novels || []).map(n => n.id));
        document.getElementById('total-likes').innerText = count || 0;
        
        document.getElementById('my-works-list').innerHTML = (novels || []).map(n => `
            <div class="novel-row">
                <div>
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    <button onclick="startEdit('${n.id}')" style="font-size:0.7em; margin-left:10px;">編集</button>
                    <button onclick="deleteNovel('${n.id}')" style="font-size:0.7em; color:red;">削除</button>
                </div>
            </div>
        `).join('') || "まだ投稿がありません。";
    }

    async function getList() {
        let { data: novels } = await api.from('novels').select('*').eq('is_private', false).order('created_at', { ascending: false });
        let filtered = novels || [];
        if (document.getElementById('exclude-r18').checked) filtered = filtered.filter(n => !n.is_r18);
        const search = document.getElementById('search-input').value.toLowerCase();
        if (search) filtered = filtered.filter(n => n.title.toLowerCase().includes(search) || n.author_name.toLowerCase().includes(search));

        if (currentTab === 'follow' && currentUser) {
            const { data: f } = await api.from('follows').select('following_id').eq('follower_id', currentUser.id);
            const fIds = (f || []).map(x => x.following_id);
            filtered = filtered.filter(n => fIds.includes(n.author_id));
        } else if (currentTab === 'bookmark' && currentUser) {
            const { data: b } = await api.from('bookmarks').select('novel_id').eq('user_id', currentUser.id);
            const bIds = (b || []).map(x => x.novel_id);
            filtered = filtered.filter(n => bIds.includes(n.id));
        }

        const promises = filtered.map(async n => {
            const { count: l } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            n.like_count = l || 0;
        });
        await Promise.all(promises);

        document.getElementById('list').innerHTML = filtered.map(n => `
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    ${n.is_r18 ? '<span class="r18-badge">R18</span>' : ''}
                    <div style="font-size:0.8em; color:#888;" onclick="openAuthorPage('${n.author_id}')">作者: ${n.author_name}</div>
                </div>
                <div class="novel-stats">♥ ${n.like_count}</div>
            </div>
        `).join('') || "作品がありません。";
    }

    // --- インタラクション (いいね、ブクマ、コメント) ---
    async function toggleLike() {
        if (!currentUser) return alert("ログインが必要です");
        const { data: existing } = await api.from('likes').select('*').eq('novel_id', currentReadingId).eq('user_id', currentUser.id).maybeSingle();
        if (existing) await api.from('likes').delete().eq('id', existing.id);
        else {
            await api.from('likes').insert({ novel_id: currentReadingId, user_id: currentUser.id });
            if (currentOpenedNovel.author_id !== currentUser.id) {
                await api.from('notifications').insert({ target_user_id: currentOpenedNovel.author_id, from_user_name: userProfile?.display_name || "名無し", type: 'like', novel_title: currentOpenedNovel.title });
            }
        }
        loadLikeCount(currentReadingId);
    }

    async function loadLikeCount(id) {
        const { count } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', id);
        document.getElementById('read-like-count').innerText = count || 0;
    }

    async function toggleBookmark() {
        if (!currentUser) return alert("ログインが必要です");
        const { data } = await api.from('bookmarks').select('id').eq('user_id', currentUser.id).eq('novel_id', currentReadingId).maybeSingle();
        if (data) await api.from('bookmarks').delete().eq('id', data.id);
        else await api.from('bookmarks').insert({ user_id: currentUser.id, novel_id: currentReadingId });
        checkBookmarkStatus(currentReadingId);
    }

    async function checkBookmarkStatus(id) {
        if (!currentUser) return;
        const { data } = await api.from('bookmarks').select('id').eq('user_id', currentUser.id).eq('novel_id', id).maybeSingle();
        document.getElementById('bookmark-btn').style.color = data ? "#fcaf17" : "#333";
    }

    async function postComment() {
        const body = document.getElementById('comment-input').value.trim();
        if (!body || !currentUser) return;
        const displayName = userProfile?.display_name || "名無し";
        const { error } = await api.from('comments').insert({ 
            novel_id: currentReadingId, user_id: currentUser.id, user_name: displayName, body: body, parent_id: currentReplyId 
        });
        if (!error) {
            await api.from('notifications').insert({ target_user_id: currentOpenedNovel.author_id, from_user_name: displayName, type: 'comment', novel_title: currentOpenedNovel.title });
            document.getElementById('comment-input').value = "";
            currentReplyId = null; loadComments(currentReadingId);
        }
    }

    async function loadComments(id) {
        const { data } = await api.from('comments').select('*').eq('novel_id', id).order('created_at', { ascending: true });
        document.getElementById('comment-list').innerHTML = (data || []).map(c => `
            <div style="margin-bottom:10px; font-size:0.9em;">
                <strong>${c.user_name}</strong>: ${c.body}
                <span onclick="prepareReply('${c.id}', '${c.user_name}')" style="font-size:0.8em; text-decoration:underline; cursor:pointer; margin-left:10px;">返信</span>
            </div>
        `).join('') || "コメントはまだありません。";
    }

    function prepareReply(id, name) { currentReplyId = id; document.getElementById('comment-input').placeholder = `${name}さんへ返信...`; }

    // --- プロフィール・作者ページ ---
    async function saveProfile() {
        const updates = { 
            id: currentUser.id, 
            display_name: document.getElementById('prof-name').value, 
            bio: document.getElementById('prof-bio').value,
            custom_css: document.getElementById('prof-css').value,
            reader_custom_code: document.getElementById('reader-custom-input').value
        };
        await api.from('profiles').upsert(updates);
        alert("保存しました"); location.reload();
    }

    async function openAuthorPage(aId) {
        const { data: prof } = await api.from('profiles').select('*').eq('id', aId).maybeSingle();
        if (!prof) return;
        const styleTag = document.getElementById('user-custom-style');
        const bioArea = document.getElementById('author-page-bio');
        const raw = prof.custom_css || "";
        const cssMatch = raw.match(/<style>([\s\S]*?)<\/style>/);
        styleTag.innerHTML = cssMatch ? cssMatch[1] : "";
        bioArea.innerHTML = raw.replace(/<style>[\s\S]*?<\/style>/, "") || prof.bio || "";
        document.getElementById('author-page-name').innerText = prof.display_name;
        
        const { data: novels } = await api.from('novels').select('*').eq('author_id', aId).eq('is_private', false);
        document.getElementById('author-page-works').innerHTML = (novels || []).map(n => `
            <div class="novel-row"><span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span></div>
        `).join('');
        document.getElementById('author-page-overlay').style.display = 'block';
    }

    // --- 通知・退会・その他 ---
    async function checkNotifications() {
        const { data } = await api.from('notifications').select('*').eq('target_user_id', currentUser.id).eq('is_read', false);
        if (data && data.length > 0) {
            document.getElementById('notification-list').innerHTML = data.map(n => `<div>${n.from_user_name}さんが「${n.novel_title}」に${n.type}しました</div>`).join('');
            document.getElementById('notification-banner').classList.remove('hidden');
        }
    }

    async function clearNotifications() {
        await api.from('notifications').update({ is_read: true }).eq('target_user_id', currentUser.id);
        document.getElementById('notification-banner').classList.add('hidden');
    }

    async function deleteAccount() {
        if (!confirm("全ての作品とデータが削除されます。本当によろしいですか？")) return;
        await api.from('novels').delete().eq('author_id', currentUser.id);
        await api.from('profiles').delete().eq('id', currentUser.id);
        await api.auth.signOut();
        location.reload();
    }

    // --- 固定文言 (復元) ---
    function openRules() {
        resetReaderUI(); 
        document.getElementById('read-title').innerText = "ルール（必読）";
        document.getElementById('read-body').innerHTML = `
        <div style="margin-top:-80px;">
            <p>当サイトは個人による二次創作小説の展示・アーカイブを目的とした専用サイトです。</p>
            <ul>
                <li>検索避けのため、原作名をそのまま表示することは避けてください。</li>
                <li>公序良俗に反する内容の投稿、無断転載、AI学習利用は固く禁止いたします。</li>
                <li>R指定が必要な場合は必ず設定を行ってください。</li>
            </ul>
        </div>`;
        document.getElementById('reader-overlay').style.display = 'block';
    }

    function openAboutPage() {
        resetReaderUI();
        document.getElementById('read-title').innerText = "このサイトについて";
        document.getElementById('read-body').innerHTML = `
        <div style="margin-top:-110px;">
            <h3>サイトの特色</h3>
            <p>当サイトは、かつて隆盛を誇った「個人サイト」のような自由な空気感を大切にしています。</p>
        </div>`;
        document.getElementById('reader-overlay').style.display = 'block';
    }

    // --- 基本操作 ---
    async function openReader(id) {
        currentReadingId = id; resetReaderUI();
        const { data: n } = await api.from('novels').select('*').eq('id', id).single();
        currentOpenedNovel = n; originalContent = n.content;
        document.getElementById('read-title').innerText = n.title;
        document.getElementById('read-body').innerText = n.content;
        if (n.default_name) document.getElementById('name-changer-group').classList.remove('hidden');
        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-interactive-zone').classList.remove('hidden');
        loadComments(id); loadLikeCount(id); checkBookmarkStatus(id);
        if (currentUser) {
            document.getElementById('comment-form-area').classList.remove('hidden');
            const { data: prof } = await api.from('profiles').select('reader_custom_code').eq('id', n.author_id).maybeSingle();
            if (prof?.reader_custom_code) {
                const s = document.createElement('style'); s.id = "dynamic-reader-style";
                s.innerHTML = prof.reader_custom_code.replace(/<style>|<\/style>/g, "");
                document.head.appendChild(s);
            }
        }
    }

    function applyNameChange() {
        const input = document.getElementById('user-custom-name').value;
        if (!input) return;
        const regex = new RegExp(currentOpenedNovel.default_name, 'g');
        document.getElementById('read-body').innerText = originalContent.replace(regex, input);
    }

    function resetReaderUI() {
        const s = document.getElementById('dynamic-reader-style'); if (s) s.remove();
        document.getElementById('reader-interactive-zone').classList.add('hidden');
        document.getElementById('name-changer-group').classList.add('hidden');
    }

    async function doPost() {
        const payload = {
            title: document.getElementById('title-input').value,
            content: document.getElementById('content-input').value,
            caption: document.getElementById('caption-input').value,
            tags: document.getElementById('tags-input').value.split(','),
            is_r18: document.getElementById('r18-check').checked,
            is_private: document.getElementById('private-check').checked,
            default_name: document.getElementById('name-convert-check').checked ? document.getElementById('default-name-input').value : "",
            author_id: currentUser.id,
            author_name: userProfile.display_name
        };
        await api.from('novels').insert(payload);
        location.reload();
    }

    function switchTab(t) { currentTab = t; getList(); }
    function toggleSettings() { const s = document.getElementById('profile-edit-area'); s.style.display = s.style.display==='block'?'none':'block'; }
    function toggleAuthForm() { document.getElementById('auth-form').classList.toggle('hidden'); }
    function closeReader() { document.getElementById('reader-overlay').style.display = 'none'; resetReaderUI(); }
    function openEditor() { document.getElementById('editor-overlay').style.display = 'block'; }
    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    function closeAuthorPage() { document.getElementById('author-page-overlay').style.display = 'none'; document.getElementById('user-custom-style').innerHTML = ""; }
    async function doLogIn() { await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); location.reload(); }
    async function doLogOut() { await api.auth.signOut(); location.reload(); }
    async function doSignUp() { await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); alert("確認メールを送りました"); }

    document.getElementById('name-convert-check').onchange = (e) => document.getElementById('default-name-input').classList.toggle('hidden', !e.target.checked);
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
