<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
<link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&family=Dela+Gothic+One&family=Noto+Sans+JP:wght@300&display=swap" rel="stylesheet">    <style>
   :root { --sidebar-width: 280px; }
        body { font-family: "Yu Gothic", "YuGothic", sans-serif; background: #fff; color: #000; margin: 0; display: flex; min-height: 100vh; }
        aside { width: var(--sidebar-width); height: 100vh; border-right: 2px solid #000; padding: 40px 20px; box-sizing: border-box; position: fixed; left: 0; top: 0; overflow-y: auto; background: #fff; display: flex; flex-direction: column; z-index: 100; }
        main { margin-left: var(--sidebar-width); flex: 1; padding: 40px; max-width: 900px; box-sizing: border-box; }
        aside h1 { font-family: 'Antonio', sans-serif; font-size: 2.2em; margin: 0 0 10px; text-transform: uppercase; cursor: pointer; }
        .rule-link { font-size: 0.85em; color: #666; text-decoration: underline; cursor: pointer; margin-bottom: 30px; display: block; }
        .search-box-side {
    padding: 10px 10px 10px 30px; /* å·¦å´ã«ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®éš™é–“ã‚’ç©ºã‘ã‚‹ */
    border: 1px solid #000;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 20px;
    background: url('https://api.iconify.design/mdi/magnify.svg') no-repeat 8px center; /* è™«çœ¼é¡ã‚¢ã‚¤ã‚³ãƒ³ */
    background-size: 18px;
}
        .section-header { display: flex; align-items: baseline; gap: 15px; border-bottom: 2px solid #000; margin-bottom: 20px; }
        .settings-link { font-size: 0.7em; color: #666; text-decoration: underline; cursor: pointer; }
        .profile-edit-area { background: #f9f9f9; padding: 20px; border: 1px solid #eee; margin-bottom: 30px; display: none; }
        .tab-bar { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 25px; }
        .tab-btn { background: none; border: none; color: #888; padding: 10px 0; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: #000; border-bottom: 2px solid #000; }
        .novel-row { 
    padding: 15px 0; 
    border-bottom: 1px solid #eee; 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; /* centerã‹ã‚‰å¤‰æ›´ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãŒé•·ãã¦ã‚‚å´©ã‚Œãªã„ï¼‰ */
    gap: 15px;
}
        .novel-title { font-weight: bold; cursor: pointer; text-decoration: underline; }
        .count-badge { font-size: 0.75em; background: #eee; padding: 2px 6px; border-radius: 4px; color: #444; margin-right: 5px; }
        #editor-overlay, #reader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; overflow-y: auto; }
        .overlay-content { max-width: 700px; margin: 40px auto; padding: 20px; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; }
        button { background: #000; color: #fff; border: none; padding: 12px; cursor: pointer; width: 100%; margin-bottom: 5px; }
        .btn-outline { background: #fff; color: #000; border: 1px solid #000; }
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.9em; }
        .hidden { display: none !important; }
        .novel-stats { font-size: 0.85em; color: #888; margin-left: 10px; display: inline-flex; gap: 8px; }
        .stat-item { display: inline-flex; align-items: center; gap: 3px; }
        .sticky-close { position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 10px 0; z-index: 2100; border-bottom: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 8px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #000; }
        #r18-check:checked + .slider { background-color: #d00; }
        input:checked + .slider:before { transform: translateX(20px); }
        .checkbox-group { display: flex; gap: 25px; margin-bottom: 20px; align-items: center; }
        .checkbox-group label { display: flex; align-items: center; font-size: 0.9em; font-weight: bold; cursor: pointer; }
        /* ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®è¨­å®šï¼ˆç”»é¢å¹…ãŒ800pxä»¥ä¸‹ã®å ´åˆï¼‰ */
@media screen and (max-width: 800px) {
    body {
        flex-direction: column;
    }

    aside {
        width: 100%;
        height: auto; /* é«˜ã•ã‚’å†…å®¹ã«åˆã‚ã›ã‚‹ */
        position: static; /* å›ºå®šã‚’å®Œå…¨ã«è§£é™¤ */
        border-right: none;
        border-bottom: 2px solid #000;
        padding: 15px;
        z-index: 10;
    }

    main {
        margin-left: 0;
        padding: 15px;
        width: 100%;
        box-sizing: border-box; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    }

    /* ãƒœã‚¿ãƒ³ãŒç¸¦ã«ä¸¦ã³ã™ãã‚‹ã¨å ´æ‰€ã‚’å–ã‚‹ã®ã§ã€æ¨ªä¸¦ã³ã«èª¿æ•´ */
    #logged-in-nav {
        display: flex;
        gap: 10px;
    }
    
    #logged-in-nav button {
        flex: 1;
        padding: 8px;
        font-size: 0.9em;
    }
}
        /* ä¸‹æ›¸ããƒ©ãƒ™ãƒ«ã®æ–°ã—ã„ãƒ‡ã‚¶ã‚¤ãƒ³ */
.draft-badge {
    background-color: #e0f2ff; /* æ°´è‰² */
    color: #004080;           /* æ¿ƒã„é’æ–‡å­—ï¼ˆèª­ã¿ã‚„ã™ã•é‡è¦–ï¼‰ */
    font-size: 0.75em;
    font-weight: bold;
    padding: 3px 10px;
    border-radius: 15px;      /* è§’ä¸¸ */
    margin-left: 8px;
    display: inline-block;
    vertical-align: middle;
}

/* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-delete {
    cursor: pointer;
    color: #cc0000;
    font-size: 0.8em;
    margin-left: 10px;
    text-decoration: underline;
}
.btn-delete:hover {
    color: #ff0000;
}
        /* æœ¬æ–‡ã®1è¡Œç›®ã‚’1æ–‡å­—åˆ†ç©ºã‘ã‚‹è¨­å®š */
.indent-text {
    text-indent: 1em;
}
        /* ç®‡æ¡æ›¸ãç”¨ï¼š2è¡Œç›®ä»¥é™ã‚‚1å­—ä¸‹ã’ãŸä½ç½®ã«æƒãˆã‚‹ */
.hanging-indent {
    padding-left: 1em;   /* å…¨ä½“ã‚’1æ–‡å­—åˆ†å³ã«å¯„ã›ã‚‹ */
    text-indent: -1em;  /* 1è¡Œç›®ã ã‘ã‚’1æ–‡å­—åˆ†å·¦ã«æˆ»ã™ */
    margin-bottom: 1em; /* æ®µè½ã”ã¨ã®éš™é–“ */
}
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filter-bar select { padding: 5px; border: 1px solid #000; font-family: inherit; }

    .tag-link {
    display: inline-block;
    background: #f0f0f0; /* è–„ã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ */
    color: #666;         /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼æ–‡å­— */
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75em;
    cursor: pointer;
    margin-right: 5px;
    transition: all 0.2s ease;
    text-decoration: none;
}

.tag-link:hover {
    background: #e0e0e0; /* ãƒ›ãƒãƒ¼æ™‚ã¯å°‘ã—ã ã‘æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã« */
    color: #333;         /* æ–‡å­—ã‚‚å°‘ã—ãƒãƒƒã‚­ãƒªã•ã›ã‚‹ */
}
    #word-count-display { font-size: 0.8em; color: #666; text-align: right; margin-bottom: 10px; }
/* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¦‹å‡ºã—ã ã‘ã€ä¸Šã«å¤§ããªä½™ç™½ã¨å¤ªã‚ã®ç·šã‚’å…¥ã‚Œã‚‹ */
#library-section-header {
    margin-top: 80px; /* ã“ã“ã§ã‚¬ãƒƒãƒ„ãƒªä¸‹ã’ã¾ã™ */
    padding-top: 40px;
    border-top: 3px double #000; /* äºŒé‡ç·šã«ã—ã¦ã€Œã“ã“ã‹ã‚‰åˆ¥ç‰©ã€æ„Ÿã‚’å‡ºã™ */
    display: flex;
    align-items: baseline;
    gap: 15px;
    margin-bottom: 20px;
}
    /* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¨ä½“ã®èƒŒæ™¯ã‚’ã‚ãšã‹ã«ã‚°ãƒ¬ãƒ¼ã«ã—ã¦ã€ãƒã‚¤ãƒšãƒ¼ã‚¸ã¨åˆ‡ã‚Šé›¢ã™ */
#list {
    background: #fafafa;
    padding: 10px;
    border-radius: 8px;
}
        /* ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã ã‘å¹…ã‚’åˆ¶é™ã—ã¦ä¸­å¤®ã«å¯„ã›ã‚‹ */
#my-works-list {
    max-width: 600px; /* ãŠå¥½ã¿ã®å¹…ã«èª¿æ•´ã—ã¦ãã ã•ã„ */
    margin: 0 auto 0 0; /* å·¦å¯„ã›ã®ã¾ã¾å¹…ã ã‘ç‹­ã‚ã‚‹å ´åˆã¯ã“ã¡ã‚‰ */
    border: 1px solid #eee;
    padding: 0 15px;
    background: #fff;
}

/* 1. åŸºæœ¬ã¯æ¸¸ã‚´ã‚·ãƒƒã‚¯ã«ã™ã‚‹ï¼ˆç®¡ç†ç”»é¢ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç”¨ï¼‰ */
body, h2, h3, .novel-title, #display-current-name {
    font-family: "Yu Gothic Medium", "Yu Gothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sans-serif;
}

/* 2. ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã ã‘ã¯ Dela Gothic One ã‚’å¼·åˆ¶ã™ã‚‹ */
aside h1 {
    font-family: 'Dela Gothic One', sans-serif !important;
}
/* ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã ã‘ã¯å…ƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ®‹ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’å€‹åˆ¥ã«è¨­å®š */
aside h1 {
    /* ã‚‚ã—ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æ¸¸ã‚´ã‚·ãƒƒã‚¯ã«ã™ã‚‹ãªã‚‰ã“ã“ã‚‚å¤‰æ›´ */
}
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚„æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã« */
aside button, #auth-form button:first-of-type {
    background: #fcaf17;
    border: 1px solid #fcaf17;
}

/* ãƒªãƒ³ã‚¯ãªã©ã®ãƒ›ãƒãƒ¼è‰² */
.tab-btn.active {
    color: #fcaf17;
    border-color: #fcaf17;
}
    /* å°èª¬ã‚’èª­ã‚€ç”»é¢ï¼ˆReaderï¼‰ã‚’ä¸€ç•ªä¸Šã« */
#reader-overlay {
    z-index: 7000 !important; /* ä½œè€…ãƒšãƒ¼ã‚¸(3000)ã‚ˆã‚Šå¤§ããã™ã‚‹ */
}

/* ä½œè€…ãƒšãƒ¼ã‚¸ */
#author-page-overlay {
    z-index: 6000 !important; /* èª­æ›¸ç”»é¢(5000)ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã«ã™ã‚‹ */
}
.r18-badge {
    background-color: #ff6347;
    color: #ffffff;
    font-size: 0.7em;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 8px; /* å·¦å´ã«éš™é–“ã‚’ç©ºã‘ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¨é›¢ã™ */
    display: inline-block;
    vertical-align: middle;
    white-space: nowrap;
}
    /* æ–°è¦è¿½åŠ ï¼šã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ã‚’åºƒã’ã‚‹è¨­å®š */
.novel-info {
    flex: 1;
    min-width: 0;
}

/* æ–°è¦è¿½åŠ ï¼šã‚¿ã‚°ãŒæ¨ªã«ä¸¦ã³ã™ããŸæ™‚ã«æŠ˜ã‚Šè¿”ã™è¨­å®š */
.author-page-tags {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 5px;
    vertical-align: middle;
}
    
    </style>

    <style id="user-custom-style"></style>
    <style id="reader-custom-style"></style>

</head>
<body>

<aside>
    <h1 onclick="location.reload()">Fragment</h1>
<p style="
    font-family: 'Dela Gothic One', sans-serif; 
    font-size: 1.8em; /* ã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å°ã•ã */
    letter-spacing: 0.2em; /* é–“éš”ã‚’åºƒã’ã¦æ½°ã‚Œã‚’é˜²æ­¢ */
    color: #fcaf17; 
    margin-top:-25px; 
    margin-bottom: 30px;
    white-space: nowrap; /* æ”¹è¡Œé˜²æ­¢ */
    display: inline-block; /* transformã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ã«å¿…è¦ */
    transform: scaleX(0.6); /* æ¨ªå¹…ã‚’70%ã«ç¸®ã‚ã‚‹ï¼ˆ1.0ãŒé€šå¸¸ï¼‰ */
    transform-origin: left center; /* å·¦ç«¯ã‚’åŸºæº–ã«ç¸®ã‚ã‚‹ */
    white-space: nowrap;
">WEBå°èª¬æŠ•ç¨¿ã‚µã‚¤ãƒˆ</p>
    
    <span class="rule-link" onclick="openRules()">ãƒ«ãƒ¼ãƒ«ï¼ˆå¿…èª­ï¼‰</span>
<span class="rule-link" onclick="openAboutPage()" style="display: block; margin-top: -5px;">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</span>    
    
    <input type="text" style="display:none" aria-hidden="true">
    <input type="search" 
       id="search-input" 
       class="search-box-side" 
       placeholder="æ¤œç´¢..." 
       oninput="getList()" 
       autocomplete="off" 
       name="novel-search-field">
    <div id="logged-in-nav" class="hidden">
        <button onclick="openEditor()">æ–°è¦æŠ•ç¨¿</button>
        <button class="btn-outline" onclick="doLogOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div id="guest-nav">
        <button onclick="toggleAuthForm()">ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²</button>
    </div>
</aside>

<main>
    <section id="auth-form" class="hidden" style="border:2px solid #000; padding:20px; margin-bottom:40px;">
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button onclick="doLogIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button onclick="doSignUp()" class="btn-outline">æ–°è¦ç™»éŒ²</button>
    </section>

    <div id="user-page" class="hidden">
    <div class="section-header">
    <h2 style="margin: 0;">åŸ·ç­†ç®¡ç†</h2>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div style="display: flex; gap: 15px;">
        <span class="settings-link" id="view-my-page-link" style="color: #fcaf17;">[ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª]</span>
        <span class="settings-link" onclick="toggleSettings()">[è¨­å®š]</span>
    </div>

    <button onclick="deleteAccount()" style="width: auto; background: none; border: none; color: #ff4d4d; text-decoration: underline; cursor: pointer; font-size: 0.65em; white-space: nowrap; padding: 0; margin: 0;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button>
</div>
       
        <div id="my-profile-display" style="margin: 10px 0 20px 0;">
        <span id="display-current-name" style="font-size: 1em; font-weight: bold;">èª­ã¿è¾¼ã¿ä¸­...</span>
        <span style="font-size: 0.8em; color: #888;"> ã•ã‚“ã¨ã—ã¦æ´»å‹•ä¸­</span>
    </div>
        <div id="profile-edit-area" class="profile-edit-area">
    <input type="text" id="prof-name" placeholder="ä½œè€…å">
    <textarea id="prof-bio" placeholder="è‡ªå·±ç´¹ä»‹" rows="3"></textarea>
    
    <label>ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (HTML/CSS)</label>
    <span style="color: red; font-size: 0.75em; font-weight: bold; margin-left: 5px;">
        â€»ä»¥ä¸‹ã®æ¬„ã¯ã€CSSç­‰ã®çŸ¥è­˜ãŒã‚ã‚‹æ–¹ã®ã¿ç·¨é›†ã—ã¦ãã ã•ã„ã€‚ç”»é¢è¡¨ç¤ºãŒå´©ã‚Œã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚
    </span>
    <button type="button" onclick="resetToTemplate()" style="font-size: 0.8em; margin-bottom: 5px;">
        åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯å¾Œã€æ›´æ–°ã‚’æŠ¼ã—ä¸‹ã’ï¼‰
    </button>
    <textarea id="prof-css" style="width:100%; height:150px;"></textarea>

    <div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px;">
        <h3 style="font-size: 0.9em; margin-bottom: 10px;">æ–‡ç« ç”»é¢ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (HTML/CSS)</h3>
        <p style="font-size: 0.75em; color: #666;">èª­æ›¸ç”»é¢ã®è¦‹ãŸç›®ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</p>
        
        <button type="button" onclick="resetReaderDesign()" style="font-size: 0.8em; margin-bottom: 5px;">
            åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯å¾Œã€æ›´æ–°ã‚’æŠ¼ã—ä¸‹ã’ï¼‰
        </button>
        <textarea id="reader-custom-input" style="width:100%; height:150px;" placeholder="<style> ã“ã“ã«æ–‡ç« ç”»é¢ç”¨ã®CSSã‚’æ›¸ã </style>"></textarea>
    </div>

    <button class="btn-outline" onclick="saveProfile()" style="width:auto; margin-top:20px;">æ›´æ–°</button>
</div>
        <div id="user-stats-area" style="display: flex; gap: 20px; margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px;">
    <div><strong>åˆè¨ˆæ–‡å­—æ•°:</strong> <span id="total-char-count">0</span> å­—</div>
    <div><strong>åˆè¨ˆã„ã„ã­:</strong> <span id="total-likes">0</span></div>
</div>
        <h3>æŠ•ç¨¿ã—ãŸä½œå“</h3>
        <div id="my-works-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <div id="library-section-header">
    <h2>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h2>
    <span id="search-result-count" style="font-size: 0.8em; color: #666; margin-left: 10px;"></span>
</div>
    <div class="filter-bar">
    <select id="sort-order" onchange="getList()">
        <option value="created_at">æœ€æ–°é †</option>
        <option value="likes">ã„ã„ã­é †</option>
        <option value="char_count">æ–‡å­—æ•°é †</option>
    </select>
</div>
    <div class="tab-bar">
        <button id="tab-all" class="tab-btn active" onclick="switchTab('all')">ã™ã¹ã¦</button>
        <button id="tab-follow" class="tab-btn" onclick="switchTab('follow')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
        <button id="tab-liked" class="tab-btn" onclick="switchTab('liked')">ã„ã„ã­æ¸ˆã¿</button>
    </div>
    <div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>
</main>

<div id="reader-overlay">
    <div class="overlay-content">
        <div class="sticky-close">
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 0 15px;">
                <button class="btn-outline" onclick="closeReader()" style="width:auto; margin:0;">â† é–‰ã˜ã‚‹</button>
                <div id="name-changer-group" style="display: flex; align-items: center; gap: 5px; flex-grow: 1; justify-content: flex-end;">
                    <input type="text" id="target-string" placeholder="å¤‰æ›å‰" style="width: 80px; margin: 0; padding: 5px; font-size: 0.8em;">
                    <span>â†’</span>
                    <input type="text" id="new-name" placeholder="å¤‰æ›å¾Œ" style="width: 80px; margin: 0; padding: 5px; font-size: 0.8em;">
                    <button onclick="applyNameChange()" style="width: auto; padding: 5px 15px; margin: 0; font-size: 0.8em;">å¤‰æ›</button>
                </div>
            </div>
        </div>
        <div id="reader-custom-style"></div>
        <div id="reader-default-ui">
        <h2 id="read-title-default"></h2>
        <div id="read-author-default" style="text-align: right; font-weight: bold;"></div>
        <div id="read-body-default" style="white-space: pre-wrap; line-height: 2.2; margin: 40px 0;"></div>
            </div>
        <div id="reader-interactive-zone" style="border-top: 1px solid #000; padding-top: 20px; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <button id="like-btn" onclick="toggleLike()" style="width:auto; padding: 10px 40px;">
    â™¥ <span id="read-like-text">ã„ã„ã­</span> <span id="read-like-count">0</span>
</button>
                <span id="author-link-zone" style="font-size: 0.9em; color: #666;"></span>
            </div>
            <div style="text-align: left;">
                <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                <div id="comment-list"></div>
                <div id="comment-form-area" class="hidden" style="margin-top: 20px;">
                    <textarea id="comment-input" placeholder="æ„Ÿæƒ³ã‚’æ›¸ã..." rows="3"></textarea>
                    <button onclick="postComment()" class="btn-outline" style="width:auto">ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡</button>
                </div>
                <div id="comment-guest-msg" class="hidden" style="margin-top: 20px; padding: 20px; background: #f9f9f9; text-align: center;">
                    <p>ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                </div>
            </div>
        </div>
    </div>
</div>



<div id="editor-overlay">
    <div class="overlay-content">
        <h2>æ–°è¦æŠ•ç¨¿</h2>
        <input type="text" id="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <input type="text" id="tags-input" placeholder="ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)">
        <textarea id="caption-input" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚ã‚‰ã™ã˜ç­‰ï¼‰" rows="3"></textarea>
        <div class="checkbox-group">
            <label><span class="switch"><input type="checkbox" id="r18-check"><span class="slider"></span></span>R-18</label>
            <label><span class="switch"><input type="checkbox" id="private-check"><span class="slider"></span></span>éå…¬é–‹(ä¸‹æ›¸ã)</label>
        </div>
        <textarea id="content-input" rows="20" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
        <div id="word-count-display">æ–‡å­—æ•°: <span id="current-count">0</span></div>
        <button onclick="doPost()">å…¬é–‹ï¼ä¿å­˜ã™ã‚‹</button>
        <button onclick="closeEditor()" class="btn-outline">é–‰ã˜ã‚‹</button>
    </div>
</div>
<div id="author-page-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:3000; overflow-y:auto;">
    <div class="overlay-content" style="padding: 20px;">
        <button class="btn-outline" onclick="closeAuthorPage()" style="width:auto; margin-bottom: 20px;">â† æˆ»ã‚‹</button>

        <div id="author-profile-header">
            <h1 id="author-page-name" style="font-family: 'Yu Gothic', 'YuGothic', sans-serif; font-weight: bold;"></h1>
            
            <div id="author-page-bio"></div>
        </div>

        <div id="author-page-works" style="margin-top:20px;"></div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
const api = window.supabase.createClient(u, k, {
    auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
    }
});
    let currentUser = null, userProfile = null, currentTab = 'all', currentReadingId = null;
    let editingNovelId = null, allMyNovels = [], originalContent = "";

        // æ–‡ç« ç”»é¢ã®åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³
const defaultReaderTemplate = `<div class="reader-container">
    <div style="text-align: left; margin-bottom: 20px;">
        <button onclick="closeReader()" style="width:auto; padding:5px 15px;">â† é–‰ã˜ã‚‹</button>
    </div>

    <h1 id="read-title" class="custom-title-style"></h1>
    
    <div class="meta-info">
        åŸ·ç­†ï¼š<span id="read-author"></span>
    </div>

    <article id="read-body" class="novel-text-area"></article>

    <div id="reader-interactive-zone" class="footer-zone">
        <button id="like-btn" onclick="toggleLike()">â™¥ ã„ã„ã­</button>
        <div id="author-link-zone"></div>
    </div>
</div>

<style>
/* ã“ã“ã«ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ›¸ã„ã¦ã„ã */
.custom-title-style {
    color: #4682b4;
    text-align: center;
    font-family: 'Dela Gothic One', sans-serif;
}
.novel-text-area {
    white-space: pre-wrap;
    line-height: 2.2;
    font-family: serif;
}
.footer-zone {
    margin-top: 50px;
    border-top: 1px dashed #ccc;
    padding-top: 20px;
}
</style>`;

// ä½œè€…ãƒšãƒ¼ã‚¸ã®åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³
const defaultAuthorTemplate = `/* ã€ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘ã“ã“ã‚’è‡ªç”±ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ */

<h1 class="default-title">ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ«</h1>

<div class="default-bio">
    ã“ã“ã«è‡ªå·±ç´¹ä»‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
</div>

<div id="custom-works-area"></div>

<style>
/* --- æ¨™æº–ã®ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */

/* 1. å…ƒã€…ã®ã‚·ã‚¹ãƒ†ãƒ è¡¨ç¤ºã‚’éš ã™ï¼ˆäºŒé‡è¡¨ç¤ºé˜²æ­¢ï¼‰ */
#author-page-name { display: none; }

/* 2. ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.default-title {
    font-family: 'Yu Gothic', 'YuGothic', sans-serif;
    font-weight: bold;
    font-size: 1.8em;
    margin: 10px 0;
    color: #333;
}

/* 3. è‡ªå·±ç´¹ä»‹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.default-bio {
    font-size: 1em;
    color: #666;
    margin-bottom: 30px;
    line-height: 1.6;
}

/* 4. ä½œå“ãƒªã‚¹ãƒˆã®è¦‹ãŸç›®ï¼ˆã‚·ã‚¹ãƒ†ãƒ æ¨™æº–ã«è¿‘ã„ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
.novel-row {
    padding: 15px 0;
    border-bottom: 1px solid #eee;
}

.novel-title {
    font-size: 1.1em;
    color: #333 !important;
    text-decoration: none;
    font-weight: bold;
}

.count-badge {
    font-size: 0.8em;
    color: #999;
    margin-left: 10px;
}
</style>`;
    
    async function init() {
    // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºå®Ÿã«å–å¾—ï¼ˆã‚¹ãƒãƒ›ã§æœ€é‡è¦ï¼‰
    const { data: { session } } = await api.auth.getSession();
    currentUser = session?.user || null;

    // 2. ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã® UI ã‚»ãƒƒãƒˆ
    if (currentUser) {
        document.getElementById('logged-in-nav').classList.remove('hidden');
        document.getElementById('guest-nav').classList.add('hidden');
        document.getElementById('user-page').classList.remove('hidden');

        await loadProfile();
        await loadUserContent();
    }
// ã€è¿½åŠ ã€‘ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆä½œè€…åï¼‰ãŒã€Œåç„¡ã—ã€ã®ã¾ã¾ã€ã¾ãŸã¯æœªè¨­å®šãªã‚‰å¼·åˆ¶è¨­å®š
        if (!userProfile || !userProfile.display_name || userProfile.display_name === "åç„¡ã—") {
            forceProfileSetup();}
            
    // 3. currentUser ãŒç¢ºå®šã—ã¦ã‹ã‚‰ä½œå“ãƒªã‚¹ãƒˆã‚’å–å¾—
    await getList();

    // 4. æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾æ®‹ã™ï¼‰
    const contentInput = document.getElementById('content-input');
    if (contentInput) {
        contentInput.addEventListener('input', (e) => {
            const count = e.target.value.length;
            document.getElementById('current-count').innerText = count.toLocaleString();
        });
    }
}

    async function loadProfile() {
    const { data, error } = await api.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
    if (error) {
        console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return;
    }
    
    userProfile = data;
    if (data) {
        const name = data.display_name || "åç„¡ã—";
        
        if (document.getElementById('prof-name')) document.getElementById('prof-name').value = name;
        if (document.getElementById('prof-bio')) document.getElementById('prof-bio').value = data.bio || "";
        
        // 1. ä½œè€…ãƒšãƒ¼ã‚¸ç”¨CSSã®ã‚»ãƒƒãƒˆ
        const cssInput = document.getElementById('prof-css');
        if (cssInput) {
            // å¤–ã«å‡ºã—ãŸ defaultAuthorTemplate ã‚’ä½¿ã†ã‚ˆã†ã«ä¿®æ­£
            cssInput.value = data.custom_css || defaultAuthorTemplate;
        }

        // 2. æ–‡ç« ç”»é¢ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚»ãƒƒãƒˆï¼ˆâ˜…ã“ã“ã‚’è¿½åŠ ï¼ï¼‰
        const readerInput = document.getElementById('reader-custom-input');
        if (readerInput) {
            // å¤–ã«å‡ºã—ãŸ defaultReaderTemplate ã‚’ä½¿ã†
            readerInput.value = data.reader_custom_code || defaultReaderTemplate;
        }

        const displayEl = document.getElementById('display-current-name');
        if (displayEl) displayEl.innerText = name;

        const viewMyPageBtn = document.getElementById('view-my-page-link');
        if (viewMyPageBtn) {
            viewMyPageBtn.onclick = () => openAuthorPage(currentUser.id);
        }
    }
}    
    async function getList() {
    const listEl = document.getElementById('list');
    if (!listEl) return;

    try {
        // 1. åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆçµ±è¨ˆã¯å«ã‚ãªã„ï¼‰
        let query = api.from('novels').select('*').eq('is_private', false);
        let { data: novels, error } = await query.order('created_at', { ascending: false });
        if (error) throw error;

        let baseNovels = novels || [];

        // ã€æ©Ÿèƒ½ç¶­æŒã€‘è‡ªåˆ†ã®ä½œå“ã‚’é™¤å¤–
        if (currentUser) {
            baseNovels = baseNovels.filter(n => n.author_id !== currentUser.id);
        }

        // 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæ¤œç´¢ãƒ»ã‚¿ãƒ–ï¼‰
        const sw = document.getElementById('search-input').value.toLowerCase();
        let filtered = baseNovels;

        if (currentTab === 'liked' && currentUser) {
            const { data: myLikes } = await api.from('likes').select('novel_id').eq('user_id', currentUser.id);
            const likedIds = (myLikes || []).map(l => l.novel_id);
            filtered = filtered.filter(n => likedIds.includes(n.id));
        }

        if (sw) {
            filtered = filtered.filter(n => 
                n.title.toLowerCase().includes(sw) || 
                n.author_name.toLowerCase().includes(sw) ||
                (n.tags && n.tags.some(t => t.toLowerCase().includes(sw)))
            );
        }

        // 3. æ¤œç´¢ä»¶æ•°ã®è¡¨ç¤º
        const countEl = document.getElementById('search-result-count');
        if (countEl) countEl.innerText = sw ? `${filtered.length} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ` : "";

       // 4. ã¾ãšã€Œæ ã€ã‚’æç”»ã™ã‚‹ï¼ˆã“ã‚Œã§ã‚¹ãƒãƒ›ã§ã‚‚å³åº§ã«ä½œå“åãŒå‡ºã‚‹ï¼ï¼‰
const sortType = document.getElementById('sort-order').value;
listEl.innerHTML = filtered.map(n => {
    // ã€è¿½åŠ ã€‘R18ãƒãƒƒã‚¸ã®åˆ¤å®š
    const r18Badge = n.is_r18 ? `<span class="r18-badge">R18</span>` : "";

    return `        
        <div class="novel-row">
            <div class="novel-info">
                <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                ${r18Badge}
                <span onclick="openAuthorPage('${n.author_id}')" style="font-size:0.8em; color:#888; cursor:pointer; text-decoration:underline;">
                    / ${n.author_name}
                </span>
                <div style="margin-top:5px;">
                    ${(n.tags && n.tags.length > 0) 
                        ? n.tags
                            .filter(t => t.trim() !== "") 
                            .map(t => `<span class="tag-link" onclick="setSearchTag('${t}')">#${t}</span>`)
                            .join('') 
                        : ''}
                </div>
            </div>
            <div class="novel-stats" id="stats-${n.id}">
                <span class="count-badge">${(n.content || "").length.toLocaleString()}æ–‡å­—</span>
                <span class="stat-item" id="like-count-${n.id}">â™¥ ...</span>
                <span class="stat-item" id="comm-count-${n.id}">ğŸ’¬ ...</span>
            </div>
        </div>`;
}).join('') || '<div style="padding:20px; text-align:center; color:#888;">ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“</div>';

        // 5. éåŒæœŸã§çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã¦ã€å¾Œã‹ã‚‰æ•°å­—ã‚’åŸ‹ã‚ã‚‹
        filtered.forEach(async (n) => {
            try {
                const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                
                n.like_count = lCount || 0;
                n.comment_count = cCount || 0;
                n.char_count = (n.content || "").length;

                // ç”»é¢ä¸Šã®æ•°å­—ã ã‘ã‚’æ›´æ–°ï¼ˆãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§æ›¸ãæ›ãˆï¼‰
                const likeEl = document.getElementById(`like-count-${n.id}`);
                const commEl = document.getElementById(`comm-count-${n.id}`);
                if (likeEl) likeEl.innerText = `â™¥ ${n.like_count}`;
                if (commEl) commEl.innerText = `ğŸ’¬ ${n.comment_count}`;

                // ã‚‚ã—ã€Œã„ã„ã­é †ã€ã€Œæ–‡å­—æ•°é †ã€ãŒé¸ã°ã‚Œã¦ã„ãŸã‚‰
                // å…¨ä»¶å–å¾—å¾Œã«ä¸¦ã³æ›¿ãˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹å ´åˆã¯ã“ã“ã§è¡Œã„ã¾ã™ãŒã€
                // ã¾ãšã¯ãƒªã‚¹ãƒˆãŒå‡ºã‚‹ã“ã¨ã‚’å„ªå…ˆã—ã¾ã—ã‚‡ã†ã€‚
            } catch (err) {
                console.warn("çµ±è¨ˆå–å¾—ã«å¤±æ•—:", n.title);
            }
        });

    } catch (e) {
        console.error("getListå…¨ä½“ã‚¨ãƒ©ãƒ¼:", e);
        listEl.innerHTML = `<div style="padding:20px; text-align:center;">ä½œå“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><button onclick="getList()">å†è©¦è¡Œ</button></div>`;
    }
}

    function setSearchTag(tagName) {
    // 1. æ¤œç´¢çª“ã«ã‚¿ã‚°åã‚’å…¥ã‚Œã‚‹
    const searchInput = document.getElementById('search-input');
    if (searchInput) searchInput.value = tagName;

    // 2. æ¤œç´¢ã‚’å®Ÿè¡Œï¼ˆãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼‰
    getList();

    // 3. ã€è¿½åŠ ã€‘ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¦‹å‡ºã—ï¼ˆã¾ãŸã¯ãƒªã‚¹ãƒˆã®å…ˆé ­ï¼‰ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    const libraryHeader = document.getElementById('library-section-header');
    if (libraryHeader) {
        libraryHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

    async function loadUserContent() {
    if (!currentUser) return;
    let { data: novels } = await api.from('novels').select('*').eq('author_id', currentUser.id).order('created_at', {ascending: false});
    allMyNovels = novels || [];

    let totalChars = 0;
    let totalLikesSum = 0;

    // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰ä»£å…¥ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›ã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®è¦ï¼ï¼‰
    const myWorksList = document.getElementById('my-works-list');
    const totalCharEl = document.getElementById('total-char-count');
    const totalLikesEl = document.getElementById('total-likes');

    if (myWorksList) {
        myWorksList.innerHTML = allMyNovels.map(n => {
            totalChars += (n.content || "").length; 
            
            // ãƒãƒƒã‚¸ã®åˆ¤å®š
            const r18Badge = n.is_r18 ? `<span class="r18-badge">R18</span>` : "";
            const draftBadge = n.is_private ? `<span class="draft-badge">ä¸‹æ›¸ã</span>` : "";            
            
            return `
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    
                    ${draftBadge}
                    ${r18Badge}
                    
                    <div id="my-stats-${n.id}" class="novel-stats">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div>
                    <span style="cursor:pointer; text-decoration:underline; font-size:0.8em;" onclick="openEditor('${n.id}')">[ç·¨é›†]</span>
                    <span class="btn-delete" onclick="deleteNovel('${n.id}', '${n.title}')">[å‰Šé™¤]</span>
                </div>
            </div>`;
        }).join('') || "ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“";
    }

    if (totalCharEl) totalCharEl.innerText = totalChars.toLocaleString();

    allMyNovels.forEach(async (n) => {
        const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
        const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
        
        totalLikesSum += (lCount || 0);
        if (totalLikesEl) totalLikesEl.innerText = totalLikesSum.toLocaleString();

        const el = document.getElementById(`my-stats-${n.id}`);
        if(el) el.innerHTML = `<span class="stat-item">â™¥ ${lCount||0}</span> <span class="stat-item">ğŸ’¬ ${cCount||0}</span>`;
    });
}

    function openEditor(id = null) {
        editingNovelId = id;
        if (id) {
            const n = allMyNovels.find(x => String(x.id) === String(id));
            if (!n) return;
            document.getElementById('title-input').value = n.title || "";
            document.getElementById('tags-input').value = (n.tags || []).join(', ');
            document.getElementById('caption-input').value = n.caption || "";
            document.getElementById('content-input').value = n.content || "";
            document.getElementById('r18-check').checked = !!n.is_r18;
            document.getElementById('private-check').checked = !!n.is_private;
            document.getElementById('current-count').innerText = (n.content || "").length.toLocaleString();
            document.querySelector('#editor-overlay h2').innerText = "ä½œå“ã‚’ç·¨é›†";
        } else {
            document.getElementById('title-input').value = "";
            document.getElementById('tags-input').value = "";
            document.getElementById('caption-input').value = "";
            document.getElementById('content-input').value = "";
            document.getElementById('r18-check').checked = false;
            document.getElementById('private-check').checked = false;
            document.getElementById('current-count').innerText = "0";
            document.querySelector('#editor-overlay h2').innerText = "æ–°è¦æŠ•ç¨¿";
        }
        document.getElementById('editor-overlay').style.display = 'block';
    }

    async function openReader(id) {
    currentReadingId = id;
    const overlay = document.getElementById('reader-overlay');
    const defaultUi = document.getElementById('reader-default-ui');
    const customStyle = document.getElementById('reader-custom-style');
    const interactiveZone = document.getElementById('reader-interactive-zone');
    const nameChanger = document.getElementById('name-changer-group');

    // 1. ãƒ‡ãƒ¼ã‚¿å–å¾—
    const { data: n, error } = await api.from('novels').select('*').eq('id', id).maybeSingle();
    if (error || !n) return alert("ä½œå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

    const { data: prof } = await api.from('profiles').select('reader_custom_code').eq('id', n.author_id).maybeSingle();

    // 2. UIåˆæœŸåŒ–
    overlay.style.display = 'block';
    overlay.scrollTop = 0;
    resetReaderUI(); 

    // 3. ã‚³ãƒ¡ãƒ³ãƒˆã®å–å¾—ï¼ˆã‚«ãƒ©ãƒ åã‚’ body ã«ä¿®æ­£ï¼‰
    const { data: comments } = await api.from('comments').select('*').eq('novel_id', id).order('created_at', { ascending: true });
    
    const commentsHtml = (comments || []).map(c => {
        // c.content ã§ã¯ãªã c.body ã‚’ä½¿ç”¨ã€‚ã¾ãŸ undefined å›é¿ã®ãŸã‚ || "" ã‚’è¿½åŠ ã€‚
        const commentBody = (c.body || "").replace(/\n/g, '<br>');
        return `
            <div class="comment-item" style="border-bottom: 1px dotted #ccc; padding: 10px 0;">
                <div style="font-size: 0.8em; color: #888;">${c.user_name || 'åç„¡ã—ã•ã‚“'} - ${new Date(c.created_at).toLocaleDateString()}</div>
                <div style="margin-top: 5px;">${commentBody}</div>
            </div>
        `;
    }).join('') || "<p style='color:#888;'>ã¾ã æ„Ÿæƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";

    const commentFormHtml = `
        <div id="comment-form-area" style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:8px;">
            <input type="text" id="comment-user-name" placeholder="ãŠåå‰ï¼ˆç©ºæ¬„ã§åç„¡ã—ï¼‰" style="width:100%; margin-bottom:10px;">
            <textarea id="comment-text" placeholder="æ„Ÿæƒ³ã‚’é€ã‚‹" style="width:100%; height:80px;"></textarea>
            <button onclick="sendComment('${n.id}')" style="margin-top:10px; cursor:pointer;">æ„Ÿæƒ³ã‚’é€ä¿¡ã™ã‚‹</button>
        </div>
    `;

    // 4. è¡¨ç¤ºã®åˆ‡ã‚Šåˆ†ã‘
    if (prof && prof.reader_custom_code && prof.reader_custom_code.trim() !== "") {
        // --- ã‚«ã‚¹ã‚¿ãƒ UI ---
        defaultUi.style.display = 'none';
        customStyle.style.display = 'block';
        customStyle.innerHTML = prof.reader_custom_code;
        
        const tEl = document.getElementById('read-title');
        const aEl = document.getElementById('read-author');
        const bEl = document.getElementById('read-body');
        const cEl = document.getElementById('read-comments');

        if (tEl) tEl.innerText = n.title;
        if (aEl) aEl.innerText = n.author_name;
        if (bEl) {
            bEl.innerHTML = n.content.replace(/\n/g, '<br>');
            bEl.dataset.original = n.content.replace(/\n/g, '<br>');
        }
        if (cEl) cEl.innerHTML = commentsHtml + commentFormHtml;

    } else {
        // --- æ¨™æº–UI ---
        defaultUi.style.display = 'block';
        customStyle.style.display = 'none';

        const titleEl = document.getElementById('read-title-default');
        const authorEl = document.getElementById('read-author-default');
        if (titleEl) titleEl.innerText = n.title;
        if (authorEl) authorEl.innerText = n.author_name;
        
        const bEl = document.getElementById('read-body-default');
        if (bEl) {
            bEl.innerHTML = n.content.replace(/\n/g, '<br>');
            bEl.dataset.original = n.content.replace(/\n/g, '<br>');
            bEl.classList.add('indent-text');
        }

        const cArea = document.getElementById('read-comments-default');
        if (cArea) cArea.innerHTML = commentsHtml + commentFormHtml;
    }

    // 5. å…±é€šUIè¡¨ç¤º
    if (interactiveZone) interactiveZone.classList.remove('hidden');
    if (nameChanger) nameChanger.classList.remove('hidden');

    loadLikeCount(id);
    checkFollowStatus(n.author_id);
    
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) followBtn.onclick = () => toggleFollow(n.author_id);
}

// åå‰å¤‰æ›æ©Ÿèƒ½ã®ä¿®æ­£ï¼ˆHTMLã‚¿ã‚°ã‚’å£Šã•ãªã„ã‚ˆã†ã«ä¿®æ­£ï¼‰
function applyNameChange() {
    const target = document.getElementById('target-string').value;
    const replacement = document.getElementById('new-name').value;
    if (!target) return; // è­¦å‘Šã¯å‡ºã•ãšã€å…¥åŠ›ãŒãªã„æ™‚ã¯ä½•ã‚‚ã—ãªã„
    
    const escapedTarget = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(escapedTarget, 'g');
    
    const bodyEl = document.getElementById('read-body') || document.getElementById('read-body-default');
    
    if (bodyEl && bodyEl.dataset.original) {
        // innerText ã§ã¯ãªã innerHTML ã‚’ä½¿ã„ã€ä¿å­˜ã—ã¦ãŠã„ãŸã‚ªãƒªã‚¸ãƒŠãƒ«ã‹ã‚‰å¤‰æ›
        bodyEl.innerHTML = bodyEl.dataset.original.replace(regex, replacement || "");
    }
}

    async function loadComments(id) {
        const { data, error } = await api
            .from('comments')
            .select('*') // profilesã¨ã®çµåˆã‚’ã‚„ã‚ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹
            .eq('novel_id', id)
            .order('created_at', {ascending: true});

        if (error) {
            console.error("ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error.message);
            document.getElementById('comment-list').innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            return;
        }

        const listEl = document.getElementById('comment-list');
        if (!data || data.length === 0) {
            listEl.innerHTML = "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“";
            return;
        }

        listEl.innerHTML = data.map(c => {
            const isMine = currentUser && c.user_id === currentUser.id;
            // åå‰ã¯ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ user_name ã‚’ä½¿ç”¨ã™ã‚‹
            const name = c.user_name || "åç„¡ã—";
            
            const manageBtns = isMine ? `
                <span onclick="deleteComment('${c.id}')" 
                      style="cursor:pointer; color:red; font-size:0.8em; margin-left:5px;">
                      [å‰Šé™¤]
                </span>` : '';

            return `
                <div class="comment-item">
                    <strong>${name}</strong>: ${c.body} ${manageBtns}
                </div>`;
        }).join('');
    }

    async function postComment() {
        const b = document.getElementById('comment-input').value.trim();
        if(!b || !currentUser) return;

        // userProfile(ãƒã‚¤ãƒšãƒ¼ã‚¸æƒ…å ±)ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€ãªã‘ã‚Œã°ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        const displayName = (userProfile && userProfile.display_name) 
                            ? userProfile.display_name 
                            : currentUser.email.split('@')[0];

        const { error } = await api.from('comments').insert({ 
            novel_id: currentReadingId, 
            user_id: currentUser.id, 
            user_name: displayName, 
            body: b 
        });

        if (error) {
            console.error("ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:", error.message);
            alert("ã‚³ãƒ¡ãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        } else {
            document.getElementById('comment-input').value = "";
            loadComments(currentReadingId);
        }
    }

    async function deleteComment(id) {
        if (!confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        const { error } = await api
            .from('comments')
            .delete()
            .eq('id', id)
            .eq('user_id', currentUser.id); // è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿å‰Šé™¤å¯èƒ½ï¼ˆå¿µã®ãŸã‚ï¼‰

        if (error) {
            console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error.message);
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        } else {
            // å‰Šé™¤ã§ããŸã‚‰ã€ä»Šèª­ã‚“ã§ã„ã‚‹å°èª¬ã®ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadComments(currentReadingId);
        }
    }
    async function toggleLike() {
        if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");

        // currentReadingId ãŒæ–‡å­—åˆ—ã® "6" ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€
        // DBã®å‹ã«åˆã‚ã›ã¦å‡¦ç†ã—ã¾ã™ã€‚
        const { data: existingLike, error: checkError } = await api
            .from('likes')
            .select('*')
            .eq('novel_id', Number(currentReadingId)) // ã“ã“ã§å‹ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (checkError) {
            console.error("ã„ã„ã­ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:", checkError.message);
            // ã‚‚ã—ã“ã“ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ãªã‚‰ã€DBã®ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã§ novel_id ãŒ
            // uuidå‹ãªã®ã«ã€é€ã£ã¦ã„ã‚‹IDãŒæ•°å­—ï¼ˆ1, 2, 3...ï¼‰ãªã®ãŒåŸå› ã§ã™ã€‚
            return;
        }

        if (existingLike) {
            // 2. ã™ã§ã«ã„ã„ã­æ¸ˆã¿ãªã‚‰ã€å–ã‚Šæ¶ˆã™ï¼ˆã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨æ¶ˆãˆã‚‹ä»•æ§˜ï¼‰
            await api.from('likes').delete().eq('id', existingLike.id);
        } else {
            // 3. ã¾ã ãªã‚‰ã€ã„ã„ã­ã‚’è¿½åŠ 
            const { error: insertError } = await api.from('likes').insert({ 
                novel_id: currentReadingId, 
                user_id: currentUser.id 
            });
            if (insertError) {
                console.error("ã„ã„ã­ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", insertError.message);
                alert("ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            }
        }

        // 4. ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        loadLikeCount(currentReadingId);
    }

    async function loadLikeCount(id) {
        const countEl = document.getElementById('read-like-count');
        const likeBtn = document.getElementById('like-btn');
        if (!countEl || !likeBtn) return; // è¦ç´ ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰

        // å…¨ä½“ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
        const { count } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', id);
        countEl.innerText = count || 0;

        if (currentUser) {
            const { data } = await api.from('likes')
                .select('*')
                .eq('novel_id', id)
                .eq('user_id', currentUser.id)
                .maybeSingle();

            if (data) {
                likeBtn.style.background = "#ff4d4d";
                likeBtn.style.color = "#fff";
                // innerTextã‚’ä¸¸ã”ã¨å¤‰ãˆã‚‹ã¨ä¸­ã®span(countç”¨)ãŒæ¶ˆãˆã‚‹ã®ã§æ³¨æ„
                document.getElementById('read-like-text').innerText = "ã„ã„ã­æ¸ˆã¿";
            } else {
                likeBtn.style.background = "#fff";
                likeBtn.style.color = "#000";
                document.getElementById('read-like-text').innerText = "ã„ã„ã­";
            }
        }
    }

    async function doPost() {
        // ã€è¿½åŠ ã€‘æŠ•ç¨¿å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
    if (!userProfile || !userProfile.display_name || userProfile.display_name === "åç„¡ã—") {
        alert("æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã§ã€Œä½œè€…åã€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
        forceProfileSetup(); // è¨­å®šæ¬„ã‚’è¡¨ç¤º
        return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†ã—ã€DBã«é€ã‚‰ã›ãªã„
    }
        const payload = {
            title: document.getElementById('title-input').value,
            content: document.getElementById('content-input').value,
            caption: document.getElementById('caption-input').value,
            tags: document.getElementById('tags-input').value.split(',').map(t => t.trim()).filter(t => t),
            is_r18: document.getElementById('r18-check').checked,
            is_private: document.getElementById('private-check').checked,
            author_id: currentUser.id,
            author_name: userProfile?.display_name || "åç„¡ã—"
        };
        const { error } = editingNovelId ? await api.from('novels').update(payload).eq('id', editingNovelId) : await api.from('novels').insert(payload);
        if(error) alert(error.message); else location.reload();
    }

    async function deleteNovel(id, title) {
        if (!confirm(`ä½œå“ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await api.from('novels').delete().eq('id', id);
        location.reload();
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t));
        getList();
    }

    function openRules() {
    // 1. ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ¨™æº–ã«æˆ»ã™
    const defaultUiEl = document.getElementById('reader-default-ui');
    const readerStyleEl = document.getElementById('reader-custom-style');
    if (defaultUiEl) defaultUiEl.style.display = 'block';
    if (readerStyleEl) readerStyleEl.style.display = 'none';
        
    resetReaderUI(); 

    // 2. â˜…ã“ã“ãŒé‡è¦ï¼ æ¨™æº–ã®ã€Œ0ä»˜ãIDã€ã‚’å–å¾—ã™ã‚‹
    const titleEl = document.getElementById('read-title-default');
    const authorEl = document.getElementById('read-author-default');
    const bodyEl = document.getElementById('read-body-default');

    // 3. è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä¸­èº«ã‚’æ›¸ãæ›ãˆã‚‹
    if (titleEl) {
        titleEl.innerText = "ãƒ«ãƒ¼ãƒ«ï¼ˆå¿…èª­ï¼‰";
        titleEl.style.textDecoration = "underline";
        titleEl.style.textUnderlineOffset = "10px";
    }
    
    if (authorEl) {
        authorEl.innerText = "é‹å–¶";
    }

    if (bodyEl) {
        bodyEl.classList.remove('indent-text');
        bodyEl.classList.add('hanging-indent');
        bodyEl.innerHTML = `
            å½“ã‚µã‚¤ãƒˆã¯å€‹äººã«ã‚ˆã‚‹äºŒæ¬¡å‰µä½œå°èª¬ã®å±•ç¤ºãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ç›®çš„ã¨ã—ãŸå°‚ç”¨ã‚µã‚¤ãƒˆã§ã™ã€‚<br><br>
            ãƒ»æ¤œç´¢é¿ã‘ã®ãŸã‚ã€<span style="color: #ff4d4d; font-weight: bold;">åŸä½œåã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹ã“ã¨ã¯é¿ã‘ã¦</span>ãã ã•ã„ã€‚<br>
            ãƒ»<span style="border-bottom: 2px solid #000;">å…¬åºè‰¯ä¿—ã«åã™ã‚‹å†…å®¹ã®æŠ•ç¨¿ã€ç„¡æ–­è»¢è¼‰ã€AIå­¦ç¿’åˆ©ç”¨ã¯å›ºãç¦æ­¢</span>ã„ãŸã—ã¾ã™ã€‚<br>
            ãƒ»<span style="background-color: #ffff00;">RæŒ‡å®šãŒå¿…è¦ãªå ´åˆã¯å¿…ãšè¨­å®š</span>ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚<br><br>
            ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦ã€å‰µä½œæ´»å‹•ã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ã€‚
        `;
    }

    // 4. è¡¨ç¤º
    document.getElementById('reader-overlay').style.display = 'block';
    const changer = document.getElementById('name-changer-group');
    if (changer) changer.classList.add('hidden');
    
    const interact = document.getElementById('reader-interactive-zone');
    if (interact) interact.classList.add('hidden');
}

    function toggleSettings() { const s = document.getElementById('profile-edit-area'); s.style.display = s.style.display==='block'?'none':'block'; }
    function closeReader() {
    document.getElementById('reader-overlay').style.display = 'none';
    resetReaderUI(); // é–‰ã˜ã‚‹æ™‚ã«ã‚‚ãŠæƒé™¤
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¦å¹²æ¸‰ã‚’é˜²ã
    const readerStyleEl = document.getElementById('reader-custom-style');
    if (readerStyleEl) {
        readerStyleEl.innerHTML = "";
        readerStyleEl.style.display = 'none';
    }
}
    
    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    async function doLogOut() {
        await api.auth.signOut();
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãªã©ã‚‚å¿µã®ãŸã‚ã‚¯ãƒªã‚¢
        window.localStorage.clear();
        window.sessionStorage.clear();
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸å¼·åˆ¶ç§»å‹•
        window.location.replace(window.location.pathname);
    }
    function toggleAuthForm() { document.getElementById('auth-form').classList.toggle('hidden'); }
    async function doLogIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        const { data, error } = await api.auth.signInWithPassword({ email, password });
        
        if (error) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
        } else {
            // æˆåŠŸã—ãŸã‚‰å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒãƒ›ã®å‡¦ç†å¾…ã¡å¯¾ç­–ï¼‰
            setTimeout(() => {
                window.location.replace(window.location.pathname);
            }, 500);
        }
    }    
async function doSignUp() { const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if(error) alert(error.message); else alert("ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }    
async function saveProfile() {
    const name = document.getElementById('prof-name').value.trim();
    if (!name) return alert("ä½œè€…åã¯å¿…é ˆã§ã™ï¼");

    const updates = {
        id: currentUser.id,
        display_name: name,
        bio: document.getElementById('prof-bio').value,
        custom_css: document.getElementById('prof-css').value,
        reader_custom_code: document.getElementById('reader-custom-input').value,
        updated_at: new Date()
    };

    // 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°
    const { error: profError } = await api.from('profiles').upsert(updates);
    if (profError) return alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + profError.message);

    // 2. éå»ä½œå“ã®ä½œè€…åã‚‚ä¸€æ‹¬æ›´æ–°ï¼ˆã“ã“ã‚’è¿½åŠ ï¼ï¼‰
    const { error: novelError } = await api.from('novels')
        .update({ author_name: name })
        .eq('author_id', currentUser.id);

    if (novelError) {
        console.warn("ä½œå“åã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æ­£å¸¸ã§ã™ï¼‰");
    }

    alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    location.reload();
}

    function filterByAuthor(name) {
        document.getElementById('search-input').value = name;
        closeReader();
        switchTab('all');
        getList();
    }
    
function forceProfileSetup() {
        // è¨­å®šã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        const settingsArea = document.getElementById('profile-edit-area');
        settingsArea.style.display = 'block';
        
        // æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
        const header = document.querySelector('#user-page h2');
        header.innerHTML = 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ <span style="font-size:0.5em; color:red;">(å¿…é ˆ)</span>';
        
        // ä½œè€…åå…¥åŠ›æ¬„ã‚’èµ¤æ ã«ã—ã¦ç›®ç«‹ãŸã›ã‚‹
        const nameInput = document.getElementById('prof-name');
        nameInput.style.border = "2px solid red";
        nameInput.placeholder = "ã€å¿…é ˆã€‘ä½œè€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        
        // æ³¨æ„ï¼šã“ã®çŠ¶æ…‹ã§ã¯ä»–ã®æ“ä½œã‚’åˆ¶é™ã—ãŸã„å ´åˆã¯ã€
        // ã€Œæ–°è¦æŠ•ç¨¿ã€ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãªã©ã®å‡¦ç†ã‚‚æœ‰åŠ¹ã§ã™
        const postBtn = document.querySelector('#logged-in-nav button');
        if(postBtn) postBtn.disabled = true;
    }
    // ãƒšãƒ¼ã‚¸ãŒã€Œæˆ»ã‚‹ã€ã§è¡¨ç¤ºã•ã‚ŒãŸéš›ã€å¼·åˆ¶çš„ã«çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
            window.location.reload();
        }
    });

    async function checkFollowStatus(authorId) {
        const { data } = await api.from('follows').select('*').eq('follower_id', currentUser.id).eq('following_id', authorId).maybeSingle();
        const btn = document.getElementById('follow-btn');
        if (!btn) return;

        if (data) {
            btn.innerText = "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­";
            btn.style.background = "#fcaf17"; // ã‚ªãƒ¬ãƒ³ã‚¸ã§å¡—ã‚Šã¤ã¶ã—
            btn.style.color = "#fff";
        } else {
            btn.innerText = "ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹";
            btn.style.background = "#fff";
            btn.style.color = "#fcaf17";
        }
    }

    async function toggleFollow(authorId) {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const { data: existing } = await api.from('follows').select('*').eq('follower_id', currentUser.id).eq('following_id', authorId).maybeSingle();

        if (existing) {
            await api.from('follows').delete().eq('id', existing.id);
        } else {
            await api.from('follows').insert({ follower_id: currentUser.id, following_id: authorId });
        }
        checkFollowStatus(authorId);
    }

async function openAuthorPage(authorId) {
    const overlay = document.getElementById('author-page-overlay');
    const worksEl = document.getElementById('author-page-works');
    const nameEl = document.getElementById('author-page-name');
    const bioEl = document.getElementById('author-page-bio');
    const styleEl = document.getElementById('user-custom-style');

    if (!overlay || !worksEl) return;

    // 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ã‚³ãƒ¼ãƒ‰ï¼ˆHTML/CSSï¼‰ã‚’å–å¾—
    const { data: prof, error } = await api.from('profiles').select('*').eq('id', authorId).maybeSingle();
    if (error || !prof) return;

    // 2. HTMLã¨CSSã®åˆ‡ã‚Šåˆ†ã‘
    const fullCode = prof.custom_css || "";
    const cssMatch = fullCode.match(/<style>([\s\S]*?)<\/style>/);
    const cssPart = cssMatch ? cssMatch[1] : fullCode;
    const htmlPart = fullCode.replace(/<style>[\s\S]*?<\/style>/, "");

    // 3. ã‚¹ã‚¿ã‚¤ãƒ«ã¨HTMLã®é©ç”¨ï¼ˆã“ã“ã§ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒªã‚¢ãŒå‡ºç¾ã™ã‚‹ï¼‰
    if (styleEl) styleEl.innerHTML = cssPart; 
    bioEl.innerHTML = htmlPart || prof.bio || ""; 
    nameEl.innerText = prof.display_name;

    worksEl.innerHTML = "ä½œå“ã‚’èª­ã¿è¾¼ã¿ä¸­...";
    overlay.style.display = 'block';
    closeReader();

    // 4. å°èª¬ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    const { data: novels } = await api.from('novels')
        .select('*')
        .eq('author_id', authorId)
        .eq('is_private', false)
        .order('created_at', { ascending: false });

    // 5. ã€é‡è¦ã€‘ä½œå“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹å ´æ‰€ã®æ±ºå®š
    // bioEl.innerHTML ã®ä¸­ã« 'custom-works-area' ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    const customArea = document.getElementById('custom-works-area');
    const targetEl = customArea || worksEl; 

    // 6. ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¦è¡¨ç¤º
    targetEl.innerHTML = (novels || []).map(n => {
        // R18ãƒãƒƒã‚¸ã®ä½œæˆ
        const r18Badge = n.is_r18 ? `<span class="r18-badge">R18</span>` : "";
        
        // ã‚¿ã‚°ã®HTMLä½œæˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ¤œç´¢ç”»é¢ã¸é£›ã¶ã‚ˆã†ã«ï¼‰
        const tagsHtml = (n.tags && n.tags.length > 0) 
    ? n.tags
        .filter(t => t.trim() !== "") // â˜…ã“ã“ã«ã‚‚è¿½åŠ ï¼
        .map(t => `<span class="tag-link" onclick="setSearchTag('${t}'); document.getElementById('author-page-overlay').style.display='none';">#${t}</span>`)
        .join('')
    : ""; // ã‚¿ã‚°ãŒãªã„æ™‚ã¯ç©ºæ–‡å­—ã«ã™ã‚‹

        return `
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')" style="cursor:pointer; position:relative; z-index:4000;">${n.title}</span>
                    <div style="display: inline-flex; align-items: center; gap: 8px; margin-left: 10px;">
                        <span class="count-badge">${(n.content || "").length.toLocaleString()}æ–‡å­—</span>
                        ${r18Badge}
                        <div class="author-page-tags" style="display: inline-flex; gap: 5px;">
                            ${tagsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('') || "å…¬é–‹ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“";
    
    // 7. ã‚‚ã—ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã—ãŸãªã‚‰ã€å…ƒã®ã‚¨ãƒªã‚¢ã¯ç©ºã«ã™ã‚‹
    if (customArea && customArea !== worksEl) {
        worksEl.innerHTML = "";
    }
}

function closeAuthorPage() {
    document.getElementById('author-page-overlay').style.display = 'none';
    // é–‰ã˜ã‚‹ã¨ãã«CSSã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€å…ƒã®ã‚µã‚¤ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã™
    document.getElementById('user-custom-style').innerHTML = "";
}

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ï¼‰ã®ãƒªã‚»ãƒƒãƒˆ
function resetToTemplate() {
    if (confirm("å…¥åŠ›ã—ãŸå†…å®¹ã‚’æ¶ˆã—ã¦åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
        const target = document.getElementById('prof-css');
        if (target) {
            // å¤–å´ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ defaultAuthorTemplate ã‚’ä½¿ã†
            target.value = defaultAuthorTemplate;
            alert("ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åæ˜ ã—ã¾ã—ãŸã€‚");
        }
    }
}

// æ–‡ç« ç”»é¢ï¼ˆReaderï¼‰ã®ãƒªã‚»ãƒƒãƒˆ
function resetReaderDesign() {
    console.log("åˆæœŸåŒ–ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ"); 
    if (confirm("æ–‡ç« ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
        const target = document.getElementById('reader-custom-input');
        if (target) {
            // å¤–å´ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ defaultReaderTemplate ã‚’ä½¿ã†
            target.value = defaultReaderTemplate;
            alert("æ–‡ç« ç”»é¢ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åæ˜ ã—ã¾ã—ãŸã€‚");
        } else {
            console.error("å…¥åŠ›æ¬„ 'reader-custom-input' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }
    }
}
    
    function openAboutPage() {
    // 1. ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ¨™æº–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆUIï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
    const defaultUiEl = document.getElementById('reader-default-ui');
    const readerStyleEl = document.getElementById('reader-custom-style');
    if (defaultUiEl) defaultUiEl.style.display = 'block';
    if (readerStyleEl) readerStyleEl.style.display = 'none';

    // 2. ãŠæƒé™¤ï¼ˆæ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚„æ–‡å­—ã‚’æ¶ˆã™ï¼‰
    resetReaderUI(); 
    
    // 3. æ¨™æº–æ ã®IDã‚’å–å¾—ã™ã‚‹ï¼ˆã“ã“ã‚’0ä»˜ãã«å¤‰æ›´ï¼‰
    const titleEl = document.getElementById('read-title-default');
    const authorEl = document.getElementById('read-author-default');
    const bodyEl = document.getElementById('read-body-default');
    
    // 4. è¦ç´ ãŒã‚ã‚Œã°å†…å®¹ã‚’æ›¸ãæ›ãˆã‚‹
    if (titleEl) {
        titleEl.innerText = "ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦";
        titleEl.style.textDecoration = "none"; // ä¸‹ç·šãªã©ãŒã‚ã‚Œã°ãƒªã‚»ãƒƒãƒˆ
    }

    if (authorEl) {
        authorEl.innerText = ""; // æ¡ˆå†…ãƒšãƒ¼ã‚¸ãªã®ã§ä½œè€…åã¯ç©ºã«
    }

    if (bodyEl) {
        bodyEl.innerHTML = `
        <div class="about-section" style="margin-top: -100px;"> 
            <h3 style="color: #fcaf17; font-size: 1.05em; border-left: 4px solid #fcaf17; padding-left: 7px;">ã‚µã‚¤ãƒˆã®ç‰¹è‰²</h3>
            <p style="font-size: 0.95em; line-height: 1.6;">ã€€å½“ã‚µã‚¤ãƒˆã¯ã€ã‹ã¤ã¦éš†ç››ã‚’èª‡ã£ãŸã€Œå€‹äººã‚µã‚¤ãƒˆã€ã®ã‚ˆã†ãªè‡ªç”±ãªç©ºæ°—æ„Ÿã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚ä»–ã®æŠ•ç¨¿ã‚µã‚¤ãƒˆã§ã¯é›£ã—ã„ç´°ã‹ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¯èƒ½ã§ã€ã‚ãªãŸã®ä½œå“ã‚’ã‚ãªãŸã‚‰ã—ã„ç©ºé–“ã§å…¬é–‹ã§ãã‚‹ã®ãŒæœ€å¤§ã®ç‰¹å¾´ã§ã™ã€‚</p>
            
            <h3 style="color: #fcaf17; font-size: 1.05em; border-left: 4px solid #fcaf17; padding-left: 7px;">å‰µè¨­çµŒç·¯</h3>
            <p style="font-size: 0.95em; line-height: 1.6;">ã€€SNSã‚„å¤§æ‰‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ™®åŠã«ã‚ˆã‚Šã€è‡ªåˆ†ã ã‘ã®ã€ŒåŸã€ã§ã‚ã‚‹å€‹äººã‚µã‚¤ãƒˆã¯æ¿€æ¸›ã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€æµã‚Œã¦ã„ãã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§ã¯ãªãã€è‡ªåˆ†ã®ä½œå“ã‚’è‡ªåˆ†ã®å¥½ããªè‰²ã§é£¾ã‚Šã€é™ã‹ã«ç½®ã„ã¦ãŠã‘ã‚‹å ´æ‰€ãŒä»Šã“ãå¿…è¦ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚</p>
            <p style="font-size: 0.95em; line-height: 1.6;">ã€€æ•°è¡Œã®çŸ­ã„å‰µä½œæ–‡ã‹ã‚‰è¨­å®šè³‡æ–™ã€æ—¥è¨˜ä»£ã‚ã‚Šã®æ–‡ç« ã¾ã§ã€è‚©ã®åŠ›ã‚’æŠœã„ã¦è‡ªç”±ã«ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚</p>
        </div>`;
    }

    // 5. ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
    const overlay = document.getElementById('reader-overlay');
    if (overlay) {
        overlay.style.display = 'block';
        overlay.scrollTop = 0;
    }

    // ä¸è¦ãªUIã‚’éš ã™
    const interactZone = document.getElementById('reader-interactive-zone');
    if (interactZone) interactZone.classList.add('hidden');
}
    
// è¡¨ç¤ºçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã€ŒãŠæƒé™¤ã€
function resetReaderUI() {
    // ã‚«ã‚¹ã‚¿ãƒ ç”¨ã‹æ¨™æº–ç”¨ã€ã©ã¡ã‚‰ã‹ã®æœ¬æ–‡ã‚¨ãƒªã‚¢ã‚’å–å¾—
    const bodyEl = document.getElementById('read-body') || document.getElementById('read-body-default');
    const interactiveZone = document.getElementById('reader-interactive-zone');
    const nameChanger = document.getElementById('name-changer-group');

    if (interactiveZone) interactiveZone.classList.add('hidden');
    if (nameChanger) nameChanger.classList.add('hidden');

    // â˜…ã“ã“ãŒé‡è¦ï¼šbodyEl ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ classList ã‚’æ“ä½œã™ã‚‹
    if (bodyEl) {
        bodyEl.classList.remove('indent-text');
        bodyEl.classList.remove('hanging-indent');
        bodyEl.innerHTML = ""; 
    }
}
    async function deleteAccount() {
    // 1æ®µéšç›®ã®ç¢ºèª
    if (!confirm("æœ¬å½“ã«é€€ä¼šã—ã¾ã™ã‹ï¼Ÿ\næŠ•ç¨¿ã—ãŸã™ã¹ã¦ã®ä½œå“ã€ã‚³ãƒ¡ãƒ³ãƒˆã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå®Œå…¨ã«æ¶ˆå»ã•ã‚Œã¾ã™ã€‚")) return;
    
    // 2æ®µéšç›®ã®æœ€çµ‚ç¢ºèªï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰
    const confirmName = prompt("é€€ä¼šã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ã‚ãªãŸã®ä½œè€…åï¼ˆã¾ãŸã¯ã€Œé€€ä¼šã€ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    if (!confirmName) return;

    try {
        // A. ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å°èª¬ã‚’ã™ã¹ã¦å‰Šé™¤
        await api.from('novels').delete().eq('author_id', currentUser.id);
        
        // B. ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å‰Šé™¤
        await api.from('profiles').delete().eq('id', currentUser.id);
        
        // C. Supabaseã®Authã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
        // â€»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ã¯è‡ªåˆ†è‡ªèº«ã®Authå‰Šé™¤ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã¦ã‹ã‚‰ã€Œå‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã‚’å‡ºã™ã‹ã€ç®¡ç†ç”»é¢ã‹ã‚‰æ¶ˆã™é‹ç”¨ãŒä¸€èˆ¬çš„ã§ã™ãŒã€
        // ã²ã¨ã¾ãšã€Œãƒ‡ãƒ¼ã‚¿ã‚’ç©ºã«ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã§é€€ä¼šå‡¦ç†ã¨ã—ã¾ã™ã€‚
        
        alert("é€€ä¼šå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚");
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãƒˆãƒƒãƒ—ã¸
        await doLogOut();

    } catch (err) {
        console.error("é€€ä¼šã‚¨ãƒ©ãƒ¼:", err);
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
    }
}
    
    
document.addEventListener('DOMContentLoaded', () => {
    init();
});
</script>
    
</body>
</html>
