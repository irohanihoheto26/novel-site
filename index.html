<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --sidebar-width: 280px; }
        body { font-family: "Yu Gothic", "YuGothic", sans-serif; background: #fff; color: #000; margin: 0; display: flex; min-height: 100vh; }
        aside { width: var(--sidebar-width); height: 100vh; border-right: 2px solid #000; padding: 40px 20px; box-sizing: border-box; position: fixed; left: 0; top: 0; overflow-y: auto; background: #fff; display: flex; flex-direction: column; z-index: 100; }
        main { margin-left: var(--sidebar-width); flex: 1; padding: 40px; max-width: 900px; box-sizing: border-box; }
        aside h1 { font-family: 'Antonio', sans-serif; font-size: 2.2em; margin: 0 0 10px; text-transform: uppercase; cursor: pointer; }
        .rule-link { font-size: 0.85em; color: #666; text-decoration: underline; cursor: pointer; margin-bottom: 30px; display: block; }
        .search-box-side { padding: 10px; border: 1px solid #000; width: 100%; box-sizing: border-box; margin-bottom: 20px; }
        .section-header { display: flex; align-items: baseline; gap: 15px; border-bottom: 2px solid #000; margin-bottom: 20px; }
        .settings-link { font-size: 0.7em; color: #666; text-decoration: underline; cursor: pointer; }
        .profile-edit-area { background: #f9f9f9; padding: 20px; border: 1px solid #eee; margin-bottom: 30px; display: none; }
        .tab-bar { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 25px; }
        .tab-btn { background: none; border: none; color: #888; padding: 10px 0; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: #000; border-bottom: 2px solid #000; }
        .novel-row { padding: 15px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .novel-title { font-weight: bold; cursor: pointer; text-decoration: underline; }
        .count-badge { font-size: 0.75em; background: #eee; padding: 2px 6px; border-radius: 4px; color: #444; margin-right: 5px; }
        #editor-overlay, #reader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; overflow-y: auto; }
        .overlay-content { max-width: 700px; margin: 40px auto; padding: 20px; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; }
        button { background: #000; color: #fff; border: none; padding: 12px; cursor: pointer; width: 100%; margin-bottom: 5px; }
        .btn-outline { background: #fff; color: #000; border: 1px solid #000; }
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.9em; }
        .hidden { display: none !important; }
        .novel-stats { font-size: 0.85em; color: #888; margin-left: 10px; display: inline-flex; gap: 8px; }
        .stat-item { display: inline-flex; align-items: center; gap: 3px; }
        .sticky-close { position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 10px 0; z-index: 2100; border-bottom: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 8px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #000; }
        #r18-check:checked + .slider { background-color: #d00; }
        input:checked + .slider:before { transform: translateX(20px); }
        .checkbox-group { display: flex; gap: 25px; margin-bottom: 20px; align-items: center; }
        .checkbox-group label { display: flex; align-items: center; font-size: 0.9em; font-weight: bold; cursor: pointer; }
        /* ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®è¨­å®šï¼ˆç”»é¢å¹…ãŒ800pxä»¥ä¸‹ã®å ´åˆï¼‰ */
@media screen and (max-width: 800px) {
    body {
        flex-direction: column;
    }

    aside {
        width: 100%;
        height: auto; /* é«˜ã•ã‚’å†…å®¹ã«åˆã‚ã›ã‚‹ */
        position: static; /* å›ºå®šã‚’å®Œå…¨ã«è§£é™¤ */
        border-right: none;
        border-bottom: 2px solid #000;
        padding: 15px;
        z-index: 10;
    }

    main {
        margin-left: 0;
        padding: 15px;
        width: 100%;
        box-sizing: border-box; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    }

    /* ãƒœã‚¿ãƒ³ãŒç¸¦ã«ä¸¦ã³ã™ãã‚‹ã¨å ´æ‰€ã‚’å–ã‚‹ã®ã§ã€æ¨ªä¸¦ã³ã«èª¿æ•´ */
    #logged-in-nav {
        display: flex;
        gap: 10px;
    }
    
    #logged-in-nav button {
        flex: 1;
        padding: 8px;
        font-size: 0.9em;
    }
}
        /* ä¸‹æ›¸ããƒ©ãƒ™ãƒ«ã®æ–°ã—ã„ãƒ‡ã‚¶ã‚¤ãƒ³ */
.draft-badge {
    background-color: #e0f2ff; /* æ°´è‰² */
    color: #004080;           /* æ¿ƒã„é’æ–‡å­—ï¼ˆèª­ã¿ã‚„ã™ã•é‡è¦–ï¼‰ */
    font-size: 0.75em;
    font-weight: bold;
    padding: 3px 10px;
    border-radius: 15px;      /* è§’ä¸¸ */
    margin-left: 8px;
    display: inline-block;
    vertical-align: middle;
}

/* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-delete {
    cursor: pointer;
    color: #cc0000;
    font-size: 0.8em;
    margin-left: 10px;
    text-decoration: underline;
}
.btn-delete:hover {
    color: #ff0000;
}
        /* æœ¬æ–‡ã®1è¡Œç›®ã‚’1æ–‡å­—åˆ†ç©ºã‘ã‚‹è¨­å®š */
.indent-text {
    text-indent: 1em;
}
        /* ç®‡æ¡æ›¸ãç”¨ï¼š2è¡Œç›®ä»¥é™ã‚‚1å­—ä¸‹ã’ãŸä½ç½®ã«æƒãˆã‚‹ */
.hanging-indent {
    padding-left: 1em;   /* å…¨ä½“ã‚’1æ–‡å­—åˆ†å³ã«å¯„ã›ã‚‹ */
    text-indent: -1em;  /* 1è¡Œç›®ã ã‘ã‚’1æ–‡å­—åˆ†å·¦ã«æˆ»ã™ */
    margin-bottom: 1em; /* æ®µè½ã”ã¨ã®éš™é–“ */
}
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filter-bar select { padding: 5px; border: 1px solid #000; font-family: inherit; }
    .tag-link { 
        display: inline-block; background: #f0f0f0; color: #333; padding: 2px 8px; 
        border-radius: 4px; font-size: 0.75em; cursor: pointer; margin-right: 5px; 
    }
    .tag-link:hover { background: #000; color: #fff; }
    #word-count-display { font-size: 0.8em; color: #666; text-align: right; margin-bottom: 10px; }

    </style>
</head>
<body>

<aside>
    <h1 onclick="location.reload()">Fragment Library</h1>
    <span class="rule-link" onclick="openRules()">å¿…ãšãŠèª­ã¿ãã ã•ã„ï¼ˆå¿…èª­ï¼‰</span>
    <input type="text" id="search-input" class="search-box-side" placeholder="æ¤œç´¢..." oninput="getList()">
    <div id="logged-in-nav" class="hidden">
        <button onclick="openEditor()">æ–°è¦æŠ•ç¨¿</button>
        <button class="btn-outline" onclick="doLogOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div id="guest-nav">
        <button onclick="toggleAuthForm()">ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²</button>
    </div>
</aside>

<main>
    <section id="auth-form" class="hidden" style="border:2px solid #000; padding:20px; margin-bottom:40px;">
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button onclick="doLogIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button onclick="doSignUp()" class="btn-outline">æ–°è¦ç™»éŒ²</button>
    </section>

    <div id="user-page" class="hidden">
        <div class="section-header"><h2>ãƒã‚¤ãƒšãƒ¼ã‚¸</h2><span class="settings-link" onclick="toggleSettings()">[è¨­å®š]</span></div>
        <div id="profile-edit-area" class="profile-edit-area">
            <input type="text" id="prof-name" placeholder="ä½œè€…å">
            <textarea id="prof-bio" placeholder="è‡ªå·±ç´¹ä»‹" rows="3"></textarea>
            <button class="btn-outline" onclick="saveProfile()" style="width:auto">æ›´æ–°</button>
        </div>
        <h3>æŠ•ç¨¿ã—ãŸä½œå“</h3>
        <div id="my-works-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="section-header"><h2>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h2></div>
    <div class="filter-bar">
    <select id="sort-order" onchange="getList()">
        <option value="created_at">æœ€æ–°é †</option>
        <option value="likes">ã„ã„ã­é †</option>
        <option value="char_count">æ–‡å­—æ•°é †</option>
    </select>
</div>
    <div class="tab-bar">
        <button id="tab-all" class="tab-btn active" onclick="switchTab('all')">ã™ã¹ã¦</button>
        <button id="tab-follow" class="tab-btn" onclick="switchTab('follow')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
        <button id="tab-liked" class="tab-btn" onclick="switchTab('liked')">ã„ã„ã­æ¸ˆã¿</button>
    </div>
    <div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>
</main>

<div id="reader-overlay">
    <div class="overlay-content">
        <div class="sticky-close">
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 0 15px;">
                <button class="btn-outline" onclick="closeReader()" style="width:auto; margin:0;">â† é–‰ã˜ã‚‹</button>
                <div id="name-changer-group" style="display: flex; align-items: center; gap: 5px; flex-grow: 1; justify-content: flex-end;">
                    <input type="text" id="target-string" placeholder="å¤‰æ›å‰" style="width: 80px; margin: 0; padding: 5px; font-size: 0.8em;">
                    <span>â†’</span>
                    <input type="text" id="new-name" placeholder="å¤‰æ›å¾Œ" style="width: 80px; margin: 0; padding: 5px; font-size: 0.8em;">
                    <button onclick="applyNameChange()" style="width: auto; padding: 5px 15px; margin: 0; font-size: 0.8em;">å¤‰æ›</button>
                </div>
            </div>
        </div>
        <h2 id="read-title"></h2>
        <div id="read-author" style="text-align: right; font-weight: bold;"></div>
        <div id="read-body" style="white-space: pre-wrap; line-height: 2.2; margin: 40px 0;"></div>
        <div id="reader-interactive-zone" style="border-top: 1px solid #000; padding-top: 20px; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <button id="like-btn" onclick="toggleLike()" style="width:auto; padding: 10px 40px;">â™¥ ã„ã„ã­ <span id="read-like-count">0</span></button>
                <span id="author-link-zone" style="font-size: 0.9em; color: #666;"></span>
            </div>
            <div style="text-align: left;">
                <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                <div id="comment-list"></div>
                <div id="comment-form-area" class="hidden" style="margin-top: 20px;">
                    <textarea id="comment-input" placeholder="æ„Ÿæƒ³ã‚’æ›¸ã..." rows="3"></textarea>
                    <button onclick="postComment()" class="btn-outline" style="width:auto">ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡</button>
                </div>
                <div id="comment-guest-msg" class="hidden" style="margin-top: 20px; padding: 20px; background: #f9f9f9; text-align: center;">
                    <p>ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                </div>
            </div>
        </div>
    </div>
</div>



<div id="editor-overlay">
    <div class="overlay-content">
        <h2>æ–°è¦æŠ•ç¨¿</h2>
        <input type="text" id="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <input type="text" id="tags-input" placeholder="ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)">
        <textarea id="caption-input" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚ã‚‰ã™ã˜ç­‰ï¼‰" rows="3"></textarea>
        <div class="checkbox-group">
            <label><span class="switch"><input type="checkbox" id="r18-check"><span class="slider"></span></span>R-18</label>
            <label><span class="switch"><input type="checkbox" id="private-check"><span class="slider"></span></span>éå…¬é–‹(ä¸‹æ›¸ã)</label>
        </div>
        <textarea id="content-input" rows="20" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
        <div id="word-count-display">æ–‡å­—æ•°: <span id="current-count">0</span></div>
        <button onclick="doPost()">å…¬é–‹ï¼ä¿å­˜ã™ã‚‹</button>
        <button onclick="closeEditor()" class="btn-outline">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);
    let currentUser = null, userProfile = null, currentTab = 'all', currentReadingId = null;
    let editingNovelId = null, allMyNovels = [], originalContent = "";

    async function init() {
        const { data: { user } } = await api.auth.getUser();
        currentUser = user;
        if (user) {
            document.getElementById('logged-in-nav').classList.remove('hidden');
            document.getElementById('guest-nav').classList.add('hidden');
            document.getElementById('user-page').classList.remove('hidden');
            await loadProfile();
            loadUserContent();
        }
        getList();
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
        const contentInput = document.getElementById('content-input');
        if(contentInput) {
            contentInput.addEventListener('input', (e) => {
                const count = e.target.value.length;
                document.getElementById('current-count').innerText = count.toLocaleString();
            });
        }
    }

    async function loadProfile() {
        const { data } = await api.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
        userProfile = data;
        if(data) document.getElementById('prof-name').value = data.display_name || "";
    }

    async function getList() {
        try {
            let query = api.from('novels').select('*').eq('is_private', false);
            if (currentUser) query = query.neq('author_id', currentUser.id);

            let { data: novels, error } = await query.order('created_at', {ascending: false});
            if (error) throw error;

            let baseNovels = novels || [];

            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆä½“
            const novelsWithStats = await Promise.all(baseNovels.map(async (n) => {
                const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                return { 
                    ...n, 
                    like_count: lCount || 0, 
                    comment_count: cCount || 0, 
                    char_count: (n.content || "").length 
                };
            }));

            // ä¸¦ã¹æ›¿ãˆ
            const sortType = document.getElementById('sort-order').value;
            if (sortType === 'likes') {
                novelsWithStats.sort((a, b) => b.like_count - a.like_count);
            } else if (sortType === 'char_count') {
                novelsWithStats.sort((a, b) => b.char_count - a.char_count);
            }

            // æ¤œç´¢ã¨ã‚¿ãƒ–ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const sw = document.getElementById('search-input').value.toLowerCase();
            let filtered = novelsWithStats;
            
            if (currentTab === 'liked' && currentUser) {
                const { data: myLikes } = await api.from('likes').select('novel_id').eq('user_id', currentUser.id);
                const likedIds = (myLikes || []).map(l => l.novel_id);
                filtered = filtered.filter(n => likedIds.includes(n.id));
            }

            if (sw) {
                filtered = filtered.filter(n => 
                    n.title.toLowerCase().includes(sw) || 
                    n.author_name.toLowerCase().includes(sw) ||
                    (n.tags && n.tags.some(t => t.toLowerCase().includes(sw)))
                );
            }

            document.getElementById('list').innerHTML = filtered.map(n => `
                <div class="novel-row">
                    <div class="novel-info">
                        <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                        <span style="font-size:0.8em; color:#888;"> / ${n.author_name}</span>
                        <div style="margin-top:5px;">
                            ${(n.tags || []).map(t => `<span class="tag-link" onclick="setSearchTag('${t}')">#${t}</span>`).join('')}
                        </div>
                    </div>
                    <div class="novel-stats">
                        <span class="count-badge">${n.char_count.toLocaleString()}æ–‡å­—</span>
                        <span class="stat-item">â™¥ ${n.like_count}</span>
                        <span class="stat-item">ğŸ’¬ ${n.comment_count}</span>
                    </div>
                </div>`).join('') || "ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“";
        } catch (e) {
            console.error(e);
        }
    }

    function setSearchTag(tagName) {
        document.getElementById('search-input').value = tagName;
        getList();
    }

    async function loadUserContent() {
        if (!currentUser) return;
        let { data: novels } = await api.from('novels').select('*').eq('author_id', currentUser.id).order('created_at', {ascending: false});
        allMyNovels = novels || [];

        document.getElementById('my-works-list').innerHTML = allMyNovels.map(n => `
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    <span onclick="openEditor('${n.id}')" style="cursor:pointer; color:blue; font-size:0.8em; margin-left:10px;">[ç·¨é›†]</span>
                    <span onclick="deleteNovel('${n.id}', '${n.title}')" class="btn-delete">[å‰Šé™¤]</span>
                    <span class="count-badge">${(n.content || "").length.toLocaleString()}æ–‡å­—</span>
                    ${n.is_private ? '<span class="draft-badge">ä¸‹æ›¸ã</span>' : ''}
                </div>
                <div class="novel-stats" id="my-stats-${n.id}">â™¥ - ğŸ’¬ -</div>
            </div>`).join('') || "ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“";
        
        allMyNovels.forEach(async (n) => {
            const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            const el = document.getElementById(`my-stats-${n.id}`);
            if(el) el.innerHTML = `<span class="stat-item">â™¥ ${lCount||0}</span> <span class="stat-item">ğŸ’¬ ${cCount||0}</span>`;
        });
    }

    function openEditor(id = null) {
        editingNovelId = id;
        if (id) {
            const n = allMyNovels.find(x => String(x.id) === String(id));
            if (!n) return;
            document.getElementById('title-input').value = n.title || "";
            document.getElementById('tags-input').value = (n.tags || []).join(', ');
            document.getElementById('caption-input').value = n.caption || "";
            document.getElementById('content-input').value = n.content || "";
            document.getElementById('r18-check').checked = !!n.is_r18;
            document.getElementById('private-check').checked = !!n.is_private;
            document.getElementById('current-count').innerText = (n.content || "").length.toLocaleString();
            document.querySelector('#editor-overlay h2').innerText = "ä½œå“ã‚’ç·¨é›†";
        } else {
            document.getElementById('title-input').value = "";
            document.getElementById('tags-input').value = "";
            document.getElementById('caption-input').value = "";
            document.getElementById('content-input').value = "";
            document.getElementById('r18-check').checked = false;
            document.getElementById('private-check').checked = false;
            document.getElementById('current-count').innerText = "0";
            document.querySelector('#editor-overlay h2').innerText = "æ–°è¦æŠ•ç¨¿";
        }
        document.getElementById('editor-overlay').style.display = 'block';
    }

    async function openReader(id) {
        currentReadingId = id;
        const bodyEl = document.getElementById('read-body');
        const titleEl = document.getElementById('read-title');
        const nameGroup = document.getElementById('name-changer-group');

        titleEl.style.textDecoration = "none";
        bodyEl.classList.remove('hanging-indent');
        bodyEl.classList.add('indent-text');
        if (nameGroup) nameGroup.classList.remove('hidden');

        const { data: n } = await api.from('novels').select('*').eq('id', id).single();
        if(!n) return;

        originalContent = n.content;
        titleEl.innerText = n.title;
        document.getElementById('read-author').innerText = n.author_name;
        bodyEl.innerText = n.content; 

        document.getElementById('author-link-zone').innerHTML = 
            `ä½œè€…: <strong onclick="filterByAuthor('${n.author_name}')" style="cursor:pointer; text-decoration:underline; color:#000;">${n.author_name}</strong>`;

        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-interactive-zone').classList.remove('hidden');
        loadComments(id);
        loadLikeCount(id);
    }

    function applyNameChange() {
        const target = document.getElementById('target-string').value;
        const replacement = document.getElementById('new-name').value;
        if (!target) return alert("å¤‰æ›å‰ã®æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        const escapedTarget = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedTarget, 'g');
        document.getElementById('read-body').innerText = originalContent.replace(regex, replacement || "");
    }

    async function loadComments(id) {
        // ã‚³ãƒ¡ãƒ³ãƒˆã¨ä¸€ç·’ã«ã€æŠ•ç¨¿è€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã® display_name ã‚’å–å¾—ã™ã‚‹
        const { data, error } = await api
            .from('comments')
            .select('id, body, user_id, created_at, profiles(display_name)')
            .eq('novel_id', id)
            .order('created_at', {ascending: true});

        if (error) {
            console.error("ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error.message);
            return;
        }

        document.getElementById('comment-list').innerHTML = (data || []).map(c => {
            const isMine = currentUser && c.user_id === currentUser.id;
            // profilesã‹ã‚‰åå‰ã‚’å–å¾—ï¼ˆè¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€Œåç„¡ã—ã€ï¼‰
            const name = (c.profiles && c.profiles.display_name) ? c.profiles.display_name : "åç„¡ã—";
            
            const manageBtns = isMine ? `
                <span onclick="deleteComment('${c.id}')" 
                      style="cursor:pointer; color:red; font-size:0.8em; margin-left:5px;">
                      [å‰Šé™¤]
                </span>` : '';

            return `
                <div class="comment-item">
                    <strong>${name}</strong>: ${c.body} ${manageBtns}
                </div>`;
        }).join('') || "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“";
    }

    async function postComment() {
        const b = document.getElementById('comment-input').value.trim();
        if(!b || !currentUser) return;

        // user_name ã«ã¯ä»Šã®è¡¨ç¤ºåã‚’å…¥ã‚Œã‚‹
        const displayName = userProfile?.display_name || currentUser.email.split('@')[0];

        const { error } = await api.from('comments').insert({ 
            novel_id: currentReadingId, 
            user_id: currentUser.id, 
            user_name: displayName, 
            body: b 
        });

        if (error) {
            console.error("ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:", error.message);
            alert("ã‚³ãƒ¡ãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        } else {
            document.getElementById('comment-input').value = "";
            loadComments(currentReadingId);
        }
    }

    async function toggleLike() {
        if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");

        // 1. ã™ã§ã«ã„ã„ã­ã—ã¦ã„ã‚‹ã‹ç¢ºèª
        const { data: existingLike, error: checkError } = await api
            .from('likes')
            .select('*')
            .eq('novel_id', currentReadingId)
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (checkError) {
            console.error("ã„ã„ã­ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:", checkError.message);
            return;
        }

        if (existingLike) {
            // 2. ã™ã§ã«ã„ã„ã­æ¸ˆã¿ãªã‚‰ã€å–ã‚Šæ¶ˆã™ï¼ˆã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨æ¶ˆãˆã‚‹ä»•æ§˜ï¼‰
            await api.from('likes').delete().eq('id', existingLike.id);
        } else {
            // 3. ã¾ã ãªã‚‰ã€ã„ã„ã­ã‚’è¿½åŠ 
            const { error: insertError } = await api.from('likes').insert({ 
                novel_id: currentReadingId, 
                user_id: currentUser.id 
            });
            if (insertError) {
                console.error("ã„ã„ã­ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", insertError.message);
                alert("ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            }
        }

        // 4. ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        loadLikeCount(currentReadingId);
    }

    async function loadLikeCount(id) {
        // å…¨ä½“ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
        const { count } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', id);
        document.getElementById('read-like-count').innerText = count || 0;

        // è‡ªåˆ†ãŒã„ã„ã­æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰ãˆã‚‹
        const likeBtn = document.getElementById('like-btn');
        if (currentUser) {
            const { data } = await api.from('likes')
                .select('*')
                .eq('novel_id', id)
                .eq('user_id', currentUser.id)
                .maybeSingle();

            if (data) {
                likeBtn.style.background = "#ff4d4d"; // ã„ã„ã­æ¸ˆã¿ã¯èµ¤ã
                likeBtn.style.color = "#fff";
                likeBtn.innerText = "â™¥ ã„ã„ã­æ¸ˆã¿ " + (count || 0);
            } else {
                likeBtn.style.background = "#fff"; // æœªã„ã„ã­ã¯ç™½ï¼ˆæ ã‚ã‚Šï¼‰
                likeBtn.style.color = "#000";
                likeBtn.innerText = "â™¥ ã„ã„ã­ " + (count || 0);
            }
        }
    }

    async function doPost() {
        const payload = {
            title: document.getElementById('title-input').value,
            content: document.getElementById('content-input').value,
            caption: document.getElementById('caption-input').value,
            tags: document.getElementById('tags-input').value.split(',').map(t => t.trim()).filter(t => t),
            is_r18: document.getElementById('r18-check').checked,
            is_private: document.getElementById('private-check').checked,
            author_id: currentUser.id,
            author_name: userProfile?.display_name || "åç„¡ã—"
        };
        const { error } = editingNovelId ? await api.from('novels').update(payload).eq('id', editingNovelId) : await api.from('novels').insert(payload);
        if(error) alert(error.message); else location.reload();
    }

    async function deleteNovel(id, title) {
        if (!confirm(`ä½œå“ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await api.from('novels').delete().eq('id', id);
        location.reload();
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t));
        getList();
    }

    function openRules() {
        const bodyEl = document.getElementById('read-body');
        const titleEl = document.getElementById('read-title');
        titleEl.innerText = "å¿…ãšãŠèª­ã¿ãã ã•ã„ï¼ˆå¿…èª­ï¼‰";
        titleEl.style.textDecoration = "underline";
        titleEl.style.textUnderlineOffset = "10px";
        document.getElementById('read-author').innerText = "é‹å–¶";
        bodyEl.classList.remove('indent-text');
        bodyEl.classList.add('hanging-indent');
        document.getElementById('name-changer-group').classList.add('hidden');
        bodyEl.innerText = `ã€€å½“ã‚µã‚¤ãƒˆã¯å€‹äººã«ã‚ˆã‚‹äºŒæ¬¡å‰µä½œå°èª¬ã®å±•ç¤ºãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ç›®çš„ã¨ã—ãŸå°‚ç”¨ã‚µã‚¤ãƒˆã§ã™ã€‚

ãƒ»æ¤œç´¢é¿ã‘ã®ãŸã‚ã€åŸä½œåãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’ãã®ã¾ã¾ãƒ•ãƒ«ãƒãƒ¼ãƒ ã§è¡¨ç¤ºã™ã‚‹ã“ã¨ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
ãƒ»å…¬åºè‰¯ä¿—ã«åã™ã‚‹å†…å®¹ã®æŠ•ç¨¿ã€ç„¡æ–­è»¢è¼‰ã¯å›ºãç¦æ­¢ã„ãŸã—ã¾ã™ã€‚
ãƒ»RæŒ‡å®šãŒå¿…è¦ãªå ´åˆã¯å¿…ãšè¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

ã€€ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦ã€å‰µä½œæ´»å‹•ã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ã€‚`;
        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-interactive-zone').classList.add('hidden');
    }

    function toggleSettings() { const s = document.getElementById('profile-edit-area'); s.style.display = s.style.display==='block'?'none':'block'; }
    function closeReader() { document.getElementById('reader-overlay').style.display = 'none'; }
    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    async function doLogOut() { await api.auth.signOut(); location.href = "./"; }
    function toggleAuthForm() { document.getElementById('auth-form').classList.toggle('hidden'); }
    async function doLogIn() { await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); location.reload(); }
    async function doSignUp() { const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if(error) alert(error.message); else alert("ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
    async function saveProfile() {
        await api.from('profiles').upsert({ id: currentUser.id, display_name: document.getElementById('prof-name').value, bio: document.getElementById('prof-bio').value });
        location.reload();
    }
    function filterByAuthor(name) {
        document.getElementById('search-input').value = name;
        closeReader();
        switchTab('all');
        getList();
    }

    init();
</script>
</body>
</html>
