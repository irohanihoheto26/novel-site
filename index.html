<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Yu Gothic", sans-serif; background: #fff; color: #000; margin: 0; line-height: 1.8; }
        header { padding: 40px 20px; text-align: center; border-bottom: 1px solid #000; }
        header h1 { font-family: 'Antonio', sans-serif; font-size: 3em; margin: 0; }
        .container { max-width: 700px; margin: 0 auto; padding: 20px 20px 100px; }
        
        /* 一覧のコンパクト化 */
        .novel-card { padding: 15px 0; border-bottom: 1px solid #eee; }
        .novel-card h3 { margin: 0; font-size: 1.2em; cursor: pointer; display: inline-block; text-decoration: underline; }
        .author-info { font-size: 0.75em; color: #888; margin-left: 10px; }
        .caption-mini { font-size: 0.85em; color: #555; margin-top: 5px; }

        /* 読書モード（別ページ風オーバーレイ） */
        #reader-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; z-index: 1000; overflow-y: auto; 
        }
        .reader-content { max-width: 600px; margin: 40px auto; padding: 40px 20px; }
        .back-btn { cursor: pointer; font-size: 0.9em; text-decoration: underline; margin-bottom: 20px; display: inline-block; }

        section { border: 1px solid #000; padding: 20px; margin-bottom: 30px; font-size: 0.9em; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #000; box-sizing: border-box; }
        button { background: #000; color: #fff; border: 1px solid #000; padding: 8px 20px; cursor: pointer; }
        .text-btn { background: none; color: #000; border: none; text-decoration: underline; padding: 0; font-size: 0.8em; cursor: pointer; margin-left: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="reader-overlay">
    <div class="reader-content">
        <span class="back-btn" onclick="closeReader()">← Back to Library</span>
        <h2 id="read-title" style="font-size: 2em; margin: 20px 0;"></h2>
        <p id="read-author" style="border-bottom: 1px solid #000; padding-bottom: 10px;"></p>
        <div id="read-body" style="white-space: pre-wrap; font-size: 1.1em; letter-spacing: 0.05em;"></div>
    </div>
</div>

<header><h1>Fragment Library</h1></header>

<div class="container" id="main-content">
    <div id="auth-status" style="text-align:right; font-size:0.75em; margin-bottom:10px;">Checking library...</div>

    <section id="auth-form" class="hidden">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogIn()">Login</button>
        <button onclick="doSignUp()" class="text-btn">Register</button>
    </section>

    <section id="post-form" class="hidden">
        <div style="font-size:0.8em; background:#f9f9f9; padding:10px; border:1px dashed #000; margin-bottom:15px;">
            <strong>Your Archive</strong>
            <div id="my-list"></div>
        </div>
        <input type="hidden" id="edit-id">
        <input type="text" id="title" placeholder="Title">
        <input type="text" id="author" placeholder="Author">
        <textarea id="caption" placeholder="Caption" rows="2"></textarea>
        <textarea id="content" placeholder="Content" rows="8"></textarea>
        <button id="submit-btn" onclick="doPost()">Archive</button>
        <button onclick="location.reload()" class="text-btn">Cancel</button>
        <button onclick="doLogOut()" class="text-btn" style="float:right">Logout</button>
    </section>

    <div id="list">Loading Fragments...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);
    let currentUser = null;

    async function init() {
        try {
            const { data: { user } } = await api.auth.getUser();
            currentUser = user;
            document.getElementById('auth-status').innerText = user ? `Member: ${user.email}` : "Guest Mode";
            document.getElementById('auth-form').classList.toggle('hidden', !!user);
            document.getElementById('post-form').classList.toggle('hidden', !user);
            if (user) getMyList();
            getList();
        } catch(e) { console.error(e); }
    }

    async function doPost() {
        const id = document.getElementById('edit-id').value;
        const payload = {
            title: document.getElementById('title').value,
            author_name: document.getElementById('author').value,
            caption: document.getElementById('caption').value,
            content: document.getElementById('content').value,
            author_id: currentUser.id
        };
        const { error } = id ? await api.from('novels').update(payload).eq('id', id) : await api.from('novels').insert([payload]);
        if (error) alert(error.message); else location.reload();
    }

    async function getMyList() {
        const { data } = await api.from('novels').select('id, title').eq('author_id', currentUser.id);
        if (!data) return;
        document.getElementById('my-list').innerHTML = data.map(n => `
            <div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee;">
                <span>${n.title}</span>
                <div>
                    <button class="text-btn" onclick="editNovel('${n.id}')">Edit</button>
                    <button class="text-btn" onclick="deleteNovel('${n.id}')" style="color:red">Del</button>
                </div>
            </div>
        `).join('') || 'None';
    }

    async function getList() {
        const { data: novels } = await api.from('novels').select('*').order('created_at', { ascending: false });
        const { data: likes } = await api.from('likes').select('novel_id');
        if (!novels) return;
        document.getElementById('list').innerHTML = novels.map(n => {
            const lCount = likes ? likes.filter(l => l.novel_id === n.id).length : 0;
            return `
                <div class="novel-card">
                    <h3 onclick="openReader('${n.id}')">${n.title}</h3>
                    <span class="author-info">by ${n.author_name}</span>
                    <div class="caption-mini">${n.caption || ''}</div>
                    <button style="background:none; border:none; color:#e0245e; cursor:pointer;" onclick="addLike('${n.id}')">♥ ${lCount}</button>
                    <button class="text-btn" style="font-size:0.7em" onclick="addFav('${n.author_id}')">Follow</button>
                </div>
            `;
        }).join('');
    }

    async function openReader(id) {
        const { data, error } = await api.from('novels').select('*').eq('id', id).single();
        if (error) return;
        document.getElementById('read-title').innerText = data.title;
        document.getElementById('read-author').innerText = 'by ' + data.author_name;
        document.getElementById('read-body').innerText = data.content;
        document.getElementById('reader-overlay').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function closeReader() { document.getElementById('reader-overlay').style.display = 'none'; }

    async function editNovel(id) {
        const { data } = await api.from('novels').select('*').eq('id', id).single();
        if (!data) return;
        document.getElementById('edit-id').value = data.id;
        document.getElementById('title').value = data.title;
        document.getElementById('author').value = data.author_name;
        document.getElementById('caption').value = data.caption || '';
        document.getElementById('content').value = data.content;
        document.getElementById('submit-btn').innerText = "Update Fragment";
        window.scrollTo(0,0);
    }

    async function deleteNovel(id) {
        if(confirm('Delete this?')) {
            const { error } = await api.from('novels').delete().eq('id', id);
            if (error) alert(error.message); else location.reload();
        }
    }

    async function addLike(nid) {
        if (!currentUser) return alert("Please Login");
        const { error } = await api.from('likes').insert([{ novel_id: nid, user_id: currentUser.id }]);
        if (error) alert("Already liked"); else getList();
    }

    async function addFav(aid) {
        if (!currentUser) return alert("Please Login");
        const { error } = await api.from('favorites').insert([{ author_id: aid, user_id: currentUser.id }]);
        if (error) alert("Already followed"); else alert("Followed");
    }

    async function doSignUp() { const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) alert(error.message); else alert("OK"); }
    async function doLogIn() { const { error } = await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) alert(error.message); else location.reload(); }
    async function doLogOut() { await api.auth.signOut(); location.reload(); }

    init();
</script>
</body>
</html>
