<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <title>小説サイト</title>
    <style>
        body{font-family:sans-serif;max-width:800px;margin:0 auto;padding:20px;background:#f9f9f9}
        section{background:white;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
        input,textarea{width:100%;margin-bottom:10px;padding:10px;box-sizing:border-box}
        button{background:#333;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer}
        #auth-status{text-align:right;color:#666;font-size:0.9em}
    </style>
</head>
<body>
    <div id="auth-status">通信中...</div>
    <section id="auth-form">
        <h2>ログイン / 新規登録</h2>
        <input type="email" id="email" placeholder="メールアドレス">
        <input type="password" id="password" placeholder="パスワード(6文字以上)">
        <button onclick="doSignUp()">新規登録</button>
        <button onclick="doLogIn()">ログイン</button>
    </section>
    <section id="post-form" style="display:none">
        <h2>小説を投稿する</h2>
        <input type="text" id="title" placeholder="タイトル">
        <input type="text" id="author" placeholder="作者名">
        <textarea id="content" placeholder="本文" rows="10"></textarea>
        <button onclick="doPost()">投稿する</button>
        <button onclick="doLogOut()" style="background:#ccc;color:#000">ログアウト</button>
    </section>
    <section><h2>作品一覧</h2><div id="list">読み込み中...</div></section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 変数名を 'api' にして衝突を完全回避
        const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
        const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
        const api = window.supabase.createClient(u, k);

        async function check() {
            const { data: { user } } = await api.auth.getUser();
            document.getElementById('auth-form').style.display = user ? 'none' : 'block';
            document.getElementById('post-form').style.display = user ? 'block' : 'none';
            document.getElementById('auth-status').innerText = user ? 'ログイン中: ' + user.email : '未ログイン';
        }
        async function doSignUp() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            const { error } = await api.auth.signUp({ email: e, password: p });
            if (error) alert(error.message); else alert("登録成功！");
        }
        async function doLogIn() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            const { error } = await api.auth.signInWithPassword({ email: e, password: p });
            if (error) alert(error.message); else location.reload();
        }
        async function doLogOut() { await api.auth.signOut(); location.reload(); }
        async function doPost() {
            const t = document.getElementById('title').value;
            const a = document.getElementById('author').value;
            const c = document.getElementById('content').value;
            const { data: { user } } = await api.auth.getUser();
            const { error } = await api.from('novels').insert([{ title: t, author_name: a, content: c, author_id: user.id }]);
            if (error) alert(error.message); else { alert("投稿成功！"); location.reload(); }
        }
        async function getList() {
            const { data } = await api.from('novels').select('*').order('created_at', { ascending: false });
            document.getElementById('list').innerHTML = data?.length > 0 ? data.map(n => `<div style="border-bottom:1px solid #eee"><h3>${n.title}</h3><p><small>${n.author_name}</small></p><p>${n.content}</p></div>`).join('') : "投稿はありません。";
        }
        check(); getList();
    </script>
</body>
</html>
