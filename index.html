<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Yu Gothic", "YuGothic", sans-serif; background: #fff; color: #000; margin: 0; line-height: 1.6; }
        header { padding: 40px 20px; text-align: center; border-bottom: 1px solid #000; }
        header h1 { font-family: 'Antonio', sans-serif; font-size: 3em; margin: 0; text-transform: uppercase; }
        
        .container { max-width: 700px; margin: 0 auto; padding: 20px 20px 100px; }
        #auth-status { text-align: right; font-size: 0.75em; margin-bottom: 10px; color: #666; }

        /* 入力フォーム（コンパクト化） */
        section { border: 1px solid #000; padding: 20px; margin-bottom: 30px; font-size: 0.9em; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #000; box-sizing: border-box; font-family: inherit; }
        button { background: #000; color: #fff; border: 1px solid #000; padding: 8px 20px; cursor: pointer; font-size: 0.9em; }
        .text-btn { background: none; color: #000; border: none; text-decoration: underline; padding: 0; font-size: 0.8em; cursor: pointer; margin-left: 10px; }

        /* 作品管理リスト */
        .my-works { font-size: 0.8em; background: #f9f9f9; padding: 10px; border: 1px dashed #000; margin-bottom: 15px; }
        .work-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }

        /* 小説一覧（超コンパクト） */
        .novel-card { padding: 15px 0; border-bottom: 1px solid #eee; }
        .novel-card h3 { margin: 0; font-size: 1.2em; cursor: pointer; display: inline-block; }
        .novel-card h3:hover { text-decoration: underline; }
        .author-info { font-size: 0.75em; color: #888; display: inline-block; margin-left: 10px; }
        .caption-mini { font-size: 0.85em; color: #555; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .heart { background: none; color: #e0245e; border: none; padding: 0; font-size: 0.9em; cursor: pointer; margin-top: 5px; }

        /* 読書専用オーバーレイ（別ページ風） */
        #reader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; overflow-y: auto; }
        .reader-content { max-width: 600px; margin: 60px auto; padding: 20px; line-height: 2; }
        .reader-close { position: fixed; top: 20px; right: 20px; font-size: 1.5em; cursor: pointer; background: #000; color: #fff; width: 40px; height: 40px; text-align: center; line-height: 40px; border-radius: 50%; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="reader-overlay">
    <div class="reader-close" onclick="closeReader()">×</div>
    <div class="reader-content">
        <h2 id="read-title" style="font-size: 2em; border-bottom: 1px solid #000; padding-bottom: 10px;"></h2>
        <p id="read-author" style="text-align: right; color: #666;"></p>
        <div id="read-body" style="white-space: pre-wrap; margin-top: 40px;"></div>
    </div>
</div>

<header>
    <h1>Fragment Library</h1>
</header>

<div class="container">
    <div id="auth-status">Loading...</div>

    <section id="auth-form" class="hidden">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogIn()">Login</button>
        <button onclick="doSignUp()" class="text-btn">Register</button>
    </section>

    <section id="post-form" class="hidden">
        <div class="my-works">
            <strong>Your Archive</strong>
            <div id="my-list"></div>
        </div>
        <input type="hidden" id="edit-id">
        <input type="text" id="title" placeholder="Title">
        <input type="text" id="author" placeholder="Author">
        <textarea id="caption" placeholder="Caption" rows="2"></textarea>
        <textarea id="content" placeholder="Content" rows="8"></textarea>
        <button id="submit-btn" onclick="doPost()">Archive</button>
        <button onclick="cancelEdit()" class="text-btn">Cancel</button>
        <button onclick="doLogOut()" class="text-btn" style="float:right">Logout</button>
    </section>

    <div id="list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);
    let currentUser = null;

    async function init() {
        const { data: { user } } = await api.auth.getUser();
        currentUser = user;
        document.getElementById('auth-status').innerText = user ? `Member: ${user.email}` : "Guest Mode";
        document.getElementById('auth-form').classList.toggle('hidden', !!user);
        document.getElementById('post-form').classList.toggle('hidden', !user);
        if (user) getMyList();
        getList();
    }

    async function doPost() {
        const id = document.getElementById('edit-id').value;
        const payload = {
            title: document.getElementById('title').value,
            author_name: document.getElementById('author').value,
            caption: document.getElementById('caption').value,
            content: document.getElementById('content').value,
            author_id: currentUser.id
        };
        const { error } = id ? await api.from('novels').update(payload).eq('id', id) : await api.from('novels').insert([payload]);
        if (error) alert(error.message); else location.reload();
    }

    async function getMyList() {
        const { data } = await api.from('novels').select('id, title').eq('author_id', currentUser.id);
        document.getElementById('my-list').innerHTML = data.map(n => `
            <div class="work-item">
                <span>${n.title}</span>
                <div>
                    <button class="text-btn" onclick="editNovel('${n.id}')">Edit</button>
                    <button class="text-btn" onclick="deleteNovel('${n.id}')" style="color:red">Del</button>
                </div>
            </div>
        `).join('') || 'None';
    }

    async function getList() {
        const { data: novels } = await api.from('novels').select('*').order('created_at', { ascending: false });
        const { data: likes } = await api.from('likes').select('novel_id');
        document.getElementById('list').innerHTML = novels.map(n => {
            const lCount = likes ? likes.filter(l => l.novel_id === n.id).length : 0;
            return `
                <div class="novel-card">
                    <h3 onclick="openReader('${n.id}')">${n.title}</h3>
                    <div class="author-info">by ${n.author_name}</div>
                    <div class="caption-mini">${n.caption || ''}</div>
                    <button class="heart" onclick="addLike('${n.id}')">♥ ${lCount}</button>
                    <button class="text-btn" style="font-size:0.7em" onclick="addFav('${n.author_id}')">Follow</button>
                </div>
            `;
        }).join('');
    }

    async function openReader(id) {
        const { data } = await api.from('novels').select('*').eq('id', id).single();
        document.
