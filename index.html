<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --sidebar-width: 280px; }
        body { font-family: "Yu Gothic", "YuGothic", sans-serif; background: #fff; color: #000; margin: 0; display: flex; min-height: 100vh; }
        aside { width: var(--sidebar-width); height: 100vh; border-right: 2px solid #000; padding: 40px 20px; box-sizing: border-box; position: fixed; left: 0; top: 0; overflow-y: auto; background: #fff; display: flex; flex-direction: column; z-index: 100; }
        main { margin-left: var(--sidebar-width); flex: 1; padding: 40px; max-width: 900px; box-sizing: border-box; }
        aside h1 { font-family: 'Antonio', sans-serif; font-size: 2.2em; margin: 0 0 10px; text-transform: uppercase; cursor: pointer; }
        .rule-link { font-size: 0.85em; color: #666; text-decoration: underline; cursor: pointer; margin-bottom: 30px; display: block; }
        .search-box-side { padding: 10px; border: 1px solid #000; width: 100%; box-sizing: border-box; margin-bottom: 20px; }
        .section-header { display: flex; align-items: baseline; gap: 15px; border-bottom: 2px solid #000; margin-bottom: 20px; }
        .settings-link { font-size: 0.7em; color: #666; text-decoration: underline; cursor: pointer; }
        .profile-edit-area { background: #f9f9f9; padding: 20px; border: 1px solid #eee; margin-bottom: 30px; display: none; }
        .tab-bar { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 25px; }
        .tab-btn { background: none; border: none; color: #888; padding: 10px 0; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: #000; border-bottom: 2px solid #000; }
        .novel-row { padding: 15px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .novel-title { font-weight: bold; cursor: pointer; text-decoration: underline; }
        .count-badge { font-size: 0.75em; background: #eee; padding: 2px 6px; border-radius: 4px; color: #444; margin-right: 5px; }
        #editor-overlay, #reader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; overflow-y: auto; }
        .overlay-content { max-width: 700px; margin: 40px auto; padding: 20px; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; }
        button { background: #000; color: #fff; border: none; padding: 12px; cursor: pointer; width: 100%; margin-bottom: 5px; }
        .btn-outline { background: #fff; color: #000; border: 1px solid #000; }
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.9em; }
        .hidden { display: none !important; }
        .novel-stats { font-size: 0.85em; color: #888; margin-left: 10px; display: inline-flex; gap: 8px; }
        .stat-item { display: inline-flex; align-items: center; gap: 3px; }
        .sticky-close { position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 10px 0; z-index: 2100; border-bottom: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 8px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #000; }
        #r18-check:checked + .slider { background-color: #d00; }
        input:checked + .slider:before { transform: translateX(20px); }
        .checkbox-group { display: flex; gap: 25px; margin-bottom: 20px; align-items: center; }
        .checkbox-group label { display: flex; align-items: center; font-size: 0.9em; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<aside>
    <h1 onclick="location.reload()">Fragment Library</h1>
    <span class="rule-link" onclick="openRules()">å¿…ãšãŠèª­ã¿ãã ã•ã„ï¼ˆå¿…èª­ï¼‰</span>
    <input type="text" id="search-input" class="search-box-side" placeholder="æ¤œç´¢..." oninput="getList()">
    <div id="logged-in-nav" class="hidden">
        <button onclick="openEditor()">æ–°è¦æŠ•ç¨¿</button>
        <button class="btn-outline" onclick="doLogOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div id="guest-nav">
        <button onclick="toggleAuthForm()">ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²</button>
    </div>
</aside>

<main>
    <section id="auth-form" class="hidden" style="border:2px solid #000; padding:20px; margin-bottom:40px;">
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button onclick="doLogIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button onclick="doSignUp()" class="btn-outline">æ–°è¦ç™»éŒ²</button>
    </section>

    <div id="user-page" class="hidden">
        <div class="section-header"><h2>ãƒã‚¤ãƒšãƒ¼ã‚¸</h2><span class="settings-link" onclick="toggleSettings()">[è¨­å®š]</span></div>
        <div id="profile-edit-area" class="profile-edit-area">
            <input type="text" id="prof-name" placeholder="ä½œè€…å">
            <textarea id="prof-bio" placeholder="è‡ªå·±ç´¹ä»‹" rows="3"></textarea>
            <button class="btn-outline" onclick="saveProfile()" style="width:auto">æ›´æ–°</button>
        </div>
        <h3>æŠ•ç¨¿ã—ãŸä½œå“</h3>
        <div id="my-works-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="section-header"><h2>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h2></div>
    <div class="tab-bar">
        <button id="tab-all" class="tab-btn active" onclick="switchTab('all')">ã™ã¹ã¦</button>
        <button id="tab-follow" class="tab-btn" onclick="switchTab('follow')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
        <button id="tab-liked" class="tab-btn" onclick="switchTab('liked')">ã„ã„ã­æ¸ˆã¿</button>
    </div>
    <div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>
</main>

<div id="reader-overlay">
    <div class="overlay-content">
        <div class="sticky-close">
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 0 15px;">
                <button class="btn-outline" onclick="closeReader()" style="width:auto; margin:0;">â† é–‰ã˜ã‚‹</button>
                <div id="name-changer-group" style="display: flex; align-items: center; gap: 5px; flex-grow: 1; justify-content: flex-end;">
                    <input type="text" id="target-string" placeholder="å¤‰æ›å‰" style="width: 80px; margin: 0; padding: 5px; font-size: 0.8em;">
                    <span>â†’</span>
                    <input type="text" id="new-name" placeholder="å¤‰æ›å¾Œ" style="width: 80px; margin: 0; padding: 5px; font-size: 0.8em;">
                    <button onclick="applyNameChange()" style="width: auto; padding: 5px 15px; margin: 0; font-size: 0.8em;">å¤‰æ›</button>
                </div>
            </div>
        </div>
        <h2 id="read-title"></h2>
        <div id="read-author" style="text-align: right; font-weight: bold;"></div>
        <div id="read-body" style="white-space: pre-wrap; line-height: 2.2; margin: 40px 0;"></div>
        <div id="reader-interactive-zone" style="border-top: 1px solid #000; padding-top: 20px; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <button id="like-btn" onclick="toggleLike()" style="width:auto; padding: 10px 40px;">â™¥ ã„ã„ã­ <span id="read-like-count">0</span></button>
                <span id="author-link-zone" style="font-size: 0.9em; color: #666;"></span>
            </div>
            <div style="text-align: left;">
                <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                <div id="comment-list"></div>
                <div id="comment-form-area" class="hidden" style="margin-top: 20px;">
                    <textarea id="comment-input" placeholder="æ„Ÿæƒ³ã‚’æ›¸ã..." rows="3"></textarea>
                    <button onclick="postComment()" class="btn-outline" style="width:auto">ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡</button>
                </div>
                <div id="comment-guest-msg" class="hidden" style="margin-top: 20px; padding: 20px; background: #f9f9f9; text-align: center;">
                    <p>ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editor-overlay">
    <div class="overlay-content">
        <h2>æ–°è¦æŠ•ç¨¿</h2>
        <input type="text" id="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <input type="text" id="tags-input" placeholder="ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)">
        <textarea id="caption-input" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚ã‚‰ã™ã˜ç­‰ï¼‰" rows="3"></textarea>
        <div class="checkbox-group">
            <label><span class="switch"><input type="checkbox" id="r18-check"><span class="slider"></span></span>R-18</label>
            <label><span class="switch"><input type="checkbox" id="private-check"><span class="slider"></span></span>éå…¬é–‹(ä¸‹æ›¸ã)</label>
        </div>
        <textarea id="content-input" rows="20" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
        <button onclick="doPost()">å…¬é–‹ï¼ä¿å­˜ã™ã‚‹</button>
        <button onclick="closeEditor()" class="btn-outline">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);
    let currentUser = null, userProfile = null, currentTab = 'all', currentReadingId = null;
    let editingNovelId = null, allMyNovels = [], originalContent = "";

    async function init() {
        const { data: { user } } = await api.auth.getUser();
        currentUser = user;
        if (user) {
            document.getElementById('logged-in-nav').classList.remove('hidden');
            document.getElementById('guest-nav').classList.add('hidden');
            document.getElementById('user-page').classList.remove('hidden');
            await loadProfile();
            loadUserContent();
        }
        getList();
    }

    async function loadProfile() {
        const { data } = await api.from('profiles').select('*').eq('id', currentUser.id).single();
        userProfile = data;
        if(data) document.getElementById('prof-name').value = data.display_name || "";
    }

    async function getList() {
        let { data: novels, error } = await api.from('novels').select('*').eq('is_private', false).order('created_at', {ascending: false});
        if (error) return;
        let filtered = novels || [];
        const sw = document.getElementById('search-input').value.toLowerCase();
        if (currentTab === 'liked' && currentUser) {
            const { data: myLikes } = await api.from('likes').select('novel_id').eq('user_id', currentUser.id);
            const likedIds = (myLikes || []).map(l => l.novel_id);
            filtered = filtered.filter(n => likedIds.includes(n.id));
        }
        if (sw) filtered = filtered.filter(n => n.title.toLowerCase().includes(sw) || n.author_name.toLowerCase().includes(sw));

        document.getElementById('list').innerHTML = filtered.map(n => `
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    <span style="font-size:0.8em; color:#888;"> / ${n.author_name}</span>
                    <span class="count-badge">${(n.content || "").length.toLocaleString()}æ–‡å­—</span>
                </div>
                <div class="novel-stats" id="stats-${n.id}">â™¥ - ğŸ’¬ -</div>
            </div>`).join('') || "ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“";

        filtered.forEach(async (n) => {
            const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            const el = document.getElementById(`stats-${n.id}`);
            if(el) el.innerHTML = `<span class="stat-item">â™¥ ${lCount||0}</span> <span class="stat-item">ğŸ’¬ ${cCount||0}</span>`;
        });
    }

    async function loadUserContent() {
        if (!currentUser) return;
        let { data: novels, error } = await api.from('novels')
            .select('*')
            .eq('author_id', currentUser.id)
            .order('created_at', {ascending: false});
        
        if (error) return;

        // ã“ã“ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆã“ã‚ŒãŒç·¨é›†æ™‚ã«å¿…è¦ï¼‰
        allMyNovels = novels || []; 

        document.getElementById('my-works-list').innerHTML = allMyNovels.map(n => `
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    <span onclick="openEditor('${n.id}')" style="cursor:pointer; color:blue; font-size:0.8em; margin-left:10px;">[ç·¨é›†]</span>
                    <span class="count-badge">${(n.content || "").length.toLocaleString()}æ–‡å­—</span>
                    ${n.is_private ? '<span style="color:blue; font-size:0.75em;">[ä¸‹æ›¸ã]</span>' : ''}
                </div>
                <div class="novel-stats" id="my-stats-${n.id}">â™¥ - ğŸ’¬ -</div>
            </div>`).join('') || "ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“";
        
        // ã‚¹ã‚¿ãƒƒãƒ„ï¼ˆã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ•°ï¼‰ã®èª­ã¿è¾¼ã¿
        allMyNovels.forEach(async (n) => {
            const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            const el = document.getElementById(`my-stats-${n.id}`);
            if(el) el.innerHTML = `<span class="stat-item">â™¥ ${lCount||0}</span> <span class="stat-item">ğŸ’¬ ${cCount||0}</span>`;
        });
    }

    async function openReader(id) {
        currentReadingId = id;
        const { data: n } = await api.from('novels').select('*').eq('id', id).single();
        if(!n) return;
        originalContent = n.content;
        const titleEl = document.getElementById('read-title');
        titleEl.innerText = n.title;
        titleEl.style.fontSize = "1.1em";
        titleEl.style.margin = "20px 0 10px";
        document.getElementById('read-author').innerText = n.author_name;
        document.getElementById('read-body').innerText = n.content;
        document.getElementById('author-link-zone').innerHTML = `ä½œè€…: <strong onclick="filterByAuthor('${n.author_name}')" style="cursor:pointer; text-decoration:underline; color:#000;">${n.author_name}</strong>`;
        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-interactive-zone').classList.remove('hidden');
        document.getElementById('target-string').value = "";
        document.getElementById('new-name').value = "";
        
        if (currentUser) {
            document.getElementById('comment-form-area').classList.remove('hidden');
            document.getElementById('comment-guest-msg').classList.add('hidden');
        } else {
            document.getElementById('comment-form-area').classList.add('hidden');
            document.getElementById('comment-guest-msg').classList.remove('hidden');
        }
        loadComments(id);
        loadLikeCount(id);
    }

    function applyNameChange() {
        const target = document.getElementById('target-string').value;
        const replacement = document.getElementById('new-name').value;
        if (!target) return alert("å¤‰æ›å‰ã®æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        const escapedTarget = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedTarget, 'g');
        document.getElementById('read-body').innerText = originalContent.replace(regex, replacement || "");
    }

    async function loadComments(id) {
        const { data } = await api.from('comments').select('*').eq('novel_id', id).order('created_at', {ascending: true});
        document.getElementById('comment-list').innerHTML = (data || []).map(c => {
            const isMine = currentUser && c.user_id === currentUser.id;
            const manageBtns = isMine ? `<span onclick="editComment('${c.id}', '${c.body}')" style="cursor:pointer; color:blue; font-size:0.8em; margin-left:10px;">[ç·¨é›†]</span><span onclick="deleteComment('${c.id}')" style="cursor:pointer; color:red; font-size:0.8em; margin-left:5px;">[å‰Šé™¤]</span>` : '';
            return `<div class="comment-item"><strong>${c.user_name}</strong>: ${c.body} ${manageBtns}</div>`;
        }).join('') || "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“";
    }

    async function editComment(id, old) {
        const b = prompt("ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†:", old);
        if(!b || b === old) return;
        await api.from('comments').update({ body: b }).eq('id', id);
        loadComments(currentReadingId);
    }

    async function deleteComment(id) {
        if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        await api.from('comments').delete().eq('id', id);
        loadComments(currentReadingId);
    }

    async function postComment() {
        const b = document.getElementById('comment-input').value.trim();
        if(!b || !currentUser) return;
        const name = userProfile?.display_name || currentUser.email.split('@')[0];
        await api.from('comments').insert({ novel_id: currentReadingId, user_id: currentUser.id, user_name: name, body: b });
        document.getElementById('comment-input').value = "";
        loadComments(currentReadingId);
    }

    async function toggleLike() {
        if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        await api.from('likes').upsert({ novel_id: currentReadingId, user_id: currentUser.id }, { onConflict: 'novel_id, user_id' });
        loadLikeCount(currentReadingId);
    }

    async function loadLikeCount(id) {
        const { count } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', id);
        document.getElementById('read-like-count').innerText = count || 0;
    }

    function openEditor(id = null) {
        editingNovelId = id;
        if (id) {
            // è‡ªåˆ†ã®ä½œå“ãƒªã‚¹ãƒˆã‹ã‚‰IDãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™
            const n = allMyNovels.find(x => x.id === id);
            if (!n) {
                console.error("ä½œå“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ ID:", id);
                return;
            }
            document.getElementById('title-input').value = n.title;
            document.getElementById('tags-input').value = (n.tags || []).join(', ');
            document.getElementById('caption-input').value = n.caption || "";
            document.getElementById('content-input').value = n.content;
            document.getElementById('r18-check').checked = n.is_r18;
            document.getElementById('private-check').checked = n.is_private;
            document.querySelector('#editor-overlay h2').innerText = "ä½œå“ã‚’ç·¨é›†";
        } else {
            // æ–°è¦æŠ•ç¨¿æ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('title-input').value = "";
            document.getElementById('tags-input').value = "";
            document.getElementById('caption-input').value = "";
            document.getElementById('content-input').value = "";
            document.getElementById('r18-check').checked = false;
            document.getElementById('private-check').checked = false;
            document.querySelector('#editor-overlay h2').innerText = "æ–°è¦æŠ•ç¨¿";
        }
        document.getElementById('editor-overlay').style.display = 'block';
    }

    async function doPost() {
        const payload = {
            title: document.getElementById('title-input').value,
            content: document.getElementById('content-input').value,
            caption: document.getElementById('caption-input').value,
            tags: document.getElementById('tags-input').value.split(',').map(t => t.trim()),
            is_r18: document.getElementById('r18-check').checked,
            is_private: document.getElementById('private-check').checked,
            author_id: currentUser.id,
            author_name: userProfile?.display_name || "åç„¡ã—"
        };
        const { error } = editingNovelId ? await api.from('novels').update(payload).eq('id', editingNovelId) : await api.from('novels').insert(payload);
        if(error) alert(error.message); else location.reload();
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t));
        getList();
    }

    function openRules() {
        document.getElementById('read-title').innerText = "å¿…ãšãŠèª­ã¿ãã ã•ã„ï¼ˆå¿…èª­ï¼‰";
        document.getElementById('read-author').innerText = "é‹å–¶";
        document.getElementById('read-body').innerText = `ã€å½“ã‚µã‚¤ãƒˆã«ã¤ã„ã¦ã€‘ å½“ã‚µã‚¤ãƒˆã¯å€‹äººã«ã‚ˆã‚‹äºŒæ¬¡å‰µä½œå°èª¬ã®å±•ç¤ºãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ç›®çš„ã¨ã—ãŸå°‚ç”¨ã‚µã‚¤ãƒˆã§ã™ã€‚ 
        ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚
        1. äºŒæ¬¡å‰µä½œã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦ 
        ã€€ãƒ»æ¤œç´¢é¿ã‘ã®ãŸã‚ã€åŸä½œåãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’ãã®ã¾ã¾ãƒ•ãƒ«ãƒãƒ¼ãƒ ã§è¡¨ç¤ºã™ã‚‹ã“ã¨ã¯é¿ã‘ã¦ãã ã•ã„ï¼ˆä¼ã›å­—ã‚„æ„›ç§°ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼‰ã€‚ 
        ã€€ãƒ»å…¬å¼é–¢ä¿‚è€…ã®ç›®ã«è§¦ã‚Œã¬ã‚ˆã†ã€ç¯€åº¦ã‚ã‚‹é‹ç”¨ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ 
        2. ç¦æ­¢äº‹é … 
        ã€€ãƒ»å…¬åºè‰¯ä¿—ã«åã™ã‚‹å†…å®¹ã®æŠ•ç¨¿ã€‚ 
         ãƒ»ç‰¹å®šã®å€‹äººã‚„å›£ä½“ã‚’èª¹è¬—ä¸­å‚·ã™ã‚‹å†…å®¹ã€‚ 
         ãƒ»ç„¡æ–­è»¢è¼‰ãŠã‚ˆã³è‡ªä½œç™ºè¨€ã€‚ 
         ãƒ»å•†æ¥­åˆ©ç”¨ç›®çš„ã®æŠ•ç¨¿ã€‚ 
        3. ä½œå“ã®æ˜è¨˜ã¨å…è²¬äº‹é … 
        ã€€ãƒ»ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ã€ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰ç­‰ã®å‚¾å‘ãŒã‚ã‚‹å ´åˆã€ç‰¹æ®Šè¨­å®šãŒã‚ã‚‹å ´åˆã‚„RæŒ‡å®šãŒå¿…è¦ãªå ´åˆã¯ã€ã‚ã‚‰ã™ã˜ã‚„ã‚¿ã‚°ã§ã®æ˜è¨˜ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ 
         ãƒ»é–²è¦§ã¯è‡ªå·±è²¬ä»»ã¨ãªã‚Šã¾ã™ã€‚ ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦ã€å‰µä½œæ´»å‹•ã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ã€‚`;
        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-interactive-zone').classList.add('hidden');
    }

    function toggleSettings() { const s = document.getElementById('profile-edit-area'); s.style.display = s.style.display==='block'?'none':'block'; }
    function closeReader() { document.getElementById('reader-overlay').style.display = 'none'; }
    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    function doLogOut() { api.auth.signOut(); location.reload(); }
    function toggleAuthForm() { document.getElementById('auth-form').classList.toggle('hidden'); }
    async function doLogIn() { await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); location.reload(); }
    async function doSignUp() { const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if(error) alert(error.message); else alert("ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
    async function saveProfile() {
        await api.from('profiles').upsert({ id: currentUser.id, display_name: document.getElementById('prof-name').value, bio: document.getElementById('prof-bio').value });
        location.reload();
    }
    function filterByAuthor(name) {
        document.getElementById('search-input').value = name;
        closeReader();
        switchTab('all');
        getList();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    init();
</script>
</body>
</html>
