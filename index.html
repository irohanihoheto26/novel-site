<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Your Novel Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- å…±é€šåŸºç›¤CSS --- */
        :root { --main-color: #fcaf17; --bg-color: #f9f9f9; --text-color: #333; }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.6; }
        .hidden { display: none !important; }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        nav { background: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; sticky: top; z-index: 100; }
        .nav-btns { display: flex; gap: 10px; }
        button { cursor: pointer; border: 1px solid #ccc; background: #fff; padding: 6px 12px; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #eee; }
        .btn-primary { background: var(--main-color); color: #fff; border: none; font-weight: bold; }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .novel-row { background: #fff; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .novel-title { font-weight: bold; color: var(--main-color); cursor: pointer; font-size: 1.1em; }
        .tag-link { color: #888; font-size: 0.85em; margin-right: 8px; cursor: pointer; }
        .tag-link:hover { text-decoration: underline; }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (å…±é€š) */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; overflow-y: auto; }
        .overlay-content { max-width: 700px; margin: 40px auto; padding: 20px; }
        .close-btn-style { position: sticky; top: 10px; right: 10px; float: right; z-index: 3000; padding: 10px; background: #eee; border-radius: 50%; width: 40px; height: 40px; border: none; font-weight: bold; }
        .nav-hidden { transform: translateY(-100px); transition: transform 0.3s; }

        /* ãƒãƒƒã‚¸ */
        .r18-badge { background: #ff4d4d; color: #fff; font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }
        .draft-badge { background: #999; color: #fff; font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-left: 5px; }

        /* çµ±è¨ˆãƒ»ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ */
        .novel-stats { font-size: 0.85em; color: #777; margin-top: 5px; }
        .stat-item { margin-right: 15px; }
        .sticky-close { position: fixed; top: 10px; right: 10px; z-index: 5000; transition: 0.3s; }

        /* ã‚¨ãƒ‡ã‚£ã‚¿ */
        textarea, input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        #content-input { min-height: 300px; font-family: serif; font-size: 1.1em; }
    </style>
    <style id="user-custom-style"></style>
</head>
<body>

<nav>
    <div onclick="location.reload()" style="cursor:pointer; font-weight:bold; font-size:1.2em;">Archive</div>
    <div class="nav-btns" id="guest-nav">
        <button onclick="toggleAuthForm()">ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²</button>
    </div>
    <div class="nav-btns hidden" id="logged-in-nav">
        <button class="btn-primary" onclick="openEditor()">æ–°è¦æŠ•ç¨¿</button>
        <button onclick="toggleSettings()">âš™ è¨­å®š</button>
        <button onclick="doLogOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</nav>

<div id="notification-banner" class="hidden" style="background:#fff3cd; padding:15px; border-bottom:1px solid #ffeeba; text-align:center;">
    <div id="notification-list"></div>
    <button onclick="clearNotifications()" style="margin-top:10px; font-size:0.8em;">ç¢ºèªã—ã¦æ—¢èª­ã«ã™ã‚‹</button>
</div>

<div class="container">
    <div id="auth-form" class="hidden" style="background:#fff; padding:20px; border:1px solid #ddd; margin-bottom:20px;">
        <input type="text" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn-primary" onclick="doLogIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button onclick="doSignUp()">æ–°è¦ç™»éŒ²</button>
    </div>

    <div id="user-page" class="hidden">
        <h2 id="user-welcome-msg">ã‚ˆã†ã“ãã€<span id="display-current-name"></span> ã•ã‚“</h2>
        <div id="profile-edit-area" style="display:none; background:#eee; padding:20px; border-radius:8px; margin-bottom:20px;">
            <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h3>
            ä½œè€…å: <input type="text" id="prof-name">
            è‡ªå·±ç´¹ä»‹: <textarea id="prof-bio"></textarea>
            ä½œè€…ãƒšãƒ¼ã‚¸ç”¨HTML/CSS: <textarea id="prof-css" style="height:150px;"></textarea>
            <button onclick="resetToTemplate()" style="font-size:0.8em;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æˆ»ã™</button>
            <hr>
            æ–‡ç« ç”»é¢ç”¨ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ‰: <textarea id="reader-custom-input" style="height:150px;"></textarea>
            <button onclick="resetReaderDesign()" style="font-size:0.8em;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æˆ»ã™</button>
            <div style="margin-top:15px;">
                <button class="btn-primary" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
                <button onclick="deleteAccount()" style="color:red; float:right;">é€€ä¼šã™ã‚‹</button>
            </div>
        </div>
        
        <div class="stats-summary" style="background:#fff; padding:15px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
            åˆè¨ˆæ–‡å­—æ•°: <strong id="total-char-count">0</strong> / ç´¯è¨ˆã„ã„ã­: <strong id="total-likes">0</strong>
            <button id="view-my-page-link" style="margin-left:15px;">è‡ªåˆ†ã®ä½œè€…ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</button>
        </div>
        
        <div id="my-works-list"></div>
        <hr>
    </div>

    <div id="library-section-header">
        <input type="text" id="search-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã€ä½œè€…ã€ã‚¿ã‚°ã§æ¤œç´¢..." oninput="getList()">
        <div id="search-result-count" style="font-size:0.8em; color:#888;"></div>
        <div style="margin:10px 0;">
            <button id="tab-all" class="tab-btn active" onclick="switchTab('all')">å…¨ä½œå“</button>
            <button id="tab-follow" class="tab-btn" onclick="switchTab('follow')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
            <button id="tab-bookmark" class="tab-btn" onclick="switchTab('bookmark')">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</button>
            <select id="sort-order" onchange="getList()" style="padding:5px;">
                <option value="new">æ–°ç€é †</option>
                <option value="likes">ã„ã„ã­é †</option>
                <option value="char_count">æ–‡å­—æ•°é †</option>
            </select>
            <label style="font-size:0.8em; margin-left:10px;"><input type="checkbox" id="exclude-r18" onchange="getList()"> R18é™¤å¤–</label>
        </div>
    </div>

    <div id="list"></div>
    
    <div style="text-align:center; margin-top:40px; font-size:0.9em; color:#888;">
        <span onclick="openRules()" style="cursor:pointer; text-decoration:underline;">ãƒ«ãƒ¼ãƒ«</span> | 
        <span onclick="openAboutPage()" style="cursor:pointer; text-decoration:underline;">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</span>
    </div>
</div>

<div id="reader-overlay" class="overlay">
    <button class="close-btn-style sticky-close" onclick="closeReader()">âœ•</button>
    <div class="overlay-content">
        <h1 id="read-title" style="text-align:center;"></h1>
        <div id="read-author" style="text-align:center; color:#888; margin-bottom:20px;"></div>
        
        <div id="name-changer-group" style="display:none; background:#f0f0f0; padding:15px; border-radius:8px; margin-bottom:20px; flex-direction:column; gap:10px;">
            <div style="font-size:0.9em; font-weight:bold;">åå‰å¤‰æ›ï¼š</div>
            <input type="text" id="user-custom-name" placeholder="å¤‰æ›å¾Œã®åå‰ã‚’å…¥åŠ›" style="margin:0;">
            <button class="btn-primary" onclick="applyNameChange()">å¤‰æ›ã—ã¦èª­ã‚€</button>
        </div>

        <div id="read-body" class="indent-text" style="white-space: pre-wrap; margin-bottom:40px;"></div>

        <div id="reader-interactive-zone" class="hidden">
            <div id="author-link-zone" style="margin-bottom:20px; text-align:center;"></div>
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:30px;">
                <button id="like-btn" onclick="toggleLike()" style="padding:10px 20px;">
                    <span id="read-like-text">ã„ã„ã­</span> â™¥ <span id="read-like-count">0</span>
                </button>
                <button id="bookmark-btn" onclick="toggleBookmark()" style="padding:10px 20px;">
                    <span id="bookmark-icon">â˜†</span> ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
                </button>
            </div>

            <div id="comment-section" style="border-top:1px solid #ddd; padding-top:20px;">
                <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                <div id="comment-list" style="margin-bottom:20px;"></div>
                <div id="comment-form-area" class="hidden">
                    <textarea id="comment-input" placeholder="æ„Ÿæƒ³ã‚’æ›¸ã..." style="height:80px;"></textarea>
                    <label style="font-size:0.8em;"><input type="checkbox" id="comment-is-private"> ä½œè€…ã«ã®ã¿å…¬é–‹</label>
                    <button class="btn-primary" onclick="postComment()" style="float:right;">é€ä¿¡</button>
                </div>
                <div id="comment-guest-msg" class="hidden" style="text-align:center; color:#888;">
                    ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editor-overlay" class="overlay">
    <button class="close-btn-style" onclick="closeEditor()">âœ•</button>
    <div class="overlay-content">
        <h2>ä½œå“ã‚’æŠ•ç¨¿</h2>
        <input type="text" id="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <input type="text" id="tags-input" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰">
        <textarea id="caption-input" placeholder="ä½œå“èª¬æ˜ï¼ˆã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‰" style="height:80px;"></textarea>
        
        <div style="margin-bottom:5px; font-size:0.8em; color:#666; text-align:right;">
            æ–‡å­—æ•°: <span id="current-count">0</span>
        </div>
        <textarea id="content-input" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
        
        <div style="background:#f9f9f9; padding:15px; border-radius:4px; margin-bottom:15px;">
            <label><input type="checkbox" id="name-convert-check"> åå‰å¤‰æ›ã‚’ä½¿ç”¨ã™ã‚‹</label>
            <div id="default-name-area" class="hidden" style="margin-top:10px;">
                ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå: <input type="text" id="default-name-input" placeholder="ï¼ˆä¾‹ï¼‰èŠ±å­">
                <small style="color:#888;">â€»æœ¬æ–‡ä¸­ã®ã“ã®åå‰ãŒèª­è€…ã®å¥½ããªåå‰ã«å¤‰æ›ã•ã‚Œã¾ã™</small>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <label style="margin-right:15px;"><input type="checkbox" id="r18-check"> R18</label>
            <label><input type="checkbox" id="private-check"> ä¸‹æ›¸ãã¨ã—ã¦ä¿å­˜ï¼ˆéå…¬é–‹ï¼‰</label>
        </div>
        <button class="btn-primary" style="width:100%; padding:15px;" onclick="doPost()">æŠ•ç¨¿ãƒ»ä¿å­˜ã™ã‚‹</button>
    </div>
</div>

<div id="author-page-overlay" class="overlay" style="z-index:4000;">
    <button class="close-btn-style" onclick="closeAuthorPage()">âœ•</button>
    <div class="overlay-content">
        <h1 id="author-page-name"></h1>
        <div id="author-page-bio"></div>
        <div id="author-page-works"></div>
    </div>
</div>

<script>
    // --- åˆæœŸè¨­å®šã¨å®šæ•° ---
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    let currentUser = null, userProfile = null, currentTab = 'all', currentReadingId = null;
    let editingNovelId = null, allMyNovels = [], originalContent = "", currentOpenedNovel = null, currentReplyId = null;

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    const defaultReaderTemplate = `<style>\n#reader-overlay { background-color: #ffffff; color: #333333; }\n#read-body { max-width: 700px; margin: 0 auto; font-size: 1.1em; line-height: 2; }\n</style>`;
    const defaultAuthorTemplate = `/* ã€ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘ */\n<h1 class="default-title">ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ«</h1>\n<div class="default-bio">è‡ªå·±ç´¹ä»‹ã‚’ã©ã†ãã€‚</div>\n<div id="custom-works-area"></div>\n<style>\n#author-page-name { display: none; }\n.default-title { font-size: 1.8em; color: #333; }\n.novel-row { padding: 15px 0; border-bottom: 1px solid #eee; }\n</style>`;

    // --- åˆæœŸåŒ– ---
    async function init() {
        const { data: { session } } = await api.auth.getSession();
        currentUser = session?.user || null;

        if (currentUser) {
            document.getElementById('logged-in-nav').classList.remove('hidden');
            document.getElementById('guest-nav').classList.add('hidden');
            document.getElementById('user-page').classList.remove('hidden');
            await loadProfile();
            await loadUserContent();
            await checkNotifications();
            if (!userProfile || !userProfile.display_name || userProfile.display_name === "åç„¡ã—") forceProfileSetup();
        }
        await getList();
        
        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
        const ci = document.getElementById('content-input');
        if (ci) ci.addEventListener('input', e => {
            document.getElementById('current-count').innerText = e.target.value.length.toLocaleString();
        });
    }

    // --- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ä½œå“ãƒªã‚¹ãƒˆ ---
    async function loadProfile() {
        const { data } = await api.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
        userProfile = data;
        if (data) {
            document.getElementById('prof-name').value = data.display_name || "åç„¡ã—";
            document.getElementById('prof-bio').value = data.bio || "";
            document.getElementById('prof-css').value = data.custom_css || defaultAuthorTemplate;
            document.getElementById('reader-custom-input').value = data.reader_custom_code || defaultReaderTemplate;
            document.getElementById('display-current-name').innerText = data.display_name || "åç„¡ã—";
            document.getElementById('view-my-page-link').onclick = () => openAuthorPage(currentUser.id);
        }
    }

    async function getList() {
        const listEl = document.getElementById('list');
        try {
            let { data: novels } = await api.from('novels').select('*').eq('is_private', false).order('created_at', { ascending: false });
            let filtered = novels || [];
            if (currentUser) filtered = filtered.filter(n => n.author_id !== currentUser.id);
            if (document.getElementById('exclude-r18').checked) filtered = filtered.filter(n => !n.is_r18);

            const sw = document.getElementById('search-input').value.toLowerCase();
            if (currentTab === 'follow' && currentUser) {
                const { data: f } = await api.from('follows').select('following_id').eq('follower_id', currentUser.id);
                const fIds = (f || []).map(x => x.following_id);
                filtered = filtered.filter(n => fIds.includes(n.author_id));
            } else if (currentTab === 'bookmark' && currentUser) {
                const { data: b } = await api.from('bookmarks').select('novel_id').eq('user_id', currentUser.id);
                const bIds = (b || []).map(x => x.novel_id);
                filtered = filtered.filter(n => bIds.includes(n.id));
            }

            if (sw) {
                filtered = filtered.filter(n => n.title.toLowerCase().includes(sw) || n.author_name.toLowerCase().includes(sw) || (n.tags && n.tags.some(t => t.toLowerCase().includes(sw))));
            }
            document.getElementById('search-result-count').innerText = sw ? `${filtered.length} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ` : "";

            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®éåŒæœŸå–å¾—
            const promises = filtered.map(async n => {
                const { count: l } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                const { count: c } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                n.like_count = l || 0; n.comment_count = c || 0; n.char_count = (n.content || "").length;
            });
            await Promise.all(promises);

            const sortType = document.getElementById('sort-order').value;
            if (sortType === 'likes') filtered.sort((a,b) => b.like_count - a.like_count);
            if (sortType === 'char_count') filtered.sort((a,b) => b.char_count - a.char_count);

            renderFinalList(filtered);
        } catch (e) { console.error(e); }
    }

    function renderFinalList(novels) {
        document.getElementById('list').innerHTML = novels.map(n => `
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    ${n.is_r18 ? '<span class="r18-badge">R18</span>' : ''}
                    <span onclick="openAuthorPage('${n.author_id}')" style="font-size:0.8em; color:#888; cursor:pointer; text-decoration:underline;"> / ${n.author_name}</span>
                    <div style="margin-top:5px;">${(n.tags || []).filter(t => t.trim()).map(t => `<span class="tag-link" onclick="setSearchTag('${t}')">#${t}</span>`).join('')}</div>
                </div>
                <div class="novel-stats">
                    <span class="count-badge">${(n.char_count || 0).toLocaleString()}æ–‡å­—</span>
                    <span class="stat-item">â™¥ ${n.like_count || 0}</span>
                    <span class="stat-item">ğŸ’¬ ${n.comment_count || 0}</span>
                </div>
            </div>`).join('') || '<div style="padding:20px; text-align:center; color:#888;">ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }

    // --- èª­æ›¸ãƒ»æ©Ÿèƒ½ ---
    async function openReader(id) {
        currentReadingId = id;
        resetReaderUI();
        const { data: n } = await api.from('novels').select('*').eq('id', id).single();
        if (!n) return alert("ä½œå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        currentOpenedNovel = n;
        originalContent = n.content;
        
        const { data: prof } = await api.from('profiles').select('display_name, reader_custom_code').eq('id', n.author_id).maybeSingle();
        
        document.getElementById('read-title').innerText = n.title;
        document.getElementById('read-body').innerText = n.content;
        
        const nameGroup = document.getElementById('name-changer-group');
        if (n.default_name && n.default_name.trim()) {
            nameGroup.style.setProperty('display', 'flex', 'important');
            const saved = localStorage.getItem('user-default-name');
            if (saved) document.getElementById('user-custom-name').value = saved;
        }

        document.getElementById('author-link-zone').innerHTML = `ä½œè€…: <strong onclick="openAuthorPage('${n.author_id}')" style="cursor:pointer; text-decoration:underline;">${prof?.display_name || n.author_name}</strong>` + 
            ((currentUser && n.author_id !== currentUser.id) ? `<button id="follow-btn" onclick="toggleFollow('${n.author_id}')" style="margin-left:10px;">ãƒ•ã‚©ãƒ­ãƒ¼</button>` : '');

        if (currentUser && n.author_id !== currentUser.id) checkFollowStatus(n.author_id);
        
        // ãƒ‡ã‚¶ã‚¤ãƒ³æ³¨å…¥
        const styleTag = document.createElement('style');
        styleTag.id = 'dynamic-reader-style';
        const custom = prof?.reader_custom_code || defaultReaderTemplate;
        styleTag.textContent = `#reader-overlay, .overlay-content { background-color: transparent; } #reader-overlay .close-btn-style { background-color: unset; border: unset; } ` + custom.replace(/<style>|<\/style>/g, '');
        document.head.appendChild(styleTag);

        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-interactive-zone').classList.remove('hidden');
        
        loadComments(id);
        loadLikeCount(id);
        checkBookmarkStatus(id);

        if (currentUser) {
            document.getElementById('comment-form-area').classList.remove('hidden');
            document.getElementById('comment-guest-msg').classList.add('hidden');
        } else {
            document.getElementById('comment-form-area').classList.add('hidden');
            document.getElementById('comment-guest-msg').classList.remove('hidden');
        }
    }

    function applyNameChange() {
        const replacement = document.getElementById('user-custom-name').value;
        const target = currentOpenedNovel?.default_name;
        if (!target || !replacement) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        const regex = new RegExp(target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        document.getElementById('read-body').textContent = originalContent.replace(regex, replacement);
        localStorage.setItem('user-default-name', replacement);
    }

    // --- ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ã„ã„ã­ãƒ»ãƒ–ã‚¯ãƒ ---
    async function loadComments(id) {
        const { data: comments } = await api.from('comments').select('*').eq('novel_id', id).order('created_at', { ascending: true });
        const listEl = document.getElementById('comment-list');
        if (!comments || comments.length === 0) return listEl.innerHTML = "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“";

        const uIds = [...new Set(comments.map(c => c.user_id))];
        const { data: profs } = await api.from('profiles').select('id, display_name').in('id', uIds);
        const nameMap = {}; profs?.forEach(p => nameMap[p.id] = p.display_name);

        const parents = comments.filter(c => !c.parent_id);
        const replies = comments.filter(c => c.parent_id);

        listEl.innerHTML = parents.map(p => {
            const renderC = (c, isR) => {
                const name = nameMap[c.user_id] || c.user_name || "åç„¡ã—";
                const isMine = currentUser && c.user_id === currentUser.id;
                return `<div class="comment-item" style="${isR ? 'margin-left:30px; border-left:2px solid #ddd; padding-left:10px; margin-top:8px;' : 'margin-bottom:8px;'}">
                    ${c.is_private ? '[éå…¬é–‹] ' : ''}<strong onclick="openAuthorPage('${c.user_id}')" style="cursor:pointer; text-decoration:underline;">${name}</strong>: <span>${c.body}</span>
                    <span onclick="prepareReply('${c.id}', '${name}')" style="cursor:pointer; color:#666; font-size:0.8em; margin-left:12px; text-decoration:underline;">è¿”ä¿¡</span>
                    ${isMine ? `<span onclick="startEditComment('${c.id}', \`${c.body.replace(/`/g, '\\`')}\`)" style="cursor:pointer; color:#007bff; font-size:0.8em; margin-left:12px; text-decoration:underline;">ç·¨é›†</span>` : ''}
                    ${isMine ? `<span onclick="deleteComment('${c.id}')" style="cursor:pointer; color:#dc3545; font-size:0.8em; margin-left:8px; text-decoration:underline;">å‰Šé™¤</span>` : ''}
                </div>`;
            };
            return `<div style="margin-bottom:15px;">${renderC(p, false)}${replies.filter(r => r.parent_id === p.id).map(r => renderC(r, true)).join('')}</div>`;
        }).join('');
    }

    async function postComment() {
        const body = document.getElementById('comment-input').value.trim();
        const isPrivate = document.getElementById('comment-is-private').checked;
        if (!body || !currentUser) return;

        const { error } = await api.from('comments').insert({
            novel_id: currentReadingId, user_id: currentUser.id, user_name: userProfile?.display_name || "åç„¡ã—",
            body: body, is_private: isPrivate, parent_id: currentReplyId
        });

        if (!error) {
            const displayName = userProfile?.display_name || "åç„¡ã—";
            // ä½œè€…ã¸ã®é€šçŸ¥
            if (currentOpenedNovel.author_id !== currentUser.id) {
                await api.from('notifications').insert({ target_user_id: currentOpenedNovel.author_id, from_user_name: displayName, type: currentReplyId ? 'reply' : 'comment', novel_title: currentOpenedNovel.title, is_private: isPrivate });
            }
            // è¦ªã‚³ãƒ¡ä¸»ã¸ã®é€šçŸ¥
            if (currentReplyId) {
                const { data: p } = await api.from('comments').select('user_id').eq('id', currentReplyId).single();
                if (p && p.user_id !== currentUser.id && p.user_id !== currentOpenedNovel.author_id) {
                    await api.from('notifications').insert({ target_user_id: p.user_id, from_user_name: displayName, type: 'reply', novel_title: currentOpenedNovel.title, is_private: isPrivate });
                }
            }
            document.getElementById('comment-input').value = "";
            document.getElementById('comment-input').placeholder = "æ„Ÿæƒ³ã‚’æ›¸ã...";
            document.getElementById('comment-is-private').checked = false;
            currentReplyId = null;
            loadComments(currentReadingId);
        }
    }

    async function toggleLike() {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const { data: existing } = await api.from('likes').select('*').eq('novel_id', currentReadingId).eq('user_id', currentUser.id).maybeSingle();
        if (existing) {
            await api.from('likes').delete().eq('id', existing.id);
        } else {
            await api.from('likes').insert({ novel_id: currentReadingId, user_id: currentUser.id });
            if (currentOpenedNovel.author_id !== currentUser.id) {
                await api.from('notifications').insert({ target_user_id: currentOpenedNovel.author_id, from_user_name: userProfile?.display_name || "åç„¡ã—", type: 'like', novel_title: currentOpenedNovel.title });
            }
        }
        loadLikeCount(currentReadingId);
    }

    async function loadLikeCount(id) {
        const { count } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', id);
        document.getElementById('read-like-count').innerText = count || 0;
        if (currentUser) {
            const { data } = await api.from('likes').select('*').eq('novel_id', id).eq('user_id', currentUser.id).maybeSingle();
            const btn = document.getElementById('like-btn');
            if (data) { btn.style.background = "#ff4d4d"; btn.style.color = "#fff"; document.getElementById('read-like-text').innerText = "ã„ã„ã­æ¸ˆã¿"; }
            else { btn.style.background = "#fff"; btn.style.color = "#000"; document.getElementById('read-like-text').innerText = "ã„ã„ã­"; }
        }
    }

    async function toggleBookmark() {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const { data } = await api.from('bookmarks').select('id').eq('user_id', currentUser.id).eq('novel_id', currentReadingId).maybeSingle();
        if (data) await api.from('bookmarks').delete().eq('id', data.id);
        else await api.from('bookmarks').insert({ user_id: currentUser.id, novel_id: currentReadingId });
        checkBookmarkStatus(currentReadingId);
    }

    async function checkBookmarkStatus(id) {
        if (!currentUser) return;
        const { data } = await api.from('bookmarks').select('id').eq('user_id', currentUser.id).eq('novel_id', id).maybeSingle();
        const icon = document.getElementById('bookmark-icon');
        const btn = document.getElementById('bookmark-btn');
        if (data) { icon.innerText = "â˜…"; btn.style.color = "#fcaf17"; btn.style.borderColor = "#fcaf17"; }
        else { icon.innerText = "â˜†"; btn.style.color = "#ccc"; btn.style.borderColor = "#ccc"; }
    }

    // --- é€šçŸ¥ãƒ»ãƒ•ã‚©ãƒ­ãƒ¼ ---
    async function checkNotifications() {
        const { data } = await api.from('notifications').select('*').eq('target_user_id', currentUser.id).eq('is_read', false).order('created_at', { ascending: false });
        const banner = document.getElementById('notification-banner');
        if (data && data.length > 0) {
            document.getElementById('notification-list').innerHTML = data.map(n => {
                let msg = `<strong>${n.from_user_name}</strong> ã•ã‚“ãŒ `;
                if (n.type === 'reply') msg += `ã€Œ${n.novel_title}ã€ã§è¿”ä¿¡ã—ã¾ã—ãŸï¼`;
                else if (n.type === 'comment') msg += `ã€Œ${n.novel_title}ã€ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸï¼`;
                else if (n.type === 'like') msg += `ã€Œ${n.novel_title}ã€ã«ã„ã„ã­ã—ã¾ã—ãŸï¼`;
                else if (n.type === 'follow') msg += `ã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸï¼`;
                return `<div>ãƒ» ${msg}</div>`;
            }).join('');
            banner.classList.remove('hidden');
        } else { banner.classList.add('hidden'); }
    }

    async function clearNotifications() {
        await api.from('notifications').update({ is_read: true }).eq('target_user_id', currentUser.id);
        document.getElementById('notification-banner').classList.add('hidden');
    }

    async function toggleFollow(aId) {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const { data: existing } = await api.from('follows').select('*').eq('follower_id', currentUser.id).eq('following_id', aId).maybeSingle();
        if (existing) { await api.from('follows').delete().eq('id', existing.id); }
        else {
            await api.from('follows').insert({ follower_id: currentUser.id, following_id: aId });
            if (aId !== currentUser.id) await api.from('notifications').insert({ target_user_id: aId, from_user_name: userProfile?.display_name || "åç„¡ã—", type: 'follow', novel_title: "" });
        }
        checkFollowStatus(aId);
    }

    async function checkFollowStatus(aId) {
        const { data } = await api.from('follows').select('*').eq('follower_id', currentUser.id).eq('following_id', aId).maybeSingle();
        const btn = document.getElementById('follow-btn');
        if (!btn) return;
        if (data) { btn.innerText = "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­"; btn.style.background = "#fcaf17"; btn.style.color = "#fff"; }
        else { btn.innerText = "ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹"; btn.style.background = "#fff"; btn.style.color = "#fcaf17"; }
    }

    // --- æŠ•ç¨¿ãƒ»ç·¨é›†ãƒ»ä½œè€…ãƒšãƒ¼ã‚¸ ---
    async function doPost() {
        if (!userProfile?.display_name || userProfile.display_name === "åç„¡ã—") {
            alert("ä½œè€…åã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); forceProfileSetup(); return;
        }
        const isNC = document.getElementById('name-convert-check').checked;
        const payload = {
            title: document.getElementById('title-input').value,
            content: document.getElementById('content-input').value,
            caption: document.getElementById('caption-input').value,
            tags: document.getElementById('tags-input').value.split(',').map(t => t.trim()).filter(t => t),
            is_r18: document.getElementById('r18-check').checked,
            is_private: document.getElementById('private-check').checked,
            default_name: isNC ? document.getElementById('default-name-input').value.trim() : "",
            author_id: currentUser.id,
            author_name: userProfile.display_name
        };
        const { error } = editingNovelId ? await api.from('novels').update(payload).eq('id', editingNovelId) : await api.from('novels').insert(payload);
        if (error) alert(error.message); else location.reload();
    }

    async function openAuthorPage(aId) {
        const { data: prof } = await api.from('profiles').select('*').eq('id', aId).maybeSingle();
        if (!prof) return;
        const full = prof.custom_css || "";
        const cssM = full.match(/<style>([\s\S]*?)<\/style>/);
        document.getElementById('user-custom-style').innerHTML = cssM ? cssM[1] : full;
        document.getElementById('author-page-bio').innerHTML = full.replace(/<style>[\s\S]*?<\/style>/, "") || prof.bio || "";
        document.getElementById('author-page-name').innerText = prof.display_name;
        
        document.getElementById('author-page-overlay').style.display = 'block';
        closeReader();

        const { data: novels } = await api.from('novels').select('*').eq('author_id', aId).eq('is_private', false).order('created_at', { ascending: false });
        const target = document.getElementById('custom-works-area') || document.getElementById('author-page-works');
        target.innerHTML = (novels || []).map(n => `
            <div class="novel-row">
                <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                <span class="count-badge">${(n.content || "").length}æ–‡å­—</span>
                ${n.is_r18 ? '<span class="r18-badge">R18</span>' : ''}
            </div>`).join('') || "å…¬é–‹ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“";
    }

    // --- ãã®ä»–UIæ“ä½œ ---
    function resetReaderUI() {
        const old = document.getElementById('dynamic-reader-style'); if (old) old.remove();
        document.getElementById('reader-interactive-zone').classList.add('hidden');
        document.getElementById('name-changer-group').style.display = 'none';
        document.getElementById('read-body').classList.remove('indent-text', 'hanging-indent');
        document.getElementById('read-title').style.textDecoration = "none";
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t));
        getList();
    }

    function toggleSettings() { const s = document.getElementById('profile-edit-area'); s.style.display = s.style.display==='block'?'none':'block'; }
    function toggleAuthForm() { document.getElementById('auth-form').classList.toggle('hidden'); }
    function closeReader() { document.getElementById('reader-overlay').style.display = 'none'; resetReaderUI(); }
    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    function closeAuthorPage() { document.getElementById('author-page-overlay').style.display = 'none'; document.getElementById('user-custom-style').innerHTML = ""; }

    async function doLogIn() {
        const { error } = await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value });
        if (error) alert(error.message); else location.reload();
    }
    async function doLogOut() { await api.auth.signOut(); location.reload(); }
    async function doSignUp() { const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if(error) alert(error.message); else alert("ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }

    async function saveProfile() {
        const name = document.getElementById('prof-name').value.trim();
        if (!name) return alert("ä½œè€…åã¯å¿…é ˆã§ã™");
        const updates = { id: currentUser.id, display_name: name, bio: document.getElementById('prof-bio').value, custom_css: document.getElementById('prof-css').value, reader_custom_code: document.getElementById('reader-custom-input').value, updated_at: new Date() };
        const { error } = await api.from('profiles').upsert(updates);
        if (error) alert(error.message); else { alert("ä¿å­˜ã—ã¾ã—ãŸ"); location.reload(); }
    }

    function setSearchTag(t) { document.getElementById('search-input').value = t; getList(); document.getElementById('library-section-header').scrollIntoView({ behavior: 'smooth' }); }
    function forceProfileSetup() { document.getElementById('profile-edit-area').style.display = 'block'; document.getElementById('prof-name').style.border = "2px solid red"; }
    function prepareReply(id, name) { currentReplyId = id; document.getElementById('comment-input').placeholder = `${name} ã•ã‚“ã¸ã®è¿”ä¿¡...`; document.getElementById('comment-input').focus(); }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    document.addEventListener('change', e => {
        if (e.target?.id === 'name-convert-check') {
            document.getElementById('default-name-area').classList.toggle('hidden', !e.target.checked);
        }
    });

    document.addEventListener('DOMContentLoaded', init);

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³éš ã™
    let lastST = 0;
    document.getElementById('reader-overlay').addEventListener('scroll', function() {
        const s = document.querySelector('.sticky-close');
        if (!s || window.innerWidth > 800) return;
        let st = this.scrollTop;
        if (st > lastST && st > 100) s.classList.add('nav-hidden');
        else s.classList.remove('nav-hidden');
        lastST = st;
    }, { passive: true });

    // ãã®ä»–ã€ãƒ«ãƒ¼ãƒ«ã‚„ About ãƒšãƒ¼ã‚¸è¡¨ç¤ºç”¨ (çœç•¥ã›ãšã«å®šç¾©)
    function openRules() {
        resetReaderUI(); document.getElementById('read-title').innerText = "ãƒ«ãƒ¼ãƒ«";
        document.getElementById('read-body').innerHTML = `ãƒ»æ¤œç´¢é¿ã‘æ¨å¥¨<br>ãƒ»ç„¡æ–­è»¢è¼‰ç¦æ­¢<br>ãƒ»RæŒ‡å®šã¯é©åˆ‡ã«`;
        document.getElementById('reader-overlay').style.display = 'block';
    }
    function openAboutPage() {
        resetReaderUI(); document.getElementById('read-title').innerText = "ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦";
        document.getElementById('read-body').innerHTML = `å½“ã‚µã‚¤ãƒˆã¯å€‹äººã‚µã‚¤ãƒˆã®è‡ªç”±ãªç©ºæ°—æ„Ÿã‚’å¤§åˆ‡ã«ã—ãŸå°èª¬æŠ•ç¨¿ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚`;
        document.getElementById('reader-overlay').style.display = 'block';
    }
</script>
</body>
</html>
