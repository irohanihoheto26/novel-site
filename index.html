<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Yu Gothic", sans-serif; background: #fff; color: #000; margin: 0; line-height: 1.6; }
        header { padding: 40px 20px; text-align: center; border-bottom: 1px solid #000; }
        header h1 { font-family: 'Antonio', sans-serif; font-size: 3.5em; margin: 0; text-transform: uppercase; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* コンパクトな管理画面 */
        .my-works { font-size: 0.85em; background: #f9f9f9; padding: 15px; border: 1px solid #000; margin-bottom: 30px; }
        .work-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ccc; }
        
        /* 小説カード */
        .novel-card { padding: 20px 0; border-bottom: 1px solid #000; position: relative; }
        .novel-card h3 { margin: 0; font-size: 1.3em; }
        .author-info { font-size: 0.8em; color: #666; margin: 5px 0; }
        .caption { font-size: 0.9em; margin: 10px 0; border-left: 2px solid #000; padding-left: 10px; }
        
        /* ボタン系 */
        button { background: #000; color: #fff; border: 1px solid #000; padding: 5px 15px; cursor: pointer; font-family: inherit; }
        button.text-btn { background: none; color: #000; border: none; text-decoration: underline; padding: 0; font-size: 0.8em; margin-left: 10px; }
        .heart { color: #e0245e; cursor: pointer; font-size: 1.2em; border: none; background: none; }
        
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #000; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header><h1>Fragment Library</h1></header>

<div class="container">
    <div id="auth-status" style="text-align:right; font-size:0.8em; margin-bottom:10px;">Checking...</div>

    <section id="auth-form" class="hidden">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogIn()">Login</button>
        <button onclick="doSignUp()" style="background:none; color:#000">Register</button>
    </section>

    <section id="post-form" class="hidden">
        <div class="my-works">
            <strong>My Works (Compact)</strong>
            <div id="my-list"></div>
        </div>
        <h2 id="form-title">New Fragment</h2>
        <input type="hidden" id="edit-id">
        <input type="text" id="title" placeholder="Title">
        <input type="text" id="author" placeholder="Author">
        <textarea id="caption" placeholder="Caption" rows="2"></textarea>
        <textarea id="content" placeholder="Content" rows="8"></textarea>
        <button id="submit-btn" onclick="doPost()">Archive</button>
        <button onclick="cancelEdit()" class="text-btn">Cancel</button>
        <button onclick="doLogOut()" class="text-btn" style="float:right">Logout</button>
    </section>

    <hr>

    <div id="list">Loading fragments...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);

    let currentUser = null;

    async function init() {
        const { data: { user } } = await api.auth.getUser();
        currentUser = user;
        
        document.getElementById('auth-status').innerText = user ? `User: ${user.email}` : "Guest";
        document.getElementById('auth-form').classList.toggle('hidden', !!user);
        document.getElementById('post-form').classList.toggle('hidden', !user);
        
        if (user) getMyList();
        getList();
    }

    // 小説を投稿・更新
    async function doPost() {
        const id = document.getElementById('edit-id').value;
        const payload = {
            title: document.getElementById('title').value,
            author_name: document.getElementById('author').value,
            caption: document.getElementById('caption').value,
            content: document.getElementById('content').value,
            author_id: currentUser.id
        };

        let error;
        if (id) {
            ({ error } = await api.from('novels').update(payload).eq('id', id));
        } else {
            ({ error } = await api.from('novels').insert([payload]));
        }

        if (error) alert(error.message); else location.reload();
    }

    // 自分の作品一覧（コンパクト）
    async function getMyList() {
        const { data } = await api.from('novels').select('id, title').eq('author_id', currentUser.id);
        document.getElementById('my-list').innerHTML = data.map(n => `
            <div class="work-item">
                <span>${n.title}</span>
                <div>
                    <button class="text-btn" onclick="editNovel('${n.id}')">Edit</button>
                    <button class="text-btn" onclick="deleteNovel('${n.id}')" style="color:red">Del</button>
                </div>
            </div>
        `).join('') || 'No works yet.';
    }

    // 全体一覧
    async function getList() {
        const { data } = await api.from('novels').select('*').order('created_at', { ascending: false });
        document.getElementById('list').innerHTML = data.map(n => `
            <div class="novel-card">
                <h3>${n.title}</h3>
                <div class="author-info">
                    by ${n.author_name} 
                    <button class="text-btn" onclick="addFav('${n.author_id}')">お気に入り作者に追加</button>
                </div>
                <div class="caption">${n.caption || ''}</div>
                <button class="heart" onclick="addLike('${n.id}')">♥ いいね</button>
            </div>
        `).join('');
    }

    // 編集モード
    async function editNovel(id) {
        const { data } = await api.from('novels').select('*').eq('id', id).single();
        document.getElementById('edit-id').value = data.id;
        document.getElementById('title').value = data.title;
        document.getElementById('author').value = data.author_name;
        document.getElementById('caption').value = data.caption;
        document.getElementById('content').value = data.content;
        document.getElementById('form-title').innerText = "Edit Fragment";
        document.getElementById('submit-btn').innerText = "Update";
        window.scrollTo(0,0);
    }

    async function deleteNovel(id) { if(confirm('Delete?')) { await api.from('novels').delete().eq('id', id); location.reload(); } }
    function cancelEdit() { location.reload(); }

    // いいね機能（テーブルがある前提）
    async function addLike(novelId) {
        if (!currentUser) return alert("ログインが必要です");
        const { error } = await api.from('likes').insert([{ novel_id: novelId, user_id: currentUser.id }]);
        if (error) alert("すでにいいね済みか、エラーです"); else alert("♥ いいねしました");
    }

    // お気に入り作者（テーブルがある前提）
    async function addFav(authorId) {
        if (!currentUser) return alert("ログインが必要です");
        if (currentUser.id === authorId) return alert("自分はお気に入りできません");
        const { error } = await api.from('favorites').insert([{ author_id: authorId, user_id: currentUser.id }]);
        if (error) alert("登録済みです"); else alert("お気に入り作者に登録しました");
    }

    // 認証系
    async function doSignUp() { const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) alert(error.message); else alert("OK"); }
    async function doLogIn() { const { error } = await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) alert(error.message); else location.reload(); }
    async function doLogOut() { await api.auth.signOut(); location.reload(); }

    init();
</script>
</body>
</html>
