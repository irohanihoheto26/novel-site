<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&family=Dela+Gothic+One&family=Noto+Sans+JP:wght@300&display=swap" rel="stylesheet">
    
    <style>
    /* =======================================================
   MODERN THEME OVERRIDE (ä»Šé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ã¸ã®ä¸Šæ›¸ã)
   ======================================================= */

/* 1. å…¨ä½“ã®èƒŒæ™¯ã¨åŸºæœ¬è¨­å®š */
body {
    background-color: #f4f5f7; /* è–„ã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ã«ã—ã¦ç™½ã‚’ç›®ç«‹ãŸã›ã‚‹ */
    color: #333; /* çœŸã£é»’(#000)ã‚ˆã‚Šå°‘ã—æŸ”ã‚‰ã‹ã„é»’ã§è¦‹ã‚„ã™ã */
}

/* 2. ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆPCï¼‰ã‚’ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ã« */
aside {
    border-right: none;
    box-shadow: 2px 0 10px rgba(0,0,0,0.03); /* ç·šã§ã¯ãªãå½±ã§åŒºåˆ‡ã‚‹ */
}

/* 3. ãƒœã‚¿ãƒ³ã‚’ä»Šé¢¨ã«ï¼ˆè§’ä¸¸ãƒ»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ãƒ»ãƒ•ãƒ©ãƒƒãƒˆï¼‰ */
button, .btn-outline {
    border-radius: 50px; /* ä¸¸ã¿ã®ã‚ã‚‹ãƒœã‚¿ãƒ³ */
    font-weight: bold;
    letter-spacing: 0.05em;
    transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
button:active {
    transform: scale(0.98); /* æŠ¼ã—ãŸã¨ãã«å°‘ã—å‡¹ã‚€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
}
/* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã®èª¿æ•´ï¼ˆå°‘ã—é®®ã‚„ã‹ã«ï¼‰ */
button, aside button {
    background: #FFB300; /* é®®ã‚„ã‹ãªã‚ªãƒ¬ãƒ³ã‚¸ã‚¤ã‚¨ãƒ­ãƒ¼ */
    border: none;
}
/* ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
.btn-outline {
    background: #fff;
    border: 2px solid #eee;
    color: #555;
    box-shadow: none;
}
.btn-outline:hover {
    border-color: #FFB300;
    color: #FFB300;
}

/* 4. å…¥åŠ›æ¬„ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
input, textarea, select {
    background: #fff;
    border: 2px solid #eee;
    border-radius: 12px; /* å…¥åŠ›æ¬„ã‚‚ä¸¸ã */
    padding: 14px;
    transition: border-color 0.2s;
}
input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #FFB300; /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã« */
}

/* 5. ä½œå“ãƒªã‚¹ãƒˆã‚’ã€Œã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã«å¤‰æ›´ */
.novel-row {
    background: #fff;
    border: none;
    border-radius: 16px; /* ã‚«ãƒ¼ãƒ‰ã®è§’ä¸¸ */
    padding: 20px;
    margin-bottom: 20px; /* ã‚«ãƒ¼ãƒ‰åŒå£«ã®é–“éš” */
    box-shadow: 0 4px 12px rgba(0,0,0,0.03); /* ãµã‚“ã‚ã‚Šã—ãŸå½± */
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æµ®ãä¸ŠãŒã‚‹æ¼”å‡º */
.novel-row:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.novel-title {
    font-size: 1.2em;
    text-decoration: none; /* ä¸‹ç·šã‚’æ¶ˆã™ */
    color: #222;
    display: block;
    margin-bottom: 5px;
}

/* ã‚¿ã‚°ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.tag-link {
    background: #f0f2f5;
    color: #666;
    padding: 4px 10px;
    border-radius: 20px; /* ã‚¿ã‚°ã‚’ã‚«ãƒ—ã‚»ãƒ«å‹ã« */
    font-size: 0.8em;
}
.tag-link:hover {
    background: #FFB300;
    color: #fff;
}

/* 6. ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.tab-bar {
    border-bottom: none;
    gap: 10px;
}
.tab-btn {
    padding: 8px 20px;
    border-radius: 30px;
    background: #fff;
    color: #888;
    border: 1px solid #eee;
    font-weight: normal;
}
.tab-btn.active {
    background: #333; /* é¸æŠä¸­ã¯é»’èƒŒæ™¯ */
    color: #fff;
    border-color: #333;
    border-bottom: 1px solid #333; /* å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ‰“ã¡æ¶ˆã— */
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* 7. èª­æ›¸ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
#reader-overlay .overlay-content {
    max-width: 800px;
    background: #fff;
    /* æœ¬æ–‡ä»¥å¤–ã‚’è–„ãã‚°ãƒ¬ãƒ¼ã«ã—ã¦ç´™é¢ã‚’éš›ç«‹ãŸã›ã‚‹ */
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
    min-height: 100vh; 
    margin: 0 auto;
    padding: 60px 40px;
}
.sticky-close {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px); /* ã™ã‚Šã‚¬ãƒ©ã‚¹åŠ¹æœ */
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* 8. ã‚¹ãƒãƒ›è¡¨ç¤ºã®æœ€é©åŒ– */
@media screen and (max-width: 800px) {
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼é¢¨ã« */
    aside {
        padding: 15px 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        border-bottom: none;
    }
    aside h1 {
        font-size: 1.5em;
        margin-bottom: 0;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ã®ä½™ç™½èª¿æ•´ */
    main {
        padding: 20px 15px;
    }
    .novel-row {
        padding: 15px;
        border-radius: 12px;
    }
    
    /* æ¤œç´¢çª“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .search-box-side {
        margin-top: 15px;
        background-color: #f9f9f9;
        border: none;
    }
}
    </style>

    <style id="user-custom-style"></style>
    <style id="reader-custom-style"></style>
</head>

<body>

    <aside>
        <h1 onclick="location.reload()">Fragment</h1>
        <p style="font-family: 'Dela Gothic One', sans-serif; font-size: 1.8em; letter-spacing: 0.2em; color: #fcaf17; margin-top:-25px; margin-bottom: 30px; white-space: nowrap; display: inline-block; transform: scaleX(0.6); transform-origin: left center;">WEBå°èª¬æŠ•ç¨¿ã‚µã‚¤ãƒˆ</p>
        
        <span class="rule-link" onclick="openRules()">ãƒ«ãƒ¼ãƒ«ï¼ˆå¿…èª­ï¼‰</span>
        <span class="rule-link" onclick="openAboutPage()" style="display: block; margin-top: -5px;">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</span>    
        
        <input type="text" style="display:none" aria-hidden="true">
        <input type="search" id="search-input" class="search-box-side" placeholder="æ¤œç´¢..." oninput="getList()" autocomplete="off" name="novel-search-field">
        
        <div id="logged-in-nav" class="hidden">
            <button onclick="openEditor()">æ–°è¦æŠ•ç¨¿</button>
            <button class="btn-outline" onclick="doLogOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <div id="guest-nav">
            <button onclick="toggleAuthForm()">ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²</button>
        </div>
    </aside>

    <main>
        <section id="auth-form" class="hidden" style="border:2px solid #000; padding:20px; margin-bottom:40px;">
            <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button onclick="doLogIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="doSignUp()" class="btn-outline">æ–°è¦ç™»éŒ²</button>
        </section>

        <div id="user-page" class="hidden">
            <div class="section-header">
                <h2 style="margin: 0;">åŸ·ç­†ç®¡ç†</h2>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px;">
                    <span class="settings-link" id="view-my-page-link" style="color: #fcaf17;">[ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª]</span>
                    <span class="settings-link" onclick="toggleSettings()">[è¨­å®š]</span>
                </div>
                <button onclick="deleteAccount()" style="width: auto; background: none; border: none; color: #ff4d4d; text-decoration: underline; cursor: pointer; font-size: 0.65em; white-space: nowrap; padding: 0; margin: 0;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button>
            </div>
            
            <div id="my-profile-display" style="margin: 10px 0 20px 0;">
                <span id="display-current-name" style="font-size: 1em; font-weight: bold;">èª­ã¿è¾¼ã¿ä¸­...</span>
                <span style="font-size: 0.8em; color: #888;"> ã•ã‚“ã¨ã—ã¦æ´»å‹•ä¸­</span>
            </div>
            
            <div id="profile-edit-area" class="profile-edit-area">
                <input type="text" id="prof-name" placeholder="ä½œè€…å">
                <textarea id="prof-bio" placeholder="è‡ªå·±ç´¹ä»‹" rows="3"></textarea>
                
                <h3 style="font-size: 0.9em; margin-bottom: 10px;">ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (HTML/CSS)</h3>
                <span style="color: red; font-size: 0.75em; font-weight: bold; margin-left: 5px;">â€»ä»¥ä¸‹ã®æ¬„ã¯ã€CSSç­‰ã®çŸ¥è­˜ãŒã‚ã‚‹æ–¹ã®ã¿ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</span>
                <button type="button" onclick="resetToTemplate()" style="font-size: 0.8em; margin-bottom: 5px;">åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã™</button>
                <textarea id="prof-css" style="width:100%; height:150px;"></textarea>

                <div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px;">
                    <h3 style="font-size: 0.9em; margin-bottom: 10px;">æ–‡ç« ç”»é¢ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (CSS)</h3>
                    <p style="font-size: 0.75em; color: #666;">èª­æ›¸ç”»é¢ã®è¦‹ãŸç›®ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</p>
                    <button type="button" onclick="resetReaderDesign()" style="font-size: 0.8em; margin-bottom: 5px;">åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã™</button>
                    <textarea id="reader-custom-input" style="width:100%; height:150px;" placeholder="<style> ã“ã“ã«æ–‡ç« ç”»é¢ç”¨ã®CSSã‚’æ›¸ã </style>"></textarea>
                </div>
                <button onclick="saveProfile()">æ›´æ–°</button>
            </div>

            <div id="notification-banner" class="hidden" style="background: #fff9f0; border: 1px solid #ffebcc; padding: 15px; margin-bottom: 20px; border-radius: 12px; position: relative; min-height: 50px;">
                <button onclick="clearNotifications()" style="position: absolute; top: 10px; right: 10px; background: #fcaf17; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; width: auto; line-height: 1.2;">OK</button>
                <div id="notification-list" style="color: #a67c33; font-size: 0.9em; line-height: 1.8; padding-right: 60px;"></div>
            </div>
            
            <div id="user-stats-area" style="display: flex; gap: 20px; margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                <div><strong>åˆè¨ˆæ–‡å­—æ•°:</strong> <span id="total-char-count">0</span> å­—</div>
                <div><strong>åˆè¨ˆã„ã„ã­:</strong> <span id="total-likes">0</span></div>
            </div>
            
            <h3>æŠ•ç¨¿ã—ãŸä½œå“</h3>
            <div id="my-works-list">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        
        <div id="library-section-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
            <h2 style="margin: 0;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <select id="sort-order" onchange="getList()" style="padding: 2px 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.85em;">
                    <option value="created_at">æœ€æ–°é †</option>
                    <option value="likes">ã„ã„ã­é †</option>
                    <option value="char_count">æ–‡å­—æ•°é †</option>
                </select>
                <label style="font-size: 0.8em; color: #666; display: flex; align-items: center; gap: 3px; cursor: pointer; user-select: none; white-space: nowrap;">
                    <input type="checkbox" id="exclude-r18" onchange="getList()" style="cursor: pointer; margin: 0;"> R18ã‚’é™¤ã
                </label>
            </div>
            <span id="search-result-count" style="font-size: 0.8em; color: #666;"></span>
        </div>
        
        <div class="tab-bar">
            <button id="tab-all" class="tab-btn active" onclick="switchTab('all')">ã™ã¹ã¦</button>
            <button id="tab-follow" class="tab-btn" onclick="switchTab('follow')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
            <button id="tab-bookmark" class="tab-btn" onclick="switchTab('bookmark')">ãŠæ°—ã«å…¥ã‚Š</button>
        </div>
        <div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </main>

    <div id="reader-overlay">
        <div class="overlay-content">
            <div class="sticky-close">
                <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 0 15px;">
                    <button class="close-btn-style" onclick="closeReader()" style="width:auto; margin:0;">â† æˆ»ã‚‹</button>
                    <div id="name-changer-group" class="hidden" style="margin-top: 10px; display: none; gap: 5px; align-items: center; justify-content: center;">
                        <input type="text" id="user-custom-name" placeholder="ã‚ãªãŸã®åå‰" style="width: 120px; padding: 5px 10px; border-radius: 20px; border: 1px solid #ccc; font-size: 0.8em; margin-bottom: 0;">
                        <button onclick="applyNameChange()" style="width: auto; padding: 5px 15px; border-radius: 20px; background: #fcaf17; font-size: 0.8em; margin-bottom: 0;">å¤‰æ›</button>
                    </div>
                </div>
            </div>
            
            <h2 id="read-title"></h2>
            <div id="read-author" style="text-align: right; font-weight: bold;"></div>
            <div id="read-body" style="white-space: pre-wrap; line-height: 2.2; margin: 40px 0;"></div>
            
            <div id="reader-interactive-zone" style="border-top: 1px solid #000; padding-top: 20px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                    <div class="interactive-controls" style="display: flex; gap: 10px; align-items: center;">
                        <button id="bookmark-btn" onclick="toggleBookmark()" style="width:auto; padding: 10px 20px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                            <span id="bookmark-icon">â˜†</span> <span id="bookmark-text"></span>
                        </button>
                        <button id="like-btn" onclick="toggleLike()" style="width:auto; padding: 10px 30px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                            â™¥ <span id="read-like-text"></span> <span id="read-like-count">0</span>
                        </button>
                    </div>
                    <span id="author-link-zone" style="font-size: 0.9em; color: #666;"></span>
                </div>
                
                <div style="text-align: left;">
                    <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                    <div id="comment-list"></div>
                    <div id="comment-form-area" class="hidden" style="margin-top: 20px;">
                        <textarea id="comment-input" placeholder="æ„Ÿæƒ³ã‚’æ›¸ã..." rows="3" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 8px;"></textarea>
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px; flex-wrap: nowrap;">
                            <button onclick="postComment()" class="btn-outline" style="width:auto; margin:0; flex-shrink: 0;">ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡</button>
                            <label style="font-size: 0.85em; color: #666; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; user-select: none;">
                                <input type="checkbox" id="comment-is-private" style="cursor: pointer; margin: 0;"> 
                                <span>ä½œè€…ã ã‘ã«å…¬é–‹</span>
                            </label>
                        </div>
                    </div>
                    <div id="comment-guest-msg" class="hidden" style="margin-top: 20px; padding: 20px; background: #f9f9f9; text-align: center;">
                        <p>ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editor-overlay">
        <div class="overlay-content">
            <h2>æ–°è¦æŠ•ç¨¿</h2>
            <input type="text" id="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
            <input type="text" id="tags-input" placeholder="ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)">
            <textarea id="caption-input" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚ã‚‰ã™ã˜ç­‰ï¼‰" rows="3"></textarea>
            <div class="checkbox-group">
                <label><span class="switch"><input type="checkbox" id="r18-check"><span class="slider"></span></span>R-18</label>
                <label><span class="switch"><input type="checkbox" id="private-check"><span class="slider"></span></span>éå…¬é–‹(ä¸‹æ›¸ã)</label>
                <label><span class="switch"><input type="checkbox" id="name-convert-check"><span class="slider"></span></span>åå‰å¤‰æ›æ©Ÿèƒ½ã‚’ä½¿ã†</label>
            </div>
            <div id="default-name-area" class="hidden" style="margin-top: 10px;">
                <input type="text" id="default-name-input" placeholder="å¤‰æ›å‰ã®åå‰ï¼ˆä¾‹ï¼šé››å­ï¼‰" style="width: 100%; max-width: 300px;">
            </div>
            <textarea id="content-input" rows="20" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
            <div id="word-count-display">æ–‡å­—æ•°: <span id="current-count">0</span></div>
            <button onclick="doPost()">å…¬é–‹ï¼ä¿å­˜ã™ã‚‹</button>
            <button onclick="closeEditor()" class="btn-outline">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="author-page-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:3000; overflow-y:auto;">
        <div class="overlay-content" style="padding: 20px;">
            <button id="author-back-btn" class="btn-outline" onclick="closeAuthorPage()" style="width:auto; margin:0;">â† æˆ»ã‚‹</button>
            <div id="author-profile-header">
                <h1 id="author-page-name" style="font-family: 'Yu Gothic', 'YuGothic', sans-serif; font-weight: bold;"></h1>
                <div id="author-page-bio"></div>
            </div>
            <div id="author-page-works" style="margin-top:20px;"></div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ==========================================
    // 1. CONFIGURATION & GLOBALS
    // ==========================================
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k, {
        auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true
        }
    });

    let currentUser = null, userProfile = null, currentTab = 'all', currentReadingId = null;
    let editingNovelId = null, allMyNovels = [], originalContent = "";
    let currentReplyId = null; 
    let lastScrollTop = 0; // For scroll event

    // åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (Reader)
    const defaultReaderTemplate = `<style>
    #reader-overlay { background-color: #ffffff; color: #333333; }
    #read-body { max-width: 700px; margin: 0 auto; font-size: 1.1em; line-height: 2; }
    </style>`;

    // åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (Author Page)
    const defaultAuthorTemplate = `/* ã€ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘ã“ã“ã‚’è‡ªç”±ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ */
    <h1 class="default-title">ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ«</h1>
    <div class="default-bio">ã“ã“ã«è‡ªå·±ç´¹ä»‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <div id="custom-works-area"></div>
    <style>
    #author-page-name { display: none; }
    .default-title { font-family: 'Yu Gothic', 'YuGothic', sans-serif; font-weight: bold; font-size: 1.8em; margin: 10px 0; color: #333; }
    .default-bio { font-size: 1em; color: #666; margin-bottom: 30px; line-height: 1.6; }
    .novel-row { padding: 15px 0; border-bottom: 1px solid #eee; }
    .novel-title { font-size: 1.1em; color: #333 !important; text-decoration: none; font-weight: bold; }
    .count-badge { font-size: 0.8em; color: #999; margin-left: 10px; }
    </style>`;

    // ==========================================
    // 2. INITIALIZATION
    // ==========================================
    async function init() {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
        const { data: { session } } = await api.auth.getSession();
        currentUser = session?.user || null;

        // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®UIã‚»ãƒƒãƒˆ
        if (currentUser) {
            document.getElementById('logged-in-nav').classList.remove('hidden');
            document.getElementById('guest-nav').classList.add('hidden');
            document.getElementById('user-page').classList.remove('hidden');
            await loadProfile();
            await loadUserContent();
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æœªè¨­å®šæ™‚ã®å¼·åˆ¶
        if (!userProfile || !userProfile.display_name || userProfile.display_name === "åç„¡ã—") {
            if(currentUser) forceProfileSetup();
        }
        
        // ä½œå“ãƒªã‚¹ãƒˆå–å¾—
        await getList();

        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆåˆæœŸåŒ–
        const contentInput = document.getElementById('content-input');
        if (contentInput) {
            contentInput.addEventListener('input', (e) => {
                const count = e.target.value.length;
                document.getElementById('current-count').innerText = count.toLocaleString();
            });
        }
    }

    // ==========================================
    // 3. AUTHENTICATION
    // ==========================================
    function toggleAuthForm() { 
        document.getElementById('auth-form').classList.toggle('hidden'); 
    }

    async function doLogIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await api.auth.signInWithPassword({ email, password });
        
        if (error) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
        } else {
            setTimeout(() => {
                window.location.replace(window.location.pathname);
            }, 500);
        }
    }    

    async function doSignUp() { 
        const { error } = await api.auth.signUp({ 
            email: document.getElementById('email').value, 
            password: document.getElementById('password').value 
        }); 
        if(error) alert(error.message); else alert("ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); 
    }    

    async function doLogOut() {
        await api.auth.signOut();
        window.localStorage.clear();
        window.sessionStorage.clear();
        window.location.replace(window.location.pathname);
    }
    
    async function deleteAccount() {
        if (!confirm("æœ¬å½“ã«é€€ä¼šã—ã¾ã™ã‹ï¼Ÿ\næŠ•ç¨¿ã—ãŸã™ã¹ã¦ã®ä½œå“ã€ã‚³ãƒ¡ãƒ³ãƒˆã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå®Œå…¨ã«æ¶ˆå»ã•ã‚Œã¾ã™ã€‚")) return;
        const confirmName = prompt("é€€ä¼šã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ã‚ãªãŸã®ä½œè€…åï¼ˆã¾ãŸã¯ã€Œé€€ä¼šã€ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        if (!confirmName) return;

        try {
            await api.from('novels').delete().eq('author_id', currentUser.id);
            await api.from('profiles').delete().eq('id', currentUser.id);
            alert("é€€ä¼šå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚");
            await doLogOut();
        } catch (err) {
            console.error("é€€ä¼šã‚¨ãƒ©ãƒ¼:", err);
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        }
    }

    // ==========================================
    // 4. USER PROFILE & SETTINGS
    // ==========================================
    async function loadProfile() {
        const { data, error } = await api.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
        if (error) { console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", error); return; }
        
        userProfile = data;
        if (data) {
            const name = data.display_name || "åç„¡ã—";
            if (document.getElementById('prof-name')) document.getElementById('prof-name').value = name;
            if (document.getElementById('prof-bio')) document.getElementById('prof-bio').value = data.bio || "";
            
            const cssInput = document.getElementById('prof-css');
            if (cssInput) cssInput.value = data.custom_css || defaultAuthorTemplate;

            const readerInput = document.getElementById('reader-custom-input');
            if (readerInput) readerInput.value = data.reader_custom_code || defaultReaderTemplate;

            const displayEl = document.getElementById('display-current-name');
            if (displayEl) displayEl.innerText = name;

            const viewMyPageBtn = document.getElementById('view-my-page-link');
            if (viewMyPageBtn) viewMyPageBtn.onclick = () => openAuthorPage(currentUser.id);
        }
    }    

    async function saveProfile() {
        const name = document.getElementById('prof-name').value.trim();
        if (!name) return alert("ä½œè€…åã¯å¿…é ˆã§ã™ï¼");

        const updates = {
            id: currentUser.id,
            display_name: name,
            bio: document.getElementById('prof-bio').value,
            custom_css: document.getElementById('prof-css').value,
            reader_custom_code: document.getElementById('reader-custom-input').value,
            updated_at: new Date()
        };

        const { error } = await api.from('profiles').upsert(updates);
        if (error) alert("ã‚¨ãƒ©ãƒ¼: " + error.message);
        else { alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼"); location.reload(); }
    }

    function toggleSettings() { 
        const s = document.getElementById('profile-edit-area'); 
        s.style.display = s.style.display==='block'?'none':'block'; 
    }

    function forceProfileSetup() {
        const settingsArea = document.getElementById('profile-edit-area');
        settingsArea.style.display = 'block';
        const header = document.querySelector('#user-page h2');
        header.innerHTML = 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ <span style="font-size:0.5em; color:red;">(å¿…é ˆ)</span>';
        const nameInput = document.getElementById('prof-name');
        nameInput.style.border = "2px solid red";
        nameInput.placeholder = "ã€å¿…é ˆã€‘ä½œè€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        const postBtn = document.querySelector('#logged-in-nav button');
        if(postBtn) postBtn.disabled = true;
    }

    function resetToTemplate() {
        if (confirm("å…¥åŠ›ã—ãŸå†…å®¹ã‚’æ¶ˆã—ã¦åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
            const target = document.getElementById('prof-css');
            if (target) {
                target.value = defaultAuthorTemplate;
                alert("ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åæ˜ ã—ã¾ã—ãŸã€‚");
            }
        }
    }

    async function openAuthorPage(authorId) {
        const overlay = document.getElementById('author-page-overlay');
        const worksEl = document.getElementById('author-page-works');
        const nameEl = document.getElementById('author-page-name');
        const bioEl = document.getElementById('author-page-bio');
        const styleEl = document.getElementById('user-custom-style');

        if (!overlay || !worksEl) return;

        const { data: prof, error } = await api.from('profiles').select('*').eq('id', authorId).maybeSingle();
        if (error || !prof) return;

        const fullCode = prof.custom_css || "";
        const cssMatch = fullCode.match(/<style>([\s\S]*?)<\/style>/);
        const cssPart = cssMatch ? cssMatch[1] : fullCode;
        const htmlPart = fullCode.replace(/<style>[\s\S]*?<\/style>/, "");

        if (styleEl) styleEl.innerHTML = cssPart; 
        bioEl.innerHTML = htmlPart || prof.bio || ""; 
        nameEl.innerText = prof.display_name;
        worksEl.innerHTML = "ä½œå“ã‚’èª­ã¿è¾¼ã¿ä¸­...";
        overlay.style.display = 'block';
        closeReader();

        const { data: novels } = await api.from('novels').select('*').eq('author_id', authorId).eq('is_private', false).order('created_at', { ascending: false });
        const customArea = document.getElementById('custom-works-area');
        const targetEl = customArea || worksEl; 

        targetEl.innerHTML = (novels || []).map(n => {
            const r18Badge = n.is_r18 ? `<span class="r18-badge">R18</span>` : "";
            const tagsHtml = (n.tags && n.tags.length > 0) 
                ? n.tags.filter(t => t.trim() !== "").map(t => `<span class="tag-link" onclick="setSearchTag('${t}'); document.getElementById('author-page-overlay').style.display='none';">#${t}</span>`).join('')
                : "";
            return `
                <div class="novel-row">
                    <div class="novel-info">
                        <span class="novel-title" onclick="openReader('${n.id}')" style="cursor:pointer; position:relative; z-index:4000;">${n.title}</span>
                        <div style="display: inline-flex; align-items: center; gap: 8px; margin-left: 10px;">
                            <span class="count-badge">${(n.content || "").length.toLocaleString()}æ–‡å­—</span>
                            ${r18Badge}
                            <div class="author-page-tags" style="display: inline-flex; gap: 5px;">${tagsHtml}</div>
                        </div>
                    </div>
                </div>`;
        }).join('') || "å…¬é–‹ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“";
        
        if (customArea && customArea !== worksEl) worksEl.innerHTML = "";
    }

    function closeAuthorPage() {
        document.getElementById('author-page-overlay').style.display = 'none';
        document.getElementById('user-custom-style').innerHTML = "";
    }

    // ==========================================
    // 5. LIBRARY & LIST FUNCTIONS
    // ==========================================
    async function getList() {
        const listEl = document.getElementById('list');
        if (!listEl) return;

        try {
            let query = api.from('novels').select('*').eq('is_private', false);
            let { data: novels, error } = await query.order('created_at', { ascending: false });
            if (error) throw error;

            let baseNovels = novels || [];
            if (currentUser) {
                baseNovels = baseNovels.filter(n => n.author_id !== currentUser.id);
            }

            const r18Check = document.getElementById('exclude-r18');
            if (r18Check && r18Check.checked) {
                baseNovels = baseNovels.filter(n => !n.is_r18);
            }

            const sw = document.getElementById('search-input').value.toLowerCase();
            let filtered = baseNovels;
            
            // Tab Filtering
            if (currentTab === 'follow' && currentUser) {
                const { data: follows } = await api.from('follows').select('following_id').eq('follower_id', currentUser.id);
                const followingIds = (follows || []).map(f => f.following_id);
                filtered = filtered.filter(n => followingIds.includes(n.author_id));
            } else if (currentTab === 'bookmark' && currentUser) {
                const { data: myBms } = await api.from('bookmarks').select('novel_id').eq('user_id', currentUser.id);
                const bkmIds = (myBms || []).map(l => l.novel_id);
                filtered = filtered.filter(n => bkmIds.includes(n.id));
            }

            // Keyword Search
            if (sw) {
                filtered = filtered.filter(n => 
                    n.title.toLowerCase().includes(sw) || 
                    n.author_name.toLowerCase().includes(sw) ||
                    (n.tags && n.tags.some(t => t.toLowerCase().includes(sw)))
                );
            }

            const countEl = document.getElementById('search-result-count');
            if (countEl) countEl.innerText = sw ? `${filtered.length} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ` : "";

            // Initial Render (Placeholder)
            let sortType = document.getElementById('sort-order').value;
            renderFinalList(filtered);

            // Fetch Stats Async
            const promises = filtered.map(async (n) => {
                try {
                    const { data: p } = await api.from('profiles').select('display_name').eq('id', n.author_id).maybeSingle();
                    if (p?.display_name) {
                        const nameEl = document.getElementById(`author-name-${n.id}`);
                        if (nameEl) nameEl.innerText = p.display_name;
                    }
                    const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                    const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
                    n.like_count = lCount || 0;
                    n.comment_count = cCount || 0;
                    n.char_count = (n.content || "").length;

                    const likeEl = document.getElementById(`like-count-${n.id}`);
                    const commEl = document.getElementById(`comm-count-${n.id}`);
                    if (likeEl) likeEl.innerText = `â™¥ ${n.like_count}`;
                    if (commEl) commEl.innerText = `ğŸ’¬ ${n.comment_count}`;
                } catch (err) { console.warn("çµ±è¨ˆå–å¾—ã«å¤±æ•—:", n.title); }
            });

            await Promise.all(promises);

            // Sort after Stats
            sortType = document.getElementById('sort-order').value;
            if (sortType === 'likes' || sortType === 'char_count') {
                if (sortType === 'likes') filtered.sort((a, b) => (b.like_count || 0) - (a.like_count || 0));
                else filtered.sort((a, b) => (b.char_count || 0) - (a.char_count || 0));
                renderFinalList(filtered); 
            }
        } catch (e) {
            console.error("getListå…¨ä½“ã‚¨ãƒ©ãƒ¼:", e);
            listEl.innerHTML = `<div style="padding:20px; text-align:center;">ä½œå“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><button onclick="getList()">å†è©¦è¡Œ</button></div>`;
        }
    }

    function renderFinalList(sortedNovels) {
        const listEl = document.getElementById('list');
        if (!listEl) return;
        listEl.innerHTML = sortedNovels.map(n => {
            const r18Badge = n.is_r18 ? `<span class="r18-badge">R18</span>` : "";
            return `        
            <div class="novel-row">
                <div class="novel-info">
                    <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                    ${r18Badge}
                    <span onclick="openAuthorPage('${n.author_id}')" style="font-size:0.8em; color:#888; cursor:pointer; text-decoration:underline;">
                        / <span id="author-name-${n.id}">${n.author_name}</span>
                    </span>
                    <div style="margin-top:5px;">
                        ${(n.tags && n.tags.length > 0) ? n.tags.filter(t => t.trim() !== "").map(t => `<span class="tag-link" onclick="setSearchTag('${t}')">#${t}</span>`).join('') : ''}
                    </div>
                </div>
                <div class="novel-stats" id="stats-${n.id}">
                    <span class="count-badge">${(n.char_count || 0).toLocaleString()}æ–‡å­—</span>
                    <span class="stat-item" id="like-count-${n.id}">â™¥ ${n.like_count || 0}</span>
                    <span class="stat-item" id="comm-count-${n.id}">ğŸ’¬ ${n.comment_count || 0}</span>
                </div>
            </div>`;
        }).join('') || '<div style="padding:20px; text-align:center; color:#888;">ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t));
        getList();
    }

    function setSearchTag(tagName) {
        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = tagName;
        getList();
        const libraryHeader = document.getElementById('library-section-header');
        if (libraryHeader) libraryHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ç”¨ã¨ã—ã¦æ®‹å­˜ï¼ˆHTML onclickã«ã¯ãªã„ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½¿ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ç¶­æŒï¼‰
    function filterByAuthor(name) {
        document.getElementById('search-input').value = name;
        closeReader();
        switchTab('all');
        getList();
    }

    // ==========================================
    // 6. EDITOR FUNCTIONS
    // ==========================================
    async function loadUserContent() {
        if (!currentUser) return;
        let { data: novels } = await api.from('novels').select('*').eq('author_id', currentUser.id).order('created_at', {ascending: false});
        allMyNovels = novels || [];

        let totalChars = 0;
        let totalLikesSum = 0;
        const myWorksList = document.getElementById('my-works-list');
        const totalCharEl = document.getElementById('total-char-count');
        const totalLikesEl = document.getElementById('total-likes');

        if (myWorksList) {
            myWorksList.innerHTML = allMyNovels.map(n => {
                totalChars += (n.content || "").length; 
                const r18Badge = n.is_r18 ? `<span class="r18-badge">R18</span>` : "";
                const draftBadge = n.is_private ? `<span class="draft-badge">ä¸‹æ›¸ã</span>` : "";            
                return `
                <div class="novel-row">
                    <div class="novel-info">
                        <span class="novel-title" onclick="openReader('${n.id}')">${n.title}</span>
                        ${draftBadge} ${r18Badge}
                        <div id="my-stats-${n.id}" class="novel-stats">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div>
                        <span style="cursor:pointer; text-decoration:underline; font-size:0.8em;" onclick="openEditor('${n.id}')">[ç·¨é›†]</span>
                        <span class="btn-delete" onclick="deleteNovel('${n.id}', '${n.title}')">[å‰Šé™¤]</span>
                    </div>
                </div>`;
            }).join('') || "ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“";
        }

        if (totalCharEl) totalCharEl.innerText = totalChars.toLocaleString();

        allMyNovels.forEach(async (n) => {
            const { count: lCount } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            const { count: cCount } = await api.from('comments').select('*', { count: 'exact', head: true }).eq('novel_id', n.id);
            totalLikesSum += (lCount || 0);
            if (totalLikesEl) totalLikesEl.innerText = totalLikesSum.toLocaleString();
            const el = document.getElementById(`my-stats-${n.id}`);
            if(el) el.innerHTML = `<span class="stat-item">â™¥ ${lCount||0}</span> <span class="stat-item">ğŸ’¬ ${cCount||0}</span>`;
        });
    }

    function openEditor(id = null) {
        editingNovelId = id;
        if (id) {
            const n = allMyNovels.find(x => String(x.id) === String(id));
            if (!n) return;
            document.getElementById('title-input').value = n.title || "";
            document.getElementById('tags-input').value = (n.tags || []).join(', ');
            document.getElementById('caption-input').value = n.caption || "";
            document.getElementById('content-input').value = n.content || "";
            document.getElementById('r18-check').checked = !!n.is_r18;
            document.getElementById('private-check').checked = !!n.is_private;
            document.getElementById('current-count').innerText = (n.content || "").length.toLocaleString();
            document.querySelector('#editor-overlay h2').innerText = "ä½œå“ã‚’ç·¨é›†";

            if (n.default_name) {
                document.getElementById('name-convert-check').checked = true;
                document.getElementById('default-name-area').classList.remove('hidden');
                document.getElementById('default-name-input').value = n.default_name;
            } else {
                document.getElementById('name-convert-check').checked = false;
                document.getElementById('default-name-area').classList.add('hidden');
                document.getElementById('default-name-input').value = "";
            }
        } else {
            document.getElementById('title-input').value = "";
            document.getElementById('tags-input').value = "";
            document.getElementById('caption-input').value = "";
            document.getElementById('content-input').value = "";
            document.getElementById('r18-check').checked = false;
            document.getElementById('private-check').checked = false;
            document.getElementById('current-count').innerText = "0";
            document.querySelector('#editor-overlay h2').innerText = "æ–°è¦æŠ•ç¨¿";
        }
        document.getElementById('editor-overlay').style.display = 'block';
    }

    async function doPost() {
        if (!userProfile || !userProfile.display_name || userProfile.display_name === "åç„¡ã—") {
            alert("æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã§ã€Œä½œè€…åã€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
            forceProfileSetup(); 
            return; 
        }
        const isNameConvert = document.getElementById('name-convert-check').checked;
        const defaultName = isNameConvert ? document.getElementById('default-name-input').value.trim() : "";
        
        const payload = {
            title: document.getElementById('title-input').value,
            content: document.getElementById('content-input').value,
            caption: document.getElementById('caption-input').value,
            tags: document.getElementById('tags-input').value.split(',').map(t => t.trim()).filter(t => t),
            is_r18: document.getElementById('r18-check').checked,
            is_private: document.getElementById('private-check').checked,
            default_name: defaultName,
            author_id: currentUser.id,
            author_name: userProfile?.display_name || "åç„¡ã—"
        };
        const { error } = editingNovelId ? await api.from('novels').update(payload).eq('id', editingNovelId) : await api.from('novels').insert(payload);
        if(error) alert(error.message); else location.reload();
    }

    async function deleteNovel(id, title) {
        if (!confirm(`ä½œå“ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await api.from('novels').delete().eq('id', id);
        location.reload();
    }

    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }

    // ==========================================
    // 7. READER FUNCTIONS
    // ==========================================
    async function openReader(id) {
        currentReadingId = id;
        const bodyEl = document.getElementById('read-body');
        const titleEl = document.getElementById('read-title');
        const nameGroup = document.getElementById('name-changer-group');

        titleEl.style.textDecoration = "none";
        bodyEl.classList.remove('hanging-indent');
        bodyEl.classList.add('indent-text');
        
        const { data: n, error } = await api.from('novels').select('*').eq('id', id).single();
        if(error || !n) return alert("ä½œå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

        currentOpenedNovel = n;
        const { data: prof } = await api.from('profiles').select('display_name, reader_custom_code').eq('id', n.author_id).maybeSingle();
        const latestName = prof?.display_name || n.author_name;

        originalContent = n.content;
        titleEl.innerText = n.title;
        const readAuthorEl = document.getElementById('read-author');
        if (readAuthorEl) readAuthorEl.innerText = "";
        
        // åå‰å¤‰æ›è¡¨ç¤ºåˆ¶å¾¡
        if (nameGroup) {
            if (n.default_name && n.default_name.trim() !== "") {
                nameGroup.style.setProperty('display', 'flex', 'important');
                const savedName = localStorage.getItem('user-default-name');
                if (savedName) document.getElementById('user-custom-name').value = savedName;
            } else {
                nameGroup.style.setProperty('display', 'none', 'important');
            }
        }
        bodyEl.innerText = n.content; 

        document.getElementById('author-link-zone').innerHTML = `
            ä½œè€…: <strong onclick="openAuthorPage('${n.author_id}')" style="cursor:pointer; text-decoration:underline;">${latestName}</strong>
            ${(currentUser && n.author_id !== currentUser.id) ? `<button id="follow-btn" onclick="toggleFollow('${n.author_id}')" style="width:auto; padding:4px 12px; margin-left:10px; font-size:0.8em; border: 2px solid #fcaf17; background: #fff; color: #fcaf17; font-weight: bold; border-radius: 4px; cursor: pointer;">ãƒ•ã‚©ãƒ­ãƒ¼</button>` : ''}
        `;

        if (currentUser && n.author_id !== currentUser.id) checkFollowStatus(n.author_id);

        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-interactive-zone').classList.remove('hidden');

        // Dynamic Style Injection
        const oldStyle = document.getElementById('dynamic-reader-style');
        if (oldStyle) oldStyle.remove();

        const styleTag = document.createElement('style'); 
        styleTag.id = 'dynamic-reader-style';
        let customCode = (prof && prof.reader_custom_code) ? prof.reader_custom_code : defaultReaderTemplate;
        
        const resetHelper = `
            #reader-overlay, .overlay-content { background-color: transparent; }
            #reader-overlay .close-btn-style { background-color: unset; border: unset; box-shadow: unset; color: inherit; }
        `;
        styleTag.textContent = resetHelper + customCode.replace(/<style>|<\/style>/g, '');
        document.head.appendChild(styleTag);

        loadComments(id);
        loadLikeCount(id);
        checkBookmarkStatus(id);

        const form = document.getElementById('comment-form-area');
        const msg = document.getElementById('comment-guest-msg');
        if (currentUser) {
            form.classList.remove('hidden');
            msg.classList.add('hidden');
        } else {
            form.classList.add('hidden');
            msg.classList.remove('hidden');
        }
    }

    function closeReader() { 
        document.getElementById('reader-overlay').style.display = 'none'; 
        const oldStyle = document.getElementById('dynamic-reader-style');
        if (oldStyle) oldStyle.remove();
    }

    function applyNameChange() {
        const replacement = document.getElementById('user-custom-name').value;
        const target = currentOpenedNovel ? currentOpenedNovel.default_name : "";
        if (!target || !replacement) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const regex = new RegExp(target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        const bodyElem = document.getElementById('read-body');
        if (bodyElem && typeof originalContent !== 'undefined') {
            bodyElem.textContent = originalContent.replace(regex, replacement);
            localStorage.setItem('user-default-name', replacement);
        }
    }

    function resetReaderDesign() {
        if (confirm("æ–‡ç« ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
            const target = document.getElementById('reader-custom-input');
            if (target) {
                target.value = defaultReaderTemplate;
                alert("æ–‡ç« ç”»é¢ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åæ˜ ã—ã¾ã—ãŸã€‚");
            }
        }
    }

    function resetReaderUI() {
        const bodyEl = document.getElementById('read-body');
        const interactiveZone = document.getElementById('reader-interactive-zone');
        const nameChanger = document.getElementById('name-changer-group');
        const oldStyle = document.getElementById('dynamic-reader-style');
        
        if (oldStyle) oldStyle.remove();
        if (interactiveZone) interactiveZone.classList.add('hidden');
        if (nameChanger) { nameChanger.style.display = 'none'; nameChanger.classList.add('hidden'); }
        
        bodyEl.classList.remove('indent-text');
        bodyEl.classList.remove('hanging-indent');
        
        const titleEl = document.getElementById('read-title');
        if (titleEl) {
            titleEl.style.textDecoration = "none";
            titleEl.style.color = "";
        }
    }

    function openRules() {
        resetReaderUI(); 
        const bodyEl = document.getElementById('read-body');
        const titleEl = document.getElementById('read-title');
        const authorEl = document.getElementById('read-author');
        if (!titleEl || !bodyEl) return;

        titleEl.innerText = "ãƒ«ãƒ¼ãƒ«ï¼ˆå¿…èª­ï¼‰";
        titleEl.style.textDecoration = "underline";
        titleEl.style.textUnderlineOffset = "10px";
        if (authorEl) authorEl.innerText = "é‹å–¶";

        bodyEl.innerHTML = `
        <div class="rules-container" style="margin-top: -80px; line-height: 1.4; font-size: 0.95em;">
            <p style="margin: -40px 0 -10px 0;">å½“ã‚µã‚¤ãƒˆã¯å€‹äººã«ã‚ˆã‚‹äºŒæ¬¡å‰µä½œå°èª¬ã®å±•ç¤ºãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ç›®çš„ã¨ã—ãŸå°‚ç”¨ã‚µã‚¤ãƒˆã§ã™ã€‚</p>
            <div class="rules-list-box" style="margin: -20px 0 -20px 0; padding-left: 1.2em;">
                <div style="text-indent: -1.2em; margin-bottom: -20px;">ãƒ»æ¤œç´¢é¿ã‘ã®ãŸã‚ã€<span style="color: #ff4d4d; font-weight: bold;">åŸä½œåã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹ã“ã¨ã¯é¿ã‘ã¦</span>ãã ã•ã„ã€‚</div>
                <div style="text-indent: -1.2em; margin-bottom: -20px;">ãƒ»<span style="border-bottom: 1px solid #000; font-weight: bold;">å…¬åºè‰¯ä¿—ã«åã™ã‚‹å†…å®¹ã®æŠ•ç¨¿ã€ç„¡æ–­è»¢è¼‰ã€AIå­¦ç¿’åˆ©ç”¨ã¯å›ºãç¦æ­¢</span>ã„ãŸã—ã¾ã™ã€‚</div>
                <div style="text-indent: -1.2em; margin-bottom: -20px;">ãƒ»<span style="background-color: #ffff00; padding: 0 2px;">RæŒ‡å®šãŒå¿…è¦ãªå ´åˆã¯å¿…ãšè¨­å®š</span>ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</div>
            </div>
            <p style="margin: 10px 0 0 0;">ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦ã€å‰µä½œæ´»å‹•ã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ã€‚</p>
        </div>`;
        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-overlay').scrollTop = 0;
    }

    function openAboutPage() {
        resetReaderUI();
        const titleEl = document.getElementById('read-title'); 
        const bodyEl = document.getElementById('read-body');    
        if (!titleEl || !bodyEl) return;

        titleEl.innerText = "ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦";
        bodyEl.innerHTML = `
        <div class="about-section" style="margin-top: -110px;"> <h3 style="color: #fcaf17; font-size: 1.05em; border-left: 4px solid #fcaf17; padding-left: 10px; margin: 0 0 -15px 0;">ã‚µã‚¤ãƒˆã®ç‰¹è‰²</h3>
        <p style="font-size: 0.95em; margin: -20px 0 -10px 0; line-height: 1.2;">ã€€å½“ã‚µã‚¤ãƒˆã¯ã€ã‹ã¤ã¦éš†ç››ã‚’èª‡ã£ãŸã€Œå€‹äººã‚µã‚¤ãƒˆã€ã®ã‚ˆã†ãªè‡ªç”±ãªç©ºæ°—æ„Ÿã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚ä»–ã®æŠ•ç¨¿ã‚µã‚¤ãƒˆã§ã¯é›£ã—ã„ç´°ã‹ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¯èƒ½ã§ã€ã‚ãªãŸã®ä½œå“ã‚’ã‚ãªãŸã‚‰ã—ã„ç©ºé–“ã§å…¬é–‹ã§ãã‚‹ã®ãŒæœ€å¤§ã®ç‰¹å¾´ã§ã™ã€‚</p>
        <h3 style="color: #fcaf17; font-size: 1.05em; border-left: 4px solid #fcaf17; padding-left: 10px; margin: -50px 0 -15px 0;">å‰µè¨­çµŒç·¯</h3>
        <p style="font-size: 0.95em; margin: -20px 0 -10px 0; line-height: 1.2;">ã€€SNSã‚„å¤§æ‰‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ™®åŠã«ã‚ˆã‚Šã€è‡ªåˆ†ã ã‘ã®ã€ŒåŸã€ã§ã‚ã‚‹å€‹äººã‚µã‚¤ãƒˆã¯æ¿€æ¸›ã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€æµã‚Œã¦ã„ãã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§ã¯ãªãã€è‡ªåˆ†ã®ä½œå“ã‚’è‡ªåˆ†ã®å¥½ããªè‰²ã§é£¾ã‚Šã€é™ã‹ã«ç½®ã„ã¦ãŠã‘ã‚‹å ´æ‰€ãŒä»Šã“ãå¿…è¦ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚</p>
        <p style="font-size: 0.95em; margin: 0; line-height: 1.2;">ã€€æ•°è¡Œã®çŸ­ã„å‰µä½œæ–‡ã‹ã‚‰è¨­å®šè³‡æ–™ã€æ—¥è¨˜ä»£ã‚ã‚Šã®æ–‡ç« ã¾ã§ã€è‚©ã®åŠ›ã‚’æŠœã„ã¦è‡ªç”±ã«ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚</p>
        </div>`;
        document.getElementById('reader-overlay').style.display = 'block';
        document.getElementById('reader-overlay').scrollTop = 0;
    }

    // ==========================================
    // 8. INTERACTION (LIKE, BOOKMARK, COMMENT, FOLLOW)
    // ==========================================
    // --- LIKES ---
    async function toggleLike() {
        if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const { data: existingLike, error: checkError } = await api.from('likes').select('*').eq('novel_id', currentReadingId).eq('user_id', currentUser.id).maybeSingle();
        if (checkError) return;

        if (existingLike) {
            await api.from('likes').delete().eq('id', existingLike.id);
        } else {
            const { error: insertError } = await api.from('likes').insert({ novel_id: currentReadingId, user_id: currentUser.id });
            if (insertError) { alert("ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); return; }
            if (currentOpenedNovel && currentOpenedNovel.author_id !== currentUser.id) {
                await api.from('notifications').insert({ target_user_id: currentOpenedNovel.author_id, from_user_name: userProfile?.display_name || "åç„¡ã—ã•ã‚“", type: 'like', novel_title: currentOpenedNovel.title });
            }
        }
        loadLikeCount(currentReadingId);
    }

    async function loadLikeCount(id) {
        const countEl = document.getElementById('read-like-count');
        const likeBtn = document.getElementById('like-btn');
        if (!countEl || !likeBtn) return;
        
        const { count } = await api.from('likes').select('*', { count: 'exact', head: true }).eq('novel_id', id);
        countEl.innerText = count || 0;

        if (currentUser) {
            const { data } = await api.from('likes').select('*').eq('novel_id', id).eq('user_id', currentUser.id).maybeSingle();
            if (data) {
                likeBtn.style.background = "#ff4d4d"; likeBtn.style.color = "#fff"; document.getElementById('read-like-text').innerText = "";
            } else {
                likeBtn.style.background = "#fff"; likeBtn.style.color = "#000"; document.getElementById('read-like-text').innerText = "";
            }
        }
    }

    // --- BOOKMARKS ---
    async function checkBookmarkStatus(novelId) {
        if (!currentUser) return;
        const { data } = await api.from('bookmarks').select('id').eq('user_id', currentUser.id).eq('novel_id', novelId).maybeSingle();
        const icon = document.getElementById('bookmark-icon');
        const btn = document.getElementById('bookmark-btn');
        if (data) { icon.innerText = "â˜…"; btn.style.color = "#fcaf17"; btn.style.borderColor = "#fcaf17"; }
        else { icon.innerText = "â˜†"; btn.style.color = "#ccc"; btn.style.borderColor = "#ccc"; }
    }

    async function toggleBookmark() {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
        const { data } = await api.from('bookmarks').select('id').eq('user_id', currentUser.id).eq('novel_id', currentReadingId).maybeSingle();
        if (data) await api.from('bookmarks').delete().eq('id', data.id);
        else await api.from('bookmarks').insert({ user_id: currentUser.id, novel_id: currentReadingId });
        checkBookmarkStatus(currentReadingId);
    }

    // --- COMMENTS ---
    async function loadComments(id) {
        const { data: comments, error } = await api.from('comments').select('*').eq('novel_id', id).order('created_at', {ascending: true});
        if (error) { document.getElementById('comment-list').innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"; return; }

        const listEl = document.getElementById('comment-list');
        if (!comments || comments.length === 0) { listEl.innerHTML = "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"; return; }

        const userIds = [...new Set(comments.map(c => c.user_id))];
        const { data: profiles } = await api.from('profiles').select('id, display_name').in('id', userIds);
        const nameMap = {};
        profiles?.forEach(p => { nameMap[p.id] = p.display_name; });

        const parents = comments.filter(c => !c.parent_id);
        const replies = comments.filter(c => c.parent_id);

        listEl.innerHTML = parents.map(p => {
            const renderComment = (c, isReply) => {
                const isMine = currentUser && c.user_id === currentUser.id;
                const name = nameMap[c.user_id] || c.user_name || "åç„¡ã—";
                const privateMark = c.is_private ? '<span style="background:#e0e0e0; color:#000; font-size:0.75em; padding:2px 6px; border-radius:4px; margin-right:5px; font-weight:bold; border:1px solid #ccc;">éå…¬é–‹</span> ' : '';
                const nameLink = `<strong onclick="openAuthorPage('${c.user_id}')" style="cursor:pointer; text-decoration:underline;">${name}</strong>`;
                
                let manageBtns = '';
                if (isMine) {
                    const safeBody = c.body.replace(/`/g, '\\`');
                    manageBtns = `<span onclick="startEditComment('${c.id}', \`${safeBody}\` )" style="cursor:pointer; color:#007bff; font-size:0.8em; margin-left:12px; text-decoration: underline;">ç·¨é›†</span><span onclick="deleteComment('${c.id}')" style="cursor:pointer; color:#dc3545; font-size:0.8em; margin-left:8px; text-decoration: underline;">å‰Šé™¤</span>`;
                }
                const replyBtn = `<span onclick="prepareReply('${c.id}', '${name}')" style="cursor:pointer; color:#666; font-size:0.8em; margin-left:12px; text-decoration: underline;">è¿”ä¿¡ã™ã‚‹</span>`;
                const style = isReply ? 'margin-left: 30px; border-left: 2px solid #ddd; padding-left: 10px; margin-top: 8px;' : 'margin-bottom: 8px;';
                
                return `<div class="comment-item" style="${style}">${privateMark}${nameLink}: <span>${c.body}</span> ${replyBtn}${manageBtns}</div>`;
            };
            const parentHtml = renderComment(p, false);
            const replyHtml = replies.filter(r => String(r.parent_id) === String(p.id)).map(r => renderComment(r, true)).join('');
            return `<div style="margin-bottom: 15px;">${parentHtml}${replyHtml}</div>`;
        }).join('');
    }

    function prepareReply(parentId, targetName) {
        currentReplyId = parentId;
        const input = document.getElementById('comment-input');
        input.placeholder = `${targetName} ã•ã‚“ã¸ã®è¿”ä¿¡...`;
        input.focus();
    }

    async function startEditComment(commentId, oldBody) {
        const newBody = prompt("ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿ", oldBody);
        if (newBody === null || newBody.trim() === "" || newBody === oldBody) return;
        const { error } = await api.from('comments').update({ body: newBody.trim() }).eq('id', commentId);
        if (error) alert("ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message); else loadComments(currentReadingId);
    }

    async function postComment() {
        const b = document.getElementById('comment-input').value.trim();
        const isPrivate = document.getElementById('comment-is-private').checked;
        if(!b || !currentUser) return;

        const displayName = (userProfile && userProfile.display_name) ? userProfile.display_name : currentUser.email.split('@')[0];
        const { error } = await api.from('comments').insert({ 
            novel_id: currentReadingId, user_id: currentUser.id, user_name: displayName, body: b, is_private: isPrivate, parent_id: currentReplyId
        });

        if (error) { alert("ã‚³ãƒ¡ãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); } else {
            if (currentOpenedNovel && currentOpenedNovel.author_id !== currentUser.id) {
                await api.from('notifications').insert({ target_user_id: currentOpenedNovel.author_id, from_user_name: displayName, type: currentReplyId ? 'reply' : 'comment', novel_title: currentOpenedNovel.title, is_private: isPrivate });
            }
            if (currentReplyId) {
                const { data: parentC } = await api.from('comments').select('user_id').eq('id', currentReplyId).single();
                if (parentC && parentC.user_id !== currentUser.id && parentC.user_id !== currentOpenedNovel.author_id) {
                    await api.from('notifications').insert({ target_user_id: parentC.user_id, from_user_name: displayName, type: 'reply', novel_title: currentOpenedNovel.title, is_private: isPrivate });
                }
            }
            document.getElementById('comment-input').value = "";
            document.getElementById('comment-input').placeholder = "æ„Ÿæƒ³ã‚’æ›¸ã...";
            if (document.getElementById('comment-is-private')) document.getElementById('comment-is-private').checked = false;
            currentReplyId = null; 
            loadComments(currentReadingId);
        }
    }

    async function deleteComment(id) {
        if (!confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const { error } = await api.from('comments').delete().eq('id', id).eq('user_id', currentUser.id);
        if (error) alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); else loadComments(currentReadingId);
    }

    // --- FOLLOWS ---
    async function checkFollowStatus(authorId) {
        const { data } = await api.from('follows').select('*').eq('follower_id', currentUser.id).eq('following_id', authorId).maybeSingle();
        const btn = document.getElementById('follow-btn');
        if (!btn) return;
        if (data) { btn.innerText = "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­"; btn.style.background = "#fcaf17"; btn.style.color = "#fff"; } 
        else { btn.innerText = "ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹"; btn.style.background = "#fff"; btn.style.color = "#fcaf17"; }
    }

    async function toggleFollow(authorId) {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const { data: existing } = await api.from('follows').select('*').eq('follower_id', currentUser.id).eq('following_id', authorId).maybeSingle();
        if (existing) {
            await api.from('follows').delete().eq('id', existing.id);
        } else {
            const { error: insertError } = await api.from('follows').insert({ follower_id: currentUser.id, following_id: authorId });
            if (!insertError && authorId !== currentUser.id) {
                await api.from('notifications').insert({ target_user_id: authorId, from_user_name: userProfile?.display_name || "åç„¡ã—ã•ã‚“", type: 'follow', novel_title: "" });
            }
        }
        checkFollowStatus(authorId);
    }

    // ==========================================
    // 9. NOTIFICATIONS
    // ==========================================
    async function checkNotifications() {
        if (!currentUser) return;
        const { data, error } = await api.from('notifications').select('*').eq('target_user_id', currentUser.id).eq('is_read', false).order('created_at', { ascending: false });
        const banner = document.getElementById('notification-banner');
        const listArea = document.getElementById('notification-list');

        if (data && data.length > 0) {
            listArea.innerHTML = data.map(note => {
                let message = `<strong>${note.from_user_name}</strong> ã•ã‚“ãŒ `;
                if (note.type === 'reply') message += `ã€Œ${note.novel_title}ã€ã§è¿”ä¿¡ã—ã¾ã—ãŸï¼`;
                else if (note.type === 'comment') message += `ã€Œ${note.novel_title}ã€ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸï¼`;
                else if (note.type === 'like') message += `ã€Œ${note.novel_title}ã€ã«ã„ã„ã­ã—ã¾ã—ãŸï¼`;
                else if (note.type === 'follow') message += `ã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸï¼`;
                return `<div style="margin-bottom: 2px;">ãƒ» ${message}</div>`;
            }).join('');
            banner.classList.remove('hidden');
        } else {
            banner.classList.add('hidden');
        }
    }

    async function clearNotifications() {
        await api.from('notifications').update({ is_read: true }).eq('target_user_id', currentUser.id);
        document.getElementById('notification-banner').classList.add('hidden');
    }

    // ==========================================
    // 10. EVENT LISTENERS
    // ==========================================
    
    // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®ãƒªã‚¹ãƒŠãƒ¼
    document.addEventListener('DOMContentLoaded', async () => {
        // init()ã‚’å®Ÿè¡Œ
        init();
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ & é€šçŸ¥
        const { data: { session } } = await api.auth.getSession();
        if (session) {
            currentUser = session.user;
            await checkNotifications();
        }

        // åå‰å¤‰æ›æ©Ÿèƒ½ã®ã‚¹ã‚¤ãƒƒãƒãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'name-convert-check') {
                const area = document.getElementById('default-name-area');
                if (e.target.checked) {
                    area.classList.remove('hidden');
                } else {
                    area.classList.add('hidden');
                    document.getElementById('default-name-input').value = "";
                }
            }
        });
    });

    // ãƒšãƒ¼ã‚¸ãƒãƒƒã‚¯æ™‚ã®ãƒªãƒ­ãƒ¼ãƒ‰
    window.addEventListener('pageshow', (event) => {
        if (event.persisted) window.location.reload();
    });

    // Readerã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼åˆ¶å¾¡ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰
    const readerOverlay = document.getElementById('reader-overlay');
    readerOverlay.addEventListener('scroll', function() {
        const stickyEl = document.querySelector('.sticky-close');
        if (!stickyEl || window.innerWidth > 800) return;
        let st = readerOverlay.scrollTop;
        if (st > lastScrollTop && st > 100) stickyEl.classList.add('nav-hidden');
        else stickyEl.classList.remove('nav-hidden');
        lastScrollTop = st;
    }, { passive: true });

</script>   
</body>
</html>
