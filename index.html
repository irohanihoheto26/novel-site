<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Yu Gothic", "YuGothic", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #fff;
            color: #000;
            margin: 0;
            line-height: 1.7;
        }
        header {
            padding: 80px 20px;
            text-align: center;
            border-bottom: 1px solid #000;
            margin-bottom: 40px;
        }
        /* タイトルフォントを縦長・太字に */
        header h1 {
            margin: 0;
            font-family: 'Antonio', sans-serif;
            font-size: 4em;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-weight: 700;
        }
        .container { max-width: 700px; margin: 0 auto; padding: 0 20px 100px; }
        #auth-status { text-align: right; font-size: 0.8em; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        section { border: 1px solid #000; padding: 30px; margin-bottom: 40px; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #000; box-sizing: border-box; font-family: inherit; }
        button { background-color: #000; color: #fff; border: 1px solid #000; padding: 12px 25px; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #fff; color: #000; }
        .novel-card { padding: 30px 0; border-bottom: 1px solid #000; }
        .novel-card h3 { margin: 0 0 10px 0; font-size: 1.5em; }
        .caption { font-size: 0.9em; color: #444; margin-top: 10px; border-left: 2px solid #000; padding-left: 15px; }
    </style>
</head>
<body>

<header>
    <h1>Fragment Library</h1>
    <p>A collection of story fragments.</p>
</header>

<div class="container">
    <div id="auth-status">Checking connection...</div>

    <section id="auth-form">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doSignUp()">Register</button>
        <button onclick="doLogIn()">Login</button>
    </section>

    <section id="post-form" style="display:none">
        <input type="text" id="title" placeholder="Title">
        <input type="text" id="author" placeholder="Author">
        <textarea id="caption" placeholder="Caption" rows="3"></textarea>
        <textarea id="content" placeholder="Content" rows="12"></textarea>
        <button onclick="doPost()">Archive</button>
        <button onclick="doLogOut()">Logout</button>
    </section>

    <div id="list">Loading...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const u = 'https://fnobmngpstzolphexluc.supabase.co'.trim();
    const k = 'sb_publishable_wczOfUdvKuScZQJ0Lklx0w_D9XtJPqE'.trim();
    const api = window.supabase.createClient(u, k);

    async function check() {
        try {
            const { data: { user }, error } = await api.auth.getUser();
            if (error) throw error;
            document.getElementById('auth-form').style.display = user ? 'none' : 'block';
            document.getElementById('post-form').style.display = user ? 'block' : 'none';
            document.getElementById('auth-status').innerText = user ? 'Member: ' + user.email : 'Guest';
        } catch (e) {
            document.getElementById('auth-status').innerText = 'Connection Error';
            console.error(e);
        }
    }

    async function doSignUp() {
        const { error } = await api.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value });
        if (error) alert(error.message); else alert("Check your email or try logging in.");
    }

    async function doLogIn() {
        const { error } = await api.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value });
        if (error) alert("Login Failed: " + error.message); else location.reload();
    }

    async function doLogOut() { await api.auth.signOut(); location.reload(); }

    async function doPost() {
        const { data: { user } } = await api.auth.getUser();
        const { error } = await api.from('novels').insert([{
            title: document.getElementById('title').value,
            author_name: document.getElementById('author').value,
            caption: document.getElementById('caption').value,
            content: document.getElementById('content').value,
            author_id: user.id
        }]);
        if (error) alert("Archive Error: " + error.message); else location.reload();
    }

    async function getList() {
        const { data, error } = await api.from('novels').select('*').order('created_at', { ascending: false });
        if (error) { document.getElementById('list').innerText = "Error loading list."; return; }
        document.getElementById('list').innerHTML = data.map(n => `
            <div class="novel-card">
                <h3>${n.title}</h3>
                <div>by ${n.author_name}</div>
                <div class="caption">${n.caption || ''}</div>
            </div>
        `).join('');
    }

    check(); getList();
</script>
</body>
</html>
